# 1.数据仓库概念
数据仓库（Data Warehouse），是为企业制定决策，提供数据支持的。可以帮助企业，改进业务流程、提高产品质量等。

数据仓库的输入数据通常包括：**业务数据、用户行为数据和爬虫数据**等。本项目仅对业务数据进行统计。

业务数据：就是各行业在**处理事务过程中产生的数据**。比如用户在电商网站中登录、下单、支付等过程中，需要和网站后台数据库进行增删改查交互，产生的数据就是业务数据。业务数据通常存储在MySQL、Oracle等数据库中

> **数据仓库并不是数据的最终目的地，而是为数据最终目的地做好准备；这些准备包括对数据的****<font style="color:#DF2A3F;">备份、清洗、聚合、统计</font>****等**
>

# 2.项目需求及架构设计
本项目仅对业务数据进行处理

## 技术选型
主要考虑因素有：数据量大小，业务需求，行业内经验，技术成熟度，开发维护成本等等

离线数仓搭建所需的技术分类及相关框架如下：

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1724402760166-7a230c3b-8917-460b-bef4-814b2b1d0bc7.png)

其中标红的内容是常用框架

## 系统流程设计
![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707098692520-2e769c58-efae-4dd3-ad52-b8e9daba006f.png)

## 框架版本选型
![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707098715794-6a6222bb-ab12-4265-ba1d-a7e0a107798e.png)

注意：框架选型尽量不要选择最新的框架，选择最新框架半年前左右的稳定版

## 集群规模设计
![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707099530424-3cccba53-9b83-4a40-8929-1445131b3a18.png)

## 集群资源规划设计
在企业中通常会搭建一套**生产集群**和一套**测试集群**。生产集群运行生产任务，测试集群用于上线前代码编写和测试

### 生产集群
（1）参考腾讯云EMR官方推荐部署：

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707099588839-9371fece-cff7-436c-ba19-32a0220b0e40.png)

+ Master节点：**管理节点**，保证集群的调度正常进行；主要部署NameNode（HDFS）、ResourceManager（Yarn）、HMaster（HBase） 等进程；非 HA 模式下数量为1，HA （高可用）模式下数量为2
+ Core节点：为**计算及存储节点**，**HDFS 中的数据全部存储于 core 节点中**，因此为了保证数据安全，**扩容 core 节点后****<font style="color:#DF2A3F;">不允许缩容</font>**；主要部署 DataNode、NodeManager、RegionServer 等进程。非 HA 模式下数量≥2，HA 模式下数量≥3
+ Common 节点：为 HA 集群 Master 节点提供**<font style="color:#DF2A3F;">数据共享同步以及高可用容错服务</font>**；主要部署**分布式协调器组件**，如 ZooKeeper、JournalNode 等节点。非HA模式数量为0，HA 模式下数量≥3

（2）**消耗内存（如NameNode和ResourceManager）**的分开部署

（3）数据传输数据比较紧密的放在一起（Kafka、clickhouse）

（4）客户端尽量放在一到两台服务器上，方便外部访问

（5）有依赖关系的尽量放到同一台服务器（例如：Ds-worker和hive/spark）

| **Master** | **Master** | **core** | **core** | **core** | **common** | **common** | **common** |
| --- | --- | --- | --- | --- | --- | --- | --- |
| **nn** | nn | dn | dn | dn | JournalNode | JournalNode | JournalNode |
| **r****m** | rm | nm | nm | nm |  |  |  |
|  |  |  |  |  | zk | zk | zk |
| **hive** | hive | hive | hive | hive |  |  |  |
|  |  | kafka | kafka | kafka |  |  |  |
| **spark** | spark | spark | spark | spark |  |  |  |
| **datax** | datax | datax | datax | datax |  |  |  |
| **Ds****-master** | Ds-master | Ds-worker | Ds-worker | Ds-worker |  |  |  |
| **maxwell** |  |  |  |  |  |  |  |
| **sup****er****set** |  |  |  |  |  |  |  |
| **mysql** |  |  |  |  |  |  |  |
| **flume** | flume |  |  |  |  |  | |


### 测试集群
| **服务****名称** | **子****服务** | **服务器**<br/>**hadoop102** | **服务器**<br/>**hadoop103** | **服务器**<br/>**hadoop104** |
| --- | --- | --- | --- | --- |
| **HDFS** | NameNode | √ |  |  |
|  | DataNode | √ | √ | √ |
|  | SecondaryNameNode |  |  | √ |
| **Yarn** | NodeManager | √ | √ | √ |
|  | Resourcemanager |  | √ |  |
| **Zookeeper** | Zookeeper Server | √ | √ | √ |
| **F****lume****（采集****日志****）** | Flume | √ | √ |  |
| **Kafka** | Kafka | √ | √ | √ |
| **Flume**<br/>**（****消费****K****afka****日志****）** | Flume |  |  | √ |
| **Flume**<br/>**（****消费****K****afka****业务****）** | Flume |  |  | √ |
| **Hive** |  | √ | √ | √ |
| **My****SQL** | MySQL | √ |  |  |
| **DataX** |  | √ | √ | √ |
| **S****park** |  | √ | √ | √ |
| **DolphinScheduler** | ApiApplicationServer | √ |  |  |
|  | AlertServer | √ |  |  |
|  | MasterServer | √ |  |  |
|  | WorkerServer | √ | √ | √ |
|  | LoggerServer | √ | √ | √ |
| **S****uperset** | Superset | √ |  |  |
| **Maxwell** |  | √ |  |  |
| **服务****数总计** |  | **17** | **11** | **12** |


# 3.金融租赁业务
## 金融租赁业务简介
金融租赁（Financing lease），又称“融资租赁”、”设备租赁”、“完全支付租赁”，是指**在企业需要设备时，不是以现汇或向金融机构借款去购买，而是由租赁公司融资，把租赁来的设备或购入的设备租给承租人使用，承租人按照合同的规定，定期向租赁公司支付租金**，租赁期满后退租、续租或留购的一种融资方式

融资租赁属于国际租赁方式之一，实际上是租赁公司给予用户的一种**中长期信贷**，出租人支付了全部设备的价款，等于**对企业提供了100%的信贷**，具有较浓厚的金融色彩。**融资租赁被视为一项与设备有关的贷款业务**，适用于价值较高和技术较为先进的大型设备



## 金融租赁业务流程
1. 新增申请：客户发起融资租赁申请，提交·申请材料（用于评估客户的信用状况、还款能力和融资需求）
2. 风控审核：风控员（员工）对本次申请进行风险评估（信用评估、资产评估、还款能力分析、借款目的和用途等等）
    1. 风控未通过交由风控部门执行风控再审核
        1. 若仍未通过则拒绝申请，流程结束
        2. 通过则进入下一结点
    2. 风控通过进入下一结点
    3. 若客户取消，流程结束
3. 分配信审经办：信审经办是信贷金融业务中的一个角色，负责**具体执行信审工作**。信审更专注于对借款申请人的**信用状况和还款能力**进行评估
4. 信审经办：信审经办审核客户申请，生成信审报告
    1. 审核未通过：
        1. 若客户提交补充材料申请复议且复议申请通过，信审经办再次审核。
        2. 若客户提交补充材料申请复议且复议申请未通过，则审核拒绝，流程结束。
        3. 若客户不再申请复议，则审核拒绝，流程结束。
    2. 审核通过进入下一结点
    3. 若客户取消，流程结束
5. 生成业务反馈：客户申请交由业务经办，后者整理现有材料，生成业务反馈
6. 一级评审人/加签人：业务反馈被提交至一级评审人/加签人。一级评审人（也称为初审人）和加签人（也称为复审人）是负责进行贷款申请审核的角色
    1. 审核未通过：
        1. 若客户提交补充材料申请复议且复议申请通过，回到信审经办结点重新审核
        2. 若客户提交补充材料申请复议且复议申请未通过，则审核拒绝，流程结束
        3. 若客户不再申请复议，则审核拒绝，流程结束
    2. 审核通过进入下一结点
    3. 若客户取消，流程结束

> “加签人”是指对某项工作或文件的审核、确认或批准结果进行再次确认的人员。加签是一种常见的授权和审批机制，旨在增加决策的准确性和权威性；
>
> 一级评审人和加签人通常是经验丰富、熟悉贷款产品和风险控制的专业人员。他们的审核意见和决策对于贷款申请的最终批准与否具有重要影响。这两个角色的存在旨在确保贷款申请经过多个层面的审核和核实，提高贷款决策的准确性和可靠性
>

7. 二级评审人：二级评审人是比一级评审人的加签人更高一级的审核人员，在一级评审人的加签人审核通过后，负责进行更详细和深入的审核和评估
8. 项目评审会：项目评审会是为了对贷款申请中的项目进行**全面的评估和审核**，以决定是否批准贷款并制定相关的条件和要求。该评审会通常由公司内部的**高级管理层、风险管理团队、贷款官员**等组成
9. 总经理/分管总：总经理/分管总审核是信贷金融业务中的**高级审核环节**。它涉及公司的高级管理层，通常由总经理或负责信贷业务的高级职位（如分管总）担任审核者
10. 出具批复：审核团队或决策层根据信贷申请经过评估和审查后，做出最终的贷款批复决策并生成批复文件。批复文件包含了对贷款申请的决策结果和相应的条件
    1. 审核未通过
        1. 若客户提交补充材料申请复议且复议申请通过，回到总经理/分管总结点。
        2. 若客户提交补充材料申请复议且复议申请未通过，则审核拒绝，流程结束
        3. 若客户不再申请复议，则审核拒绝，流程结束。
    2. 审核通过：
        1. 若客户对批复文件中列出的额度或条件不满，申请复议
            1. 复议申请通过，回到一级评审人/加签人结点
            2. 复议申请未通过，意味着机构已做出了最终决策，客户可以选择接受批复结果，进入下一结点，或取消申请
        2. 接受批复结果，进入下一结点
    3. 若客户取消，流程结束
11. **新增授信**：在客户接受出具批复的授信额度后，该额度将被确认为新增的授信额度，作为客户可用的资金额度
12. 完成授信占用：客户在需要使用授信额度时，可以提出授信占用请求，机构会根据客户的需求释放相应的资金额度，使其可供客户使用
13. 完成合同制作
14. 签约
15. 起租



流程图如下：

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707117985498-44d6a6d5-6f7b-4415-a850-4ce3eca6747f.png)

# 4.金融系统表结构
**4.1 客户表（business_partner）**

| **字段名** | **字段说明** |
| --- | --- |
| **i****d** | 编号（主键） |
| **name** | 客户姓名 |
| **create_time** | 创建时间 |
| **update_time** | 更新时间 |


**4.2 合同表（contract）**

| **字段名** | **字段说明** |
| --- | --- |
| **id** | 编号（主键） |
| **execution_time** | 起租时间 |
| **signed_time** | 签约时间 |
| **status** | 合同状态：1.新建 2.已签约 3.已起租 4.已取消 |
| **credit_id** | 授信ID |
| **create_time** | 创建时间 |
| **update****_time** | 更新时间 |


**4.3 授信表（credit）**

| **字段名** | **字段说明** |
| --- | --- |
| **id** | 编号（主键） |
| **cancel_time** | 取消时间 |
| **contract_produce_time** | 合同制作时间 |
| **credit_amount** | 授信金额 |
| **credit_occupy_time** | 授信占用时间 |
| **status** | 授信状态：1.新建 2.已占用 3.已制作合同 4.已取消 |
| **contract_id** | 合同ID |
| **credit_facility_id** | 授信申请ID |
| **create_time** | 创建时间 |
| **update_time** | 更新时间 |


**4.4 授信申请表（credit_facility）**

| **字段名** | **字段说明** |
| --- | --- |
| **id** | 编号（主键） |
| **credit_amount** | 申请授信金额 |
| **lease_organization** | 业务方向 |
| **status** | 所处环节：1.新建 2.未达到风控 3.待分配 4.已分配信审经办 5.信审经办审核通过 6.信审经办审核复议 7.业务反馈已提交 8.一级评审通过 9.一级评审复议 10.二级评审通过 11.二级评审复议 12.项目评审会审核通过 13.项目评审会复议 14.总经理/分管总审核通过 15.总经理/分管总审核复议 16.出具批复审核通过 17.出具批复审核复议 18.不满批复金额 19.新增授信 20.拒绝 21.取消 |
| **business_partner_id** | 客户ID |
| **credit_id** | 授信ID |
| **industry_id** | 行业ID |
| **reply_id** | 批复ID |
| **salesman_id** | 业务经办ID |
| **create_time** | 创建时间 |
| **update_time** | 更新时间 |


**4.5 审核记录表（credit_facility_status）**

| **字段名** | **字段说明** |
| --- | --- |
| **id** | 编号（主键） |
| **action_taken** | 批复结果1.通过 2.未通过 |
| **status** | 所处环节：1.新建 2.未达到风控 3.待分配 4.已分配信审经办 5.信审经办审核通过 6.信审经办审核复议 7.业务反馈已提交 8.一级评审通过 9.一级评审复议 10.二级评审通过 11.二级评审复议 12.项目评审会审核通过 13.项目评审会复议 14.总经理/分管总审核通过 15.总经理/分管总审核复议 16.出具批复审核通过 17.出具批复审核复议 18.不满批复金额 19.新增授信 20.拒绝 21.取消 |
| **credit_facility_id** | 授信申请ID |
| **employee_id** | 相关责任人员工ID |
| **signatory_id** | 加签人 |
| **create_time** | 创建时间 |
| **update_time** | 更新时间 |


**4.6 部门表（department）**

| **字段名** | **字段说明** |
| --- | --- |
| **id** | 编号（主键） |
| **department_level** | 部门级别 |
| **department_name** | 部门名称 |
| **superior_department_id** | 上级部门ID |
| **create_time** | 创建时间 |
| **update****_time** | 更新时间 |


**4.7 员工表（employee）**

| **字段名** | **字段说明** |
| --- | --- |
| **id** | 编号（主键） |
| **name** | 员工姓名 |
| **type** | 员工类型（员工类型：1.业务经办 2.风控员 3.风控经理 4.信审经办 5.一级评审员 6.一级评审加签人 7.二级评审员 8.总经理/分管总） |
| **department_id** | 部门ID |
| **create_time** | 创建时间 |
| **update_time** | 更新时间 |


**4.8 行业表（industry）**

| **字段名** | **字段说明** |
| --- | --- |
| **id** | 编号（主键） |
| **industry_level** | 行业级别 |
| **industry_name** | 行业名称 |
| **superior_industry_id** | 上级行业ID |
| **create_time** | 创建时间 |
| **update****_time** | 更新时间 |


**4.9 批复表（reply）**

| **字段名** | **字段说明** |
| --- | --- |
| **id** | 编号（主键） |
| **credit_amount** | 批复授信金额 |
| **credit_facility_id** | 授信申请ID |
| **irr** | 还款利率 |
| **period** | 还款期数 |
| **create_time** | 创建时间 |
| **update_time** | 更新时间 |


# 5.环境准备
1. 创建虚拟机hadoop108、109、110
2. 编写集群分发脚本
3. 安装JDK，版本：1.8
    1. 上传安装包并解压
    2. 设置环境变量并source使其生效
    3. 分发JDK
    4. 分发环境变量配置文件并source使其生效（注意用sudo）
4. 创建查看所有进程的脚本jpsall
5. hadoop安装并配置集群
6. MySQL安装
7. 数据模拟脚本配置（从2024-05-01开始生成模拟数据）
    1. 数据模拟脚本执行：`java -jar mock-finance-1.3.0.jar`
    2. 集群日志生成脚本：`financial_mock.sh`
8. zookeeper安装
9. Kafka安装
    1. 主题命令行操作：`bin/kafka-topics.sh --bootstrap-server hadoop102:9092 --list`（查看所有的topic）
    2. 生产者命令行操作：`bin/kafka-console-producer.sh --bootstrap-server hadoop102:9092 --topic first`
    3. 消费者命令行操作：`bin/kafka-console-consumer.sh --bootstrap-server hadoop102:9092 --topic first`（消费数据）
10. flume安装
11. Maxwell安装
12. datax安装

# 6.数据同步策略
## 数据同步策略概述
数据的同步策略有全量同步和增量同步

全量同步，就是每天都将业务数据库中的全部数据同步一份到数据仓库，这是保证两侧数据同步的最简单的方式

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707183975504-b0b048ce-d9a1-4368-ad06-034cf89fa82a.png)

增量同步，就是每天只将业务数据中的新增及变化数据同步到数据仓库。采用每日增量同步的表，通常需要在首日先进行一次全量同步

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707183989588-339d2fe6-9fc3-407d-b977-b9edfa9c71c9.png)

## 数据同步策略选择
对两种策略进行对比

| **同步策略** | **优点** | **缺点** |
| --- | --- | --- |
| **全量同步** | 逻辑简单 | 在某些情况下效率较低。例如某张表数据量较大，但是每天数据的变化比例很低，若对其采用每日全量同步，则会重复同步和存储大量相同的数据。 |
| **增量同步** | 效率高，无需同步和存储重复数据 | 逻辑复杂，需要将每日的新增及变化数据同原来的数据进行整合，才能使用 |


根据上述对比，可以得出以下结论：

通常情况，**业务表数据量比较大，优先考虑增量，数据量比较小，优先考虑全量**；具体选择由数仓模型决定

业务表同步策略如下：

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707184066909-ad49d6c2-7f52-4623-b688-ee29a9208e81.png)

## 数据同步工具概述
数据同步工具种类繁多，大致可分为两类，一类是以DataX、Sqoop为代表的**基于Select查询**的离线、批量同步工具，另一类是以Maxwell、Canal为代表的基于**数据库数据变更日志**（例如MySQL的binlog，其会实时记录所有的insert、update以及delete操作）的实时流式同步工具

全量同步通常使用DataX、Sqoop等基于查询的离线同步工具。而增量同步既可以使用DataX、Sqoop等工具，也可使用Maxwell、Canal等工具，下面对增量同步不同方案进行简要对比：

| **增量同步方案** | **DataX****/Sqoop** | **Maxwell/****C****anal** |
| --- | --- | --- |
| **对数据库的要求** | 原理是基于查询，故若想通过select查询获取新增及变化数据，就要求数据表中存在create_time、update_time等字段，然后根据这些字段获取变更数据。 | 要求数据库记录变更操作，例如MySQL需开启binlog。 |
| **数据的中间状态** | 由于是离线批量同步，故若一条数据在一天中变化多次，该方案**<font style="background-color:#FBDE28;">只能获取最后一个状态，中间状态无法获取</font>** | 由于是实时获取所有的数据变更操作，所以**<font style="background-color:#FBDE28;">可以获取变更数据的所有中间状态</font>** |


因此建议全量同步采用DataX，增量同步采用Maxwell

## 全量数据同步
首先安装datax并配置环境

### 配置文件生成器
![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707185659001-95abc356-e707-48c1-aa6e-2acaf2ad06ac.png)

修改configuration.properties配置：

```shell
mysql.username=root
mysql.password=hadoop
mysql.host=hadoop108
mysql.port=3306
mysql.database.import=financial_lease
mysql.database.export=
mysql.tables.import=business_partner,department,employee,industry
mysql.tables.export=
is.seperated.tables=0
hdfs.uri=hdfs://hadoop108:8020
import_out_dir=/opt/module/datax/job/financial_lease/import
export_out_dir=
```

运行jar包即可生成配置文件：`java -jar datax-config-generator-1.0-SNAPSHOT-jar-with-dependencies.jar`

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707185729879-84487a6e-0c52-416b-bb1c-085dad7830d0.png)

### 数据同步脚本
创建脚本`financial_mysql_to_hdfs_full.sh`，写入以下内容

```bash
#!/bin/bash
DATAX_HOME=/opt/module/datax
DATAX_DATA=/opt/module/datax/job/financial_lease/import

#如果传参 使用传参的日期 如果不传参数 使用默认值昨天
if [[ -n "$2" ]]; then
  #statements
  do_date=$2
else
  do_date=${date -d "-1 day" +%F}
fi


handle_targetdir(){
  hadoop fs -rm -r $1 >/dev/null 2>&1
  hadoop fs -mkdir -p $1
}

#数据同步
import_data(){
  target_dir=$1
  datax_config=$2
  handle_targetdir $target_dir
  echo "导入表格数据$datax_config"
  python ${DATAX_HOME}/bin/datax.py -p"-Dtargetdir=$target_dir" $datax_config >/tmp/datax_run.log 2>&1
  if [[ $? -ne 0 ]]; then
    #statements
    echo "导入数据失败 日志如下"
    cat /tmp/datax_run.log
  fi
}

case $1 in
  "business_partner" | "department" | "employee" | "industry"  )
  import_data "/origin_data/financial_lease/${1}_full/$do_date" $DATAX_DATA/financial_lease.$1.json 

    ;;
  "all" )
  for table in "business_partner"   "department"  "employee"  "industry";
  do
  import_data "/origin_data/financial_lease/${table}_full/$do_date" $DATAX_DATA/financial_lease.${table}.json 
  done

    ;;
esac
```

使用示例：

`financial_mysql_to_hdfs_full.sh all 2023-11-11`

## 增量数据同步
增量表数据通道如下：

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707186301047-675fa015-5d9f-4d3f-8f57-a1f374ef7c05.png)

### Flume配置
flume的作用是将Kafka中topic_db主题的数据传输到HDFS，因此需选用KafkaSource以及HDFSSink，Channel选用FileChannel

参考文档：

kafkasource：[https://flume.apache.org/FlumeUserGuide.html#kafka-source](https://flume.apache.org/FlumeUserGuide.html#kafka-source)

FileChannel：[https://flume.apache.org/FlumeUserGuide.html#file-channel](https://flume.apache.org/FlumeUserGuide.html#file-channel)

hdfssink：[https://flume.apache.org/FlumeUserGuide.html#hdfs-sink](https://flume.apache.org/FlumeUserGuide.html#hdfs-sink)

配置文件内容如下：

```bash
a1.sources = r1
a1.channels = c1
a1.sinks = k1
 
a1.sources.r1.type = org.apache.flume.source.kafka.KafkaSource
a1.sources.r1.kafka.bootstrap.servers = hadoop108:9092,hadoop109:9092
a1.sources.r1.kafka.topics = topic_db
a1.sources.r1.kafka.consumer.group.id = flume
a1.sources.r1.interceptors = i1
a1.sources.r1.interceptors.i1.type = com.atguigu.financial.flume.interceptor.TimestampAndTableInterceptor$Builder
 
a1.channels.c1.type = file
a1.channels.c1.checkpointDir = /opt/module/flume-1.10/checkpoint/behavior1
a1.channels.c1.dataDirs = /opt/module/flume-1.10/data/behavior1/
a1.channels.c1.maxFileSize = 2146435071
a1.channels.c1.capacity = 1000000
a1.channels.c1.keep-alive = 6
 
## sink1
a1.sinks.k1.type = hdfs
a1.sinks.k1.hdfs.path = /origin_data/financial_lease/%{tableName}_inc/%Y-%m-%d
a1.sinks.k1.hdfs.round = false
 
 
a1.sinks.k1.hdfs.rollInterval = 10
a1.sinks.k1.hdfs.rollSize = 134217728
a1.sinks.k1.hdfs.rollCount = 0
 
 
a1.sinks.k1.hdfs.fileType = CompressedStream
a1.sinks.k1.hdfs.codeC = gzip
 
## 拼装
a1.sources.r1.channels = c1
a1.sinks.k1.channel= c1
```

> interceptors使用自定义的时间戳拦截器，为Event增加一个header，key为timestamp，value为json字符串中ts字段的值
>
> ![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707187278246-09830c35-bbfe-4d4f-a00a-37ac477b8255.png)
>

### Flume拦截器编写
首先创建idea项目：

然后设置pom.xml配置文件：

```xml
<dependencies>
  <dependency>
    <groupId>org.apache.flume</groupId>
    <artifactId>flume-ng-core</artifactId>
    <version>1.10.1</version>
    <scope>provided</scope>
  </dependency>

  <dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>fastjson</artifactId>
    <version>1.2.62</version>
  </dependency>
</dependencies>

<build>
  <plugins>
    <plugin>
      <artifactId>maven-compiler-plugin</artifactId>
      <version>2.3.2</version>
      <configuration>
        <source>1.8</source>
        <target>1.8</target>
      </configuration>
    </plugin>
    <plugin>
      <artifactId>maven-assembly-plugin</artifactId>
      <configuration>
        <descriptorRefs>
          <descriptorRef>jar-with-dependencies</descriptorRef>
        </descriptorRefs>
      </configuration>
      <executions>
        <execution>
          <id>make-assembly</id>
          <phase>package</phase>
          <goals>
            <goal>single</goal>
          </goals>
        </execution>
      </executions>
    </plugin>
  </plugins>
</build>
```

然后编写拦截器：

```java
package com.atguigu.financial.flume.interceptor;

import com.alibaba.fastjson.JSONException;
import com.alibaba.fastjson.JSONObject;
import org.apache.flume.Context;
import org.apache.flume.Event;
import org.apache.flume.interceptor.Interceptor;

import java.nio.charset.StandardCharsets;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

public class TimestampAndTableInterceptor implements Interceptor {


    @Override
    public void initialize() {

    }

    @Override
    public Event intercept(Event event) {
        // 需要想event的header中添加业务数据的时间戳 和 表格的名称
        Map<String, String> headers = event.getHeaders();
        // 从body字符串中提取json格式的数据
        String log = new String(event.getBody(), StandardCharsets.UTF_8);
        try {
            JSONObject jsonObject = JSONObject.parseObject(log);
            String tableName = jsonObject.getString("table");
            // maxwell数据中的时间戳是10位的  正常使用一般是13位的ts  需要*1000
            String ts = jsonObject.getString("ts") + "000";
            headers.put("tableName",tableName);
            headers.put("timestamp",ts);
        }catch (JSONException e){
            // 如果不是json格式数据  即为脏数据
            return null;
        }
        return event;
    }

    @Override
    public List<Event> intercept(List<Event> events) {
        // 批量处理event 同时实现过滤功能
        Iterator<Event> iterator = events.iterator();
        while (iterator.hasNext()) {
            Event next = iterator.next();
            if (intercept(next) == null){
                iterator.remove();
            }
        }
        return events;
    }

    @Override
    public void close() {

    }


    public static class Builder implements Interceptor.Builder{

        @Override
        public Interceptor build() {
            return new TimestampAndTableInterceptor();
        }

        @Override
        public void configure(Context context) {

        }
    }
}

```

之后打包并放在flume的lib文件夹下

### Flume测试
（1）启动Zookeeper、Kafka集群及Maxwell

（2）启动Flume：`bin/flume-ng agent -n a1 -c conf/ -f job/financial_kafka_to_hdfs_db.conf`

（3）确保maxwell正在运行，然后生成模拟数据：`financial_mock.sh 1`

可以看到数据成功同步：

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707188426521-d27ad249-6a86-4282-b0ac-3c5ce892054a.png)

注意：目标路径中的日期，并非模拟数据的业务日期，而是当前日期。这是由于**Maxwell输出的JSON字符串中的ts字段的值，是数据的变动日期**。而真实场景下，数据的业务日期与变动日期应当是一致的；

在使用模拟数据时，需要修改ts字段的值，从而让Maxwell输出的ts值时模拟数据生成是设置的日期；

### Flume启停脚本
```bash
#!/bin/bash

case $1 in
"start")
        echo " --------启动 hadoop110 业务数据flume-------"
        ssh hadoop110 "nohup /opt/module/flume-1.10/bin/flume-ng agent -n a1 -c /opt/module/flume-1.10/conf -f /opt/module/flume-1.10/job/financial_kafka_to_hdfs_db.conf >/dev/null 2>&1 &"
;;
"stop")

        echo " --------停止 hadoop110 业务数据flume-------"
        ssh hadoop110 "ps -ef | grep financial_kafka_to_hdfs_db | grep -v grep |awk '{print \$2}' | xargs -n1 kill"
;;
esac
```

### Maxwell配置（解决时间戳问题）
为了让Maxwell时间戳日期与模拟的业务日期保持一致，对Maxwell源码进行改动，增加了`mock_date`参数，在/opt/module/maxwell-1.29.0/config.properties文件中将该参数的值修改为业务日期即可

### 增量表首日全量同步
通常情况下，增量表需要在首日进行一次全量同步，后续每日再进行增量同步，首日全量同步可以使用**Maxwell的bootstrap功能**

```bash
#!/bin/bash

# 该脚本的作用是初始化所有的增量表，只需执行一次
MAXWELL_HOME=/opt/module/maxwell-1.29.0

import_data() {
 $MAXWELL_HOME/bin/maxwell-bootstrap --database financial_lease --table $1 --config $MAXWELL_HOME/config.properties
}

case $1 in
"contract" | "credit" | "credit_facility" | "credit_facility_status" | "reply")
  import_data $1
  ;;
"all")
  for table in "contract"  "credit"  "credit_facility"  "credit_facility_status"  "reply";
  do
    #statements
    import_data $table
  done
  ;;
esac
```

清空hdfs上之前的增量表数据：`hadoop fs -ls /origin_data/financial_lease  | grep _inc | awk '{print $8}' | xargs hadoop fs -rm -r -f`

开启Maxwell和flume；

执行命令：`financial_mysql_to_kafka_inc_init.sh all`即可将增量表的全部数据同步到hdfs上

# 7.数据仓库理论知识
数据仓库是一个**为数据分析而设计的企业级数据管理系统**。数据仓库可**集中、整合多个信息源的大量数据**，借助数据仓库的分析能力，企业可从数据中获得宝贵的信息进而改进决策。同时，随着时间的推移，数据仓库中积累的大量历史数据对于数据科学家和业务分析师也是十分宝贵的

## 数据仓库核心架构
![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707268407469-a00a0959-de39-4c1f-91cf-fd0f10b82388.png)

## 数据仓库建模概述
数仓建模得到的数据模型就是**数据组织和存储方法**，它强调**从业务、数据存取和使用角度合理存储数据**。只有将数据有序的组织和存储起来之后，数据才能得到高性能、低成本、高效率、高质量的使用

> 高性能：良好的数据模型能够帮助我们**快速查询**所需要的数据。
>
> 低成本：良好的数据模型能减少重复计算，实现计算结果的复用，**降低计算成本**。
>
> 高效率：良好的数据模型能极大的改善用户使用数据的体验，提高使用数据的效率。
>
> 高质量：良好的数据模型能**改善数据统计口径的混乱**，减少计算错误的可能性
>

### ER模型
数据仓库之父Bill Inmon提出的建模方法是从全企业的高度，用**实体关系**（Entity Relationship，ER）模型来描述企业业务，并用**规范化**的方式表示出来，在范式理论上符合**3NF**

#### 实体关系模型
实体关系模型将复杂的数据抽象为两个概念——实体和关系。实体表示一个对象，例如学生、班级，关系是指两个实体之间的关系，例如学生和班级之间的从属关系

#### 数据库规范化
数据库规范化是使用一系列范式设计数据库（通常是关系型数据库）的过程，其目的是**减少数据冗余，增强数据的一致性**

这一系列范式就是指在设计关系型数据库时，需要遵从的不同的规范。关系型数据库的范式一共有六种，分别是第一范式（1NF）、第二范式（2NF）、第三范式（3NF）、巴斯-科德范式（BCNF）、第四范式(4NF）和第五范式（5NF）。**<font style="background-color:#FBDE28;">遵循的范式级别越高，数据冗余性就越低</font>**

#### 三范式
##### 函数依赖
①完全函数依赖：设X，Y是关系R的两个属性集合，X’是X的真子集，存在X→Y，但对每一个X’都有X’!→Y，则称Y完全函数依赖于X

比如通过(学号，课程) 推出分数 ，但是单独用学号推断不出来分数，那么就可以说：分数完全依赖于(学号，课程) ；即：通过AB能得出C，但是AB单独得不出C，那么说C完全依赖于AB

②部分函数依赖：假如 Y函数依赖于 X，但同时 Y 并不完全函数依赖于 X，那么我们就称 Y 部分函数依赖于 X

比如通过(学号，课程) 推出姓名，因为其实直接可以通过学号推出姓名，所以：姓名 部分依赖于 (学号，课程)

即：通过AB能得出C，通过A也能得出C，或者通过B也能得出C，那么说C部分依赖于AB

③传递函数依赖：设X，Y，Z是关系R中互不相同的属性集合，存在X→Y(Y !→X),Y→Z，则称Z传递函数依赖于X

比如：学号推出系名 ，系名推出系主任， 但是，系主任推不出学号，系主任主要依赖于系名。这种情况可以说：系主任传递依赖于学号

即：通过A得到B，通过B得到C，但是C得不到A，那么说C传递依赖于A

##### 第一范式
**核心原则：属性不可切割**

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707269031734-56b55327-23df-4abe-a0c2-ff001675e53c.png)

在所有的关系型数据库管理系统（RDBMS）中存在的表一定是符合第一范式的

##### 第二范式
核心原则：不存在部分函数依赖

##### 第三范式
核心原则：不存在传递函数依赖

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707269130636-74a5f534-6745-4284-b0fe-aa0526d5c48a.png)

#### ER模型建模示例
![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707269226982-3a732e83-a3e7-43d2-9c6a-e26217b82311.png)

从图中可以看出，该模型较为松散、零碎，物理表数量多；

这种建模方法的出发点是**<font style="background-color:#FBDE28;">整合数据</font>**，其目的是**将整个企业的数据进行组合和合并，并进行规范处理，****<font style="background-color:#FBDE28;">减少数据冗余性，保证数据的一致性</font>**。这种模型**并不适合直接用于分析统计**

### 维度模型
**维度模型将复杂的业务通过****<font style="background-color:#FBDE28;">事实和维度</font>****两个概念进行呈现。****<font style="background-color:#FBDE28;">事实通常对应业务过程</font>****，而****<font style="background-color:#FBDE28;">维度通常对应业务过程发生时所处的环境</font>**

> 业务过程可以概括为一个个**不可拆分的行为事件**，例如电商交易中的下单，取消订单，付款，退单等，都是业务过程
>

示例：

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707269531330-7781358d-b4d0-49dd-abcd-ab58b0c1ac72.png)

位于中心的SalesOrder为**事实表**，其中保存的是下单这个业务过程的所有记录

位于周围每张表都是**维度表**，包括Date（日期），Customer（顾客），Product（产品），Location（地区）等，这些**维度表就组成了每个订单发生时所处的环境**，即何人、何时、在何地下单了何种产品

**<font style="background-color:#FBDE28;">维度建模以数据分析作为出发点</font>**，为数据分析服务，因此它关注的重点是用户如何更快的完成需求分析以及如何实现较好的大规模复杂查询的响应性能

## 事实表
### 概述
事实表作为数据仓库维度建模的核心，紧紧围绕着**业务过程**来设计。其包含**与该业务过程有关的维度引用**（维度表外键）以及**该业务过程的度量**（通常是可累加的数字类型字段）

特点：事实表通常比较“细长”，即列较少，但行较多，且行的增速快

分类：事实表有三种类型：分别是事务事实表、周期快照事实表和累积快照事实表

### 事务型事实表
事务型事实表用来**记录各业务过程**，它保存的是各业务过程的**<font style="background-color:#FBDE28;">原子操作事件</font>**，即**<font style="background-color:#FBDE28;">最细粒度的操作事件</font>**

> 粒度是指事实表中**<font style="background-color:#FBDE28;">一行数据所表达的业务细节程度</font>**
>

事务型事实表可用于分析与各业务过程相关的各项统计指标，由于其保存了最细粒度的记录，可以提供最大限度的灵活性，可以支持无法预期的各种细节层次的统计需求

#### 设计流程
选择业务过程→声明粒度→确认维度→确认事实

##### 选择业务过程
在业务系统中，挑选我们感兴趣的业务过程，业务过程可以概括为**一个个不可拆分的行为事件**，例如电商交易中的下单，取消订单，付款，退单等，都是业务过程。通常情况下，一个业务过程对应一张事务型事实表

##### 声明粒度
业务过程确定后，需要为每个业务过程声明粒度。即**精确定义每张事务型事实表的****<font style="background-color:#FBDE28;">每行数据</font>****表示什么**，应该尽可能选择最细粒度，以此来应各种细节程度的需求

典型粒度声明：订单事实表中一行数据表示的是一个订单中的一个商品项

##### 确定维度
确定维度具体是指，确定与每张事务型事实表相关的维度有哪些

确定维度时应**<font style="background-color:#FBDE28;">尽量多</font>****的选择与业务过程相关的环境信息**。因为维度的丰富程度就决定了维度模型能够支持的指标丰富程度

##### 确定事实
这里的“事实”指的是**每个业务过程的****<font style="color:#DF2A3F;">度量值</font>**（**<font style="color:#DF2A3F;">通常是可累加的数字类型的值，例如：次数、个数、件数、金额等</font>**）



总结：第一步选择业务过程可以确定有哪些事务型事实表，第二步可以确定每张事务型事实表的每行数据是什么，第三步可以确定每张事务型事实表的维度外键，第四步可以确定每张事务型事实表的度量值字段

#### 不足
事务型事实表可以保存所有业务过程的最细粒度的操作事件，故理论上其可以支撑与各业务过程相关的各种统计粒度的需求。但对于某些特定类型的需求，其**逻辑可能会比较复杂**，或者效率会比较低下。例如：

**1）存量型指标**

例如**商品库存，账户余额**等。此处以电商中的虚拟货币为例，虚拟货币业务包含的业务过程主要包括获取货币和使用货币，两个业务过程各自对应一张事务型事实表，一张存储所有的获取货币的原子操作事件，另一张存储所有使用货币的原子操作事件。

假定现有一个需求，要求统计截至当日的各用户虚拟货币余额。由于获取货币和使用货币均会影响到余额，故**需要对两张事务型事实表进行聚合**，且需要**区分两者对余额的影响**（加或减），另外需要对两张表的全表数据聚合才能得到统计结果。

可以看到，不论是从逻辑上还是效率上考虑，这都不是一个好的方案

**2）多事务关联统计**

例如，现需要统计最近30天，用户下单到支付的时间间隔的平均值。统计思路应该是找到下单事务事实表和支付事务事实表，过滤出最近30天的记录，然后按照订单id对两张事实表进行关联，之后用支付时间减去下单时间，然后再求平均值。

逻辑上虽然并不复杂，但是其效率较低，因为下单事务事实表和支付事务事实表均为大表，大表join大表的操作应尽量避免

### 周期型快照事实表
周期快照事实表**以具有规律性的、可预见的****<font style="background-color:#FBDE28;">时间间隔</font>****来记录事实**，主要用于**分析一些****<font style="background-color:#FBDE28;">存量型</font>****（例如商品库存，账户余额）或者****<font style="background-color:#FBDE28;">状态型</font>****（空气温度，行驶速度）指标**

①对于商品库存、账户余额这些存量型指标，业务系统中通常就会计算并保存最新结果，所以定期同步一份全量数据到数据仓库，构建周期型快照事实表，就能轻松应对此类统计需求，而**无需再对事务型事实表中大量的历史记录进行聚合了**

②对于空气温度、行驶速度这些状态型指标，由于它们的**值往往是连续的**，我们**<font style="background-color:#FBDE28;">无法捕获其变动的原子事务操作</font>**，所以无法使用事务型事实表统计此类需求。而只能定期对其进行采样，构建周期型快照事实表

> 对比下单事务，我们可以清晰地进行表述，某人在某时间对某个商品进行了下单操作；但对于温度变化，我们很难完整地描述是什么样地操作具体在什么时候引起了温度变化
>

#### 设计流程
##### 确定粒度
周期型快照事实表的粒度可由**<font style="background-color:#FBDE28;">采样周期</font>**和**<font style="background-color:#FBDE28;">维度</font>**描述，故确定采样周期和维度后即可确定粒度。

+ 采样周期通常选择**每日**
+ 维度可根据**统计指标**决定，例如指标为统计每个仓库中每种商品的库存，则可确定维度为仓库和商品

确定完采样周期和维度后，即可确定该表粒度为每日-仓库-商品

##### 确认事实
事实也可根据统计指标决定，例如指标为统计每个仓库中每种商品的库存，则事实为商品库存

#### 事实类型
此处的事实类型是指**度量值的类型**，而非事实表的类型；事实（度量值）共分为三类，分别是可加事实，半可加事实和不可加事实。

1. 可加事实：可加事实是指**可以按照与事实表相关的****<font style="background-color:#FBDE28;">所有维度</font>****进行累加**，例如**事务型事实表中的事实**。
2. 半可加事实：半可加事实是指**只能按照与事实表相关的****<font style="background-color:#FBDE28;">一部分维度</font>****进行累加**，例如**周期型快照事实表中的事实**。以上述各仓库中各商品的库存每天快照事实表为例，这张表中的库存事实可以按照仓库或者商品维度进行累加，**但是不能按照时间维度进行累加**，因为将每天的库存累加起来是没有任何意义的。
3. 不可加事实：不可加事实是指完全不具备可加性，例如**比率型事实**。不可加事实通常需要转化为可加事实，例如比率可转化为分子和分母

### 累积型快照事实表
累计快照事实表是**基于****<font style="background-color:#FBDE28;">一个业务流程中的</font>****<font style="color:#DF2A3F;background-color:#FBDE28;">多个关键业务过程联合处理</font>****而构建的事实表**，如交易流程中的下单、支付、发货、确认收货业务过程。

累积型快照事实表通常**具有多个日期字段**，每个日期对应业务流程中的一个关键业务过程（里程碑）

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707270896901-97558760-9db4-4c6a-a9f9-452f3adcbef5.png)

累积型快照事实表**<font style="background-color:#FBDE28;">主要用于分析业务过程（里程碑）之间的时间间隔等需求</font>**

例如计算用户下单到支付的平均时间间隔地需求，使用累积型快照事实表进行统计，就能避免两个事务事实表的关联操作，从而变得十分简单高效

#### 设计流程
选择业务过程→声明粒度→确认维度→确认事实

##### 选择业务过程
选择**一个业务流程中需要关联分析的多个关键业务过程**，多个业务过程对应一张累积型快照事实表

##### 声明粒度
精确定义每行数据表示的是什么，尽量选择最小粒度

##### 确认维度
选择与各业务过程相关的维度，需要注意的是，**每个业务过程均需要一个日期维度**

##### 确认事实
选择各业务过程的度量值

## 维度表
维度表主要包含**一个主键和各种维度字段**，维度字段称为维度属性

### 维度设计步骤
#### 1.确定维度（表）
在设计事实表时，已经确定了与每个事实表相关的维度，理论上每个相关维度均需对应一张维度表。

需要注意到，可能存在多个事实表与同一个维度都相关的情况，这种情况**需保证维度的唯一性**，即只创建一张维度表。

另外，如果**某些维度表的维度属性很少**，例如只有一个**名称，则可不创建该维度表，而把该表的维度属性直接增加到与之相关的事实表中，这个操作称为**<font style="background-color:#FBDE28;">维度退化</font>**

#### 2.确定主维表和相关维表
此处的主维表和相关维表均指**业务系统中与某维度相关的表**；

例如业务系统中与商品相关的表有sku_info，spu_info，base_trademark，base_category3，base_category2，base_category1等（其中都包含了部分的商品信息，使用时通常需要将这些表进行join），其中sku_info就称为商品维度的主维表，其余表称为商品维度的相关维表。维度表的粒度通常与主维表相同

#### 3.确定维度属性
确定维度属性即**<font style="background-color:#FBDE28;">确定维度表字段</font>**。维度属性主要来自于业务系统中与该维度对应的主维表和相关维表。维度属性可直接从主维表或相关维表中选择，也可通过进一步加工得到；

确定维度属性时，需要遵循以下要求：

1. 尽可能生成**丰富**的维度属性：**<font style="background-color:#FBDE28;">维度属性是后续做分析统计时的查询约束条件、分组字段的基本来源</font>**，是数据易用性的关键。**维度属性的丰富程度直接影响到数据模型能够支持的指标的丰富程度**
2. **尽量不使用编码**，而使用明确的文字说明，一般可以编码和文字共存
3. 尽量沉淀出**通用**的维度属性：有些维度属性的获取需要进行比较复杂的逻辑处理，例如需要通过多个字段拼接得到。为避免后续每次使用时的重复处理，可将这些维度属性沉淀到维度表中

### 维度设计要点
#### 1.规范化与反规范化
+ 规范化是指**<font style="background-color:#FBDE28;">使用一系列范式设计数据库</font>**的过程，其目的是**减少数据冗余，增强数据的一致性**。通常情况下，规范化之后，一张表的字段会拆分到多张表。
+ 反规范化是指**<font style="background-color:#FBDE28;">将多张表的数据冗余到一张表</font>**，其目的是**减少join操作，提高查询性能**

在设计维度表时，如果对其进行规范化，得到的维度模型称为**雪花模型**，如果对其进行反规范化，得到的模型称为**星型模型**

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707271844449-9ae678fd-5118-4212-a2ae-61fca2475339.png)

数据仓库系统的主要目的是用于数据分析和统计，所以**<font style="color:#DF2A3F;background-color:#FBDE28;">是否方便用户进行统计分析决定了模型的优劣</font>**。采用雪花模型，用户在统计分析的过程中需要**大量的关联操作**，**使用复杂度高，同时查询性能很差**；而采用星型模型，则方便、易用且性能好。

所以**<font style="color:#DF2A3F;background-color:#FBDE28;">出于易用性和性能的考虑，维度表一般是很不规范化的</font>**

#### 2.维度变化
维度属性通常不是静态的，而是会随时间变化的，数据仓库的一个重要特点就是**反映历史的变化**，所以如何**保存维度的历史状态**是维度设计的重要工作之一

##### 全量快照表
离线数据仓库的计算周期通常为每天一次，所以可以每天保存一份全量的维度数据

+ 优点：简单而有效，开发和维护成本低，且方便理解和使用
+ 缺点：浪费存储空间，尤其是当数据的变化比例比较低时

##### 拉链表
拉链表的意义在于能够更加高效的保存维度信息的历史状态



`<u>什么是拉链表：</u>`

拉链表：记录每条信息的生命周期，一旦一条记录的生命周期结束，就重新开始一条新的记录，并把当前日期放入生效开始日期

如果当前信息至今有效，在生效结束日期中填入一个极大值（如9999-12-31 ）

例如：

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707272057863-5113346f-962d-4889-91a7-31580b39ee70.png)



`<u>为什么要使用拉链表：</u>`

**<font style="color:#DF2A3F;background-color:#FBDE28;">拉链表适合于：数据会发生变化，但是变化频率并不高的维度</font>**（即：缓慢变化维）

比如：用户信息会发生变化，但是每天变化的比例不高。如果数据量有一定规模，按照每日全量的方式保存效率很低

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707272129764-08b2c091-c511-4501-89ce-c4821508a65d.png)



`<u>如何</u>**<u>使用</u>**<u>拉链表</u>`

通过，`生效开始日期<=某个日期  且 生效结束日期>=某个日期` ，能够得到某个时间点的**数据全量切片**

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707272360381-bed84360-ceab-4076-88e3-42d217ea45fd.png)

#### 3.多值维度
如果**事实表中一条记录在某个维度表中有多条记录与之对应，称为多值维度**

例如，下单事实表中的一条记录为一个订单，一个订单可能包含多个商品，所会商品维度表中就可能有多条数据与之对应

针对这种情况，通常采用以下两种方案解决。

1. 降低事实表的粒度，例如**将订单事实表的粒度由一个订单降低为一个订单中的一个商品项**
2. 在事实表中采用多字段保存多个维度值，每个字段保存一个维度id。这种方案只适用于多值维度个数固定的情况

> 建议尽量采用第一种方案解决多值维度问题
>

#### 4.多值属性
维表中的**某个属性同时有多个值**，称之为“多值属性”，例如商品维度的平台属性和销售属性，每个商品均有多个属性值

针对这种情况，通常有可以采用以下两种方案。

1. 将多值属性放到一个字段，该字段内容为`key1:value1，key2:value2`的形式，例如一个手机商品的平台属性值为`“品牌：华为，系统：鸿蒙，CPU：麒麟990”`
2. 将多值属性放到多个字段，每个字段对应一个属性。这种方案只适用于多值属性个数固定的情况

## 数据仓库设计
### 数据仓库分层规划
![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707274474779-ddfe7c39-3dde-4b4b-94aa-f6944eb0de22.png)

### 数据仓库构建流程
![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707274515846-d5bb54c9-d772-47b9-915d-e4048ea79b23.png)

#### 1.数据调研
数据调研重点要做两项工作，分别是业务调研和需求分析

1）业务调研

业务调研的主要目标是**熟悉业务流程、熟悉****<font style="background-color:#FBDE28;">业务数据</font>**。

熟悉业务流程要求做到，明确每个业务的具体流程，需要将该业务所包含的每个业务过程一一列举出来。

熟悉业务数据要求做到，将数据（包括埋点日志和业务数据表）与业务过程对应起来，明确每个业务过程会对哪些表的数据产生影响，以及产生什么影响。产生的影响，需要具体到，是新增一条数据，还是修改一条数据，并且需要明确新增的内容或者是修改的逻辑



示例：金融租赁业务流程

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707275903351-050b90e6-953b-4738-afd2-83edc2de5b8f.png)



2）需求分析

典型的需求指标如，最近一天各省份手机品类订单总额。

分析需求时，需要**明确需求所需的业务过程及维度**，例如该需求所需的业务过程就是买家下单，所需的维度有日期，省份，商品品类

> 做完业务分析和需求分析之后，要保证每个需求都能找到与之对应的业务过程及维度。
>

#### 2.明确数据域
数据仓库模型设计除横向的分层外，通常也需要**<font style="color:#DF2A3F;background-color:#FBDE28;">根据业务情况进行纵向划分数据域</font>**；划分数据域的意义是便于数据的管理和应用

通常可以根据**业务过程**或者部门进行划分，需要注意的是**一个业务过程只能属于一个数据域**



示例：

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707276016751-5de00d8b-4bf0-4910-a6f2-a38599cb62c4.png)

#### 3.构建业务总线矩阵
业务总线矩阵中**包含维度模型所需的所有事实（业务过程）以及维度**，以及各业务过程与各维度的关系。

**<font style="background-color:#FBDE28;">矩阵的行是一个个业务过程，矩阵的列是一个个的维度，行列的交点表示业务过程与维度的关系</font>**

示例：

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707276116387-de03326e-6da0-42d8-a37e-6c08e1562470.png)

一个业务过程对应维度模型中一张事务型事实表，一个维度则对应维度模型中的一张维度表。所以**构建业务总线矩阵的过程就是设计维度模型的过程**

但是需要注意的是，**总线矩阵中通常只包含事务型事实表，另外两种类型的事实表需单独设计**

#### 4.明确统计指标
明确统计指标具体的工作是，深入分析需求，构建指标体系。构建指标体系的主要意义就是指标定义标准化。所有指标的定义，都必须遵循同一套标准，这样能有效的避免指标定义存在歧义，指标定义重复等问题

**（1）原子指标**

原子指标**基于某一业务过程的度量值，是业务定义中不可再拆解的指标**，原子指标的核心功能就是对指标的**聚合逻辑**进行了定义。我们可以得出结论，**原子指标包含三要素，分别是****<font style="background-color:#FBDE28;">业务过程、度量值和聚合逻辑</font>**

> 例如**订单总额**就是一个典型的原子指标，其中的业务过程为用户下单、度量值为订单金额，聚合逻辑为sum()求和。需要注意的是原子指标只是用来辅助定义指标一个概念，通常不会对应有实际统计需求与之对应
>

（2）派生指标

派生指标基于原子指标：

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707276231328-86f42a24-75b1-435e-b9d8-c68d200b0609.png)

与原子指标不同，**派生指标通常会对应实际的统计需求**

（3）衍生指标

衍生指标是**在一个或多个派生指标的基础上，通过各种逻辑运算复合而成的**。例如比率、比例等类型的指标。衍生指标也会对应实际的统计需求

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707276262941-b6c29485-7428-46c6-adfb-8b0fef63b10c.png)

#### 5.维度模型设计
维度模型设计即DIM和DWD层的构建过程。事实表存储在DWD层，维度表存储在DIM层。通常这两层的搭建是基于业务总线矩阵进行的，后者一行对应一张事务事实表，一列对应一张维度表

---

本项目维度模型设计说明如下：

（1）本项目并不关注审核流程中具体的业务过程，更侧重于**某时刻处于各状态的项目的相关统计**，因此，通过累积快照事实表实现需求，**不再构建事务事实表（使用累积型快照事实表）**

（2）本项目的业务过程涉及了很多与“人”相关的维度：风控员、一级审核员等，对于业务过程而言，它们是不同的维度，但从业务实体的角度分析，它们都属于员工维度，因此对于这部分维度，最终**只建立一张员工维度表**

（3）一般来说，项目的公共派生指标统一保存在数据仓库的DWS层，但经过分析，虽然本项目的需求均为状态相关的统计，涉及多个业务过程，均为衍生指标，可以按照上述思路设计DWS和ADS，基于事务事实表做计算求得。然而，**这样做势必在下游涉及大量事务事实表的关联操作**，且计算过程过于繁复。因此，本项目**在DWD层构建累积快照事实事实表**，记录关键业务过程的里程碑，下游基于这些里程碑做判断就可以轻易得出统计结果，大大简化计算过程，减少数仓建模的复杂程度。因而，本项目**不再需要对指标进行拆分，ADS层直接从DWD层累积快照事实表取数计算即可，因此也就****<font style="background-color:#FBDE28;">不需要进行汇总模型设计</font>**

---

## 数据仓库运行环境
### Spark执行引擎
1.需要配置Hive on Spark的运行环境；

使用的版本是Hive3.1.3和Spark3.3.0，但这两个版本默认不兼容（Hive3.1.3支持的Spark版本是2.3.0），因此需要手动修改hive源码，将pom文件中的spark2.3.0改为3.3.0，然后再进行打包：

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707560240802-df824d7b-78b2-4132-b4bf-96afaebbca33.png)



2.上传纯净版spark包（为了避免版本冲突），使用自己配置的Hadoop环境：

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707561328435-875c8785-7161-4181-b3e5-f16c2ae19611.png)

> 下载地址：[http://spark.apache.org/downloads.html](http://spark.apache.org/downloads.html)
>



3.进行环境配置：

①在spark-env.sh配置文件中添加：`export SPARK_DIST_CLASSPATH=$(hadoop classpath)`

> `SPARK_DIST_CLASSPATH`告诉 Spark 在分布式模式下如何获取依赖的 JAR 包和类路径。
>
> 这里指定了 Hadoop 的类路径，以便 Spark 可以与 HDFS 进行交互
>



②配置SPARK_HOME环境变量：

```bash
# SPARK_HOME
export SPARK_HOME=/opt/module/spark-3.3.1
export PATH=$PATH:$SPARK_HOME/bin
```



③在hive中创建spark配置文件：`vim /opt/module/hive/conf/spark-defaults.conf`

添加以下内容：

```bash
spark.master                               yarn
spark.eventLog.enabled                   true
spark.eventLog.dir                        hdfs://hadoop102:8020/spark-history
spark.executor.memory                    1g
spark.driver.memory					     				1g
```

> 含义：
>
> 使用spark on yarn的模式进行集群管理
>
> 开启事件日志功能
>
> 设置事件日志存储路径
>
> 设置每个executor的内存
>
> 设置每个driver的内存
>

同时要在hdfs中创建日志存储路径：`hadoop fs -mkdir /spark-history`



④向HDFS上传Spark纯净版jar包

原因：Hive任务最终由Spark来执行，Spark任务资源分配由Yarn来调度，**该任务有可能被分配到集群的任何一个节点**。所以需要将Spark的依赖上传到HDFS集群路径，这样集群中任何一个节点都能获取

执行以下指令：

`hadoop fs -mkdir /spark-jars`

`hadoop fs -put /opt/module/spark/jars/* /spark-jars`



⑤修改hive-site.xml文件：

添加spark相关配置：

```xml
<!--Spark依赖位置（注意：端口号8020必须和namenode的端口号一致）-->
<property>
  <name>spark.yarn.jars</name>
  <value>hdfs://hadoop102:8020/spark-jars/*</value>
</property>

<!--Hive执行引擎-->
<property>
  <name>hive.execution.engine</name>
  <value>spark</value>
</property>
<!--提交任务超时时间-->
<property>
  <name>hive.spark.client.connect.timeout</name>
  <value>5000</value>
</property>
```



⑥测试：建表并插入数据：

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707561738501-279e90db-260b-4b83-b53d-b433baaad76a.png)

### Yarn环境配置
为了同时在多个hive客户端上运行任务，需要增加ApplicationMaster资源比例：

容量调度器对每个资源队列中同时运行的Application Master占用的资源进行了限制，该限制通过`yarn.scheduler.capacity.maximum-am-resource-percent`参数实现，其默认值是0.1，表示**每个资源队列上Application Master最多可使用的资源为该队列总资源的10%**，目的是防止大部分资源都被Application Master占用，而导致Map/Reduce Task无法执行

生产环境该参数可使用默认值。但在测试环境中，集群资源总数较少，如果只分配10%的资源给Application Master，则可能出现，同一时刻只能运行一个Job的情况，因为一个Application Master使用的资源就可能已经达到10%的上限了。故此处可将该值适当调大

修改`capacity-scheduler.xml`文件，适当调整该值：

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707564980612-5d30fd99-976b-4f71-b9e6-16f283a34146.png)

分发配置文件后重启yarn即可



可以看到成功启动两个客户端：

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707565536739-40793c79-a266-4258-8938-2b871a8473d2.png)

# 8.模拟数据准备
假设数据仓库上线时间为2023-05-09，为了模拟真实场景，需要对历史数据进行处理



①将`/origin_data`路径下之前的数据删除，防止之前的测试产生数据带来的影响

②停止Maxwell采集通道并重建业务数据库（清空原先业务数据库中的内容）

`drop database financial_lease`

`create database financial_lease default charset utf8mb4 collate utf8mb4_general_ci`

③依次向业务数据库中生成2023-5-1—2023-5-9的数据：

+ 首先修改`/opt/module/financial_mock_app/application.yml`，将起始日期修改为2023-05-01
+ 然后执行模拟数据生成脚本即可：`financial_mock.sh 9`

④进行全量表同步（datax）：`financial_mysql_to_hdfs_full.sh all 2023-05-09`（同步所有表，2023-05-09当天的数据，包括05-01到05-09的所有数据）

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1707566970359-215779f6-5cfb-4aec-b28a-df85e0631a14.png)

⑤增量表首日全量同步（Maxwell的bootstrap功能），将05-01到05-09的数据全部同步过来：

（1）清除Maxwell断点记录：由于Maxwell支持断点续传，而上述重新生成业务数据的过程，会产生大量的**binlog操作日志**，这些日志我们并不需要。故此处需**清除Maxwell的断点记录**，令其**从binlog最新的位置开始采集**：

清空Maxwell数据库中所有表即可（相当于初始化Maxwell）：

```plsql
drop table maxwell.bootstrap;
drop table maxwell.columns;
drop table maxwell.databases;
drop table maxwell.heartbeats;
drop table maxwell.positions;
drop table maxwell.schemas;
drop table maxwell.tables;
```

（2）修改Maxwell配置文件中的mock_date参数为2023-05-09

（3）执行增量表首日全量同步脚本：`financial_mysql_to_kafka_inc_init.sh all`

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1708325675566-ff4bb6e9-05ae-4c29-a085-6552fa2bf0c7.png)

如图所示则所有的增量表和全量表2023-05-01-2023-05-09的数据均同步完成



# 9.数仓开发流程
## ODS层
ODS层的设计要点如下：

1. ODS层的表结构设计依托于**从业务系统同步过来的数据结构**
2. ODS层要保存全部历史数据，故其**压缩格式应选择压缩比较高的**，此处选择gzip
3. ODS层表名的命名规范为：ods_表名_单分区增量全量标识（inc/full）

### 建表
完整建表语句如下：

```plsql
--ods层主要用于将所有的mysql业务员表中的数据同步到hive中

--7.1.1 客户表（全量表）
DROP TABLE IF EXISTS ods_business_partner_full;
CREATE EXTERNAL TABLE IF NOT EXISTS ods_business_partner_full
(
    `id`          STRING COMMENT '客户ID',
    `create_time` STRING COMMENT '创建时间',
    `update_time` STRING COMMENT '更新时间',
    `name`        STRING COMMENT '客户姓名'
) COMMENT '客户全量表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
    NULL DEFINED AS ''
    LOCATION '/warehouse/financial_lease/ods/ods_business_partner_full/'
    TBLPROPERTIES ('compression.codec' = 'org.apache.hadoop.io.compress.GzipCodec');
--7.1.2 部门表（全量表）
DROP TABLE IF EXISTS ods_department_full;
CREATE EXTERNAL TABLE IF NOT EXISTS ods_department_full
(
    `id`                     STRING COMMENT '部门ID',
    `create_time`            STRING COMMENT '创建时间',
    `update_time`            STRING COMMENT '更新时间',
    `department_level`       STRING COMMENT '部门级别',
    `department_name`        STRING COMMENT '部门名称',
    `superior_department_id` STRING COMMENT '上级部门ID'
) COMMENT '部门全量表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
        NULL DEFINED AS ''
    LOCATION '/warehouse/financial_lease/ods/ods_department_full/'
    TBLPROPERTIES ('compression.codec' = 'org.apache.hadoop.io.compress.GzipCodec');
--7.1.3 员工信息表（全量表）
DROP TABLE IF EXISTS ods_employee_full;
CREATE EXTERNAL TABLE IF NOT EXISTS ods_employee_full
(
    `id`            STRING COMMENT '员工ID',
    `create_time`   STRING COMMENT '创建时间',
    `update_time`   STRING COMMENT '更新时间',
    `name`          STRING COMMENT '员工姓名',
    `type`          STRING comment '员工类型：1.业务员 2.风控员',
    `department_id` STRING comment '部门ID'
) COMMENT '员工全量表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
        NULL DEFINED AS ''
    LOCATION '/warehouse/financial_lease/ods/ods_employee_full/'
    TBLPROPERTIES ('compression.codec' = 'org.apache.hadoop.io.compress.GzipCodec');
--7.1.4 行业表（全量表）
DROP TABLE IF EXISTS ods_industry_full;
CREATE EXTERNAL TABLE IF NOT EXISTS ods_industry_full
(
    `id`                   STRING COMMENT '行业ID',
    `create_time`          STRING COMMENT '创建时间',
    `update_time`          STRING COMMENT '更新时间',
    `industry_level`       STRING COMMENT '行业级别',
    `industry_name`        STRING COMMENT '行业名称',
    `superior_industry_id` STRING COMMENT '上级行业ID'
) COMMENT '行业全量表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
        NULL DEFINED AS ''
    LOCATION '/warehouse/financial_lease/ods/ods_industry_full/'
    TBLPROPERTIES ('compression.codec' = 'org.apache.hadoop.io.compress.GzipCodec');
--7.1.5 授信申请表（增量表）
DROP TABLE IF EXISTS ods_credit_facility_inc;
CREATE EXTERNAL TABLE IF NOT EXISTS ods_credit_facility_inc
(
    `type` STRING COMMENT '变动类型',
    `ts`   BIGINT COMMENT '变动时间',
    `data` STRUCT<id :STRING,
                create_time :STRING,
                update_time :STRING,
                credit_amount :DECIMAL(16, 2),
                lease_organization : STRING,
                status :STRING ,
                business_partner_id :STRING,
                credit_id : STRING,
                industry_id :STRING,
                reply_id :STRING,
                salesman_id :STRING> COMMENT '数据',
    `old` MAP<STRING,STRING> COMMENT '旧值'
) COMMENT '授信申请增量表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.JsonSerDe'
    LOCATION '/warehouse/financial_lease/ods/ods_credit_facility_inc/'
    TBLPROPERTIES ('compression.codec' = 'org.apache.hadoop.io.compress.GzipCodec');
--7.1.6 审核记录表（增量表）
DROP TABLE IF EXISTS ods_credit_facility_status_inc;
CREATE EXTERNAL TABLE IF NOT EXISTS ods_credit_facility_status_inc
(
    `type` STRING COMMENT '变动类型',
    `ts`   BIGINT COMMENT '变动时间',
    `data` STRUCT<id :STRING,
                create_time :STRING,
                update_time :STRING,
                action_taken :STRING,
                status :STRING,
                credit_facility_id :STRING,
                employee_id :STRING,
                signatory_id :STRING> COMMENT '数据',
    `old` MAP<STRING,STRING> COMMENT '旧值'
) COMMENT '审核记录增量表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.JsonSerDe'
    LOCATION '/warehouse/financial_lease/ods/ods_credit_facility_status_inc/'
    TBLPROPERTIES ('compression.codec' = 'org.apache.hadoop.io.compress.GzipCodec');
--7.1.7 批复表（增量表）
DROP TABLE IF EXISTS ods_reply_inc;
CREATE EXTERNAL TABLE IF NOT EXISTS ods_reply_inc
(
    `type` STRING COMMENT '变动类型',
    `ts`   BIGINT COMMENT '变动时间',
    `data` STRUCT<id :STRING,
                create_time :STRING,
                update_time:STRING,
                credit_amount :DECIMAL(16, 2),
                irr: DECIMAL(16, 2),
                period: BIGINT,
                credit_facility_id :STRING> COMMENT '数据',
    `old` MAP<STRING,STRING> COMMENT '旧值'
) COMMENT '批复增量表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.JsonSerDe'
    LOCATION '/warehouse/financial_lease/ods/ods_reply_inc/'
    TBLPROPERTIES ('compression.codec' = 'org.apache.hadoop.io.compress.GzipCodec');
--7.1.8 授信表（增量表）
DROP TABLE IF EXISTS ods_credit_inc;
CREATE EXTERNAL TABLE IF NOT EXISTS ods_credit_inc
(
    `type` STRING COMMENT '变动类型',
    `ts`   BIGINT COMMENT '变动时间',
    `data` STRUCT<id :STRING,
                create_time :STRING,
                update_time :STRING,
                cancel_time: STRING,
                contract_produce_time:STRING,
                credit_amount:decimal(16,2),
                credit_occupy_time: STRING,
                status: STRING,
                contract_id: STRING,
                credit_facility_id :STRING> COMMENT '数据',
    `old` MAP<STRING,STRING> COMMENT '旧值'
) COMMENT '授信增量表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.JsonSerDe'
    LOCATION '/warehouse/financial_lease/ods/ods_credit_inc/'
    TBLPROPERTIES ('compression.codec' = 'org.apache.hadoop.io.compress.GzipCodec');
--7.1.9 合同表（增量表）
DROP TABLE IF EXISTS ods_contract_inc;
CREATE EXTERNAL TABLE IF NOT EXISTS ods_contract_inc
(
    `type` STRING COMMENT '变动类型',
    `ts`   BIGINT COMMENT '变动时间',
    `data` STRUCT<id :STRING,
                create_time :STRING,
                update_time:STRING,
                execution_time :STRING,
                signed_time: STRING,
                status: STRING,
                credit_id :STRING> COMMENT '数据',
    `old` MAP<STRING,STRING> COMMENT '旧值'
) COMMENT '合同增量表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.JsonSerDe'
    LOCATION '/warehouse/financial_lease/ods/ods_contract_inc/'
    TBLPROPERTIES ('compression.codec' = 'org.apache.hadoop.io.compress.GzipCodec');
```

建表语句解析

全量表（以客户表为例）：

```plsql
DROP TABLE IF EXISTS ods_business_partner_full;
CREATE EXTERNAL TABLE IF NOT EXISTS ods_business_partner_full
(
    `id`          STRING COMMENT '客户ID',
    `create_time` STRING COMMENT '创建时间',
    `update_time` STRING COMMENT '更新时间',
    `name`        STRING COMMENT '客户姓名'
) COMMENT '客户全量表'
    PARTITIONED BY (`dt` STRING) --当天时间作为分区字段
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t' --分隔符为\t
    NULL DEFINED AS '' --空值转化为null
    LOCATION '/warehouse/financial_lease/ods/ods_business_partner_full/' --在hdfs上的存储路径
    TBLPROPERTIES ('compression.codec' = 'org.apache.hadoop.io.compress.GzipCodec'); --压缩格式配置
```

增量表（以授信申请表为例）：

```plsql
DROP TABLE IF EXISTS ods_credit_facility_inc;
CREATE EXTERNAL TABLE IF NOT EXISTS ods_credit_facility_inc
(
    `type` STRING COMMENT '变动类型',
    `ts`   BIGINT COMMENT '变动时间',
    `data` STRUCT<id :STRING, --数据类型为STRUCT 里面再写单独的字段类型
                create_time :STRING,
                update_time :STRING,
                credit_amount :DECIMAL(16, 2),
                lease_organization : STRING,
                status :STRING ,
                business_partner_id :STRING,
                credit_id : STRING,
                industry_id :STRING,
                reply_id :STRING,
                salesman_id :STRING> COMMENT '数据',
    `old` MAP<STRING,STRING> COMMENT '旧值'
) COMMENT '授信申请增量表'
    PARTITIONED BY (`dt` STRING)
    ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.JsonSerDe' --使用serde解析json数据
    LOCATION '/warehouse/financial_lease/ods/ods_credit_facility_inc/'
    TBLPROPERTIES ('compression.codec' = 'org.apache.hadoop.io.compress.GzipCodec');
```

由于maxwell输出的数据为json格式的，因此hive需要对json格式的数据进行解析

这里使用serde对json数据进行解析，相关用法可以参考：

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1708328747042-6121a4a8-6549-4c26-a2a5-8a5994c0cee8.png)

[https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL#LanguageManualDDL-RowFormats&SerDe](https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL#LanguageManualDDL-RowFormats&SerDe)

[https://cwiki.apache.org/confluence/display/Hive/SerDe](https://cwiki.apache.org/confluence/display/Hive/SerDe)  


### 数据装载
语法：`load data inpath......OVERWRITE into table......`

使用OVERWRITE的原因是为了保证幂等性，也就是说，如果在脚本执行期间，一部分数据装载了，另一部分没装载，依旧可以通过运行脚本装载全部的数据

脚本解析：

```bash
#!/bin/bash

APP=financial_lease 

#判断是否填入日期参数
if [ -n "$2" ] ;then # $2表示第二个参数 -n用于判断是否为空
   do_date=$2 # 如果填入则为当日日期
else 
   do_date=`date -d '-1 day' +%F` # 如果未填入则使用当天的前一天；date -d '-1 day'表示当前日期的前一天；+%F表示以YYYY-MM-DD的格式输出日期
fi

# load_data函数用于装载数据
load_data(){
    sql=""
    for i in $*; do # $*表示传入的所有参数
        #判断路径是否存在（判断相应分区下是否有数据）
        hadoop fs -test -e /origin_data/$APP/${i:4}/$do_date
        #路径存在方可装载数据
        if [[ $? = 0 ]]; then # $?用于获取上一次运行的返回值 返回值为0表示不为空，为1表示为空
            #循环拼接所有表的数据装载sql，最后一起运行，避免开启多个hive客户端
            sql=$sql"load data inpath '/origin_data/$APP/${i:4}/$do_date/' OVERWRITE into table ${APP}.$i partition(dt='$do_date');"
        fi
    done
    hive -e "$sql" # 通过hive -e后台运行sql
}

case $1 in # $1表示第一个参数，可以选择某一张表进行装载，也可以全部装载
    ods_business_partner_full | ods_department_full | ods_employee_full | ods_industry_full | ods_credit_facility_inc | ods_credit_facility_status_inc | ods_reply_inc | ods_credit_inc | ods_contract_inc)
        load_data $1
    ;;

    "all")
        load_data "ods_business_partner_full" "ods_department_full" "ods_employee_full" "ods_industry_full" "ods_credit_facility_inc" "ods_credit_facility_status_inc" "ods_reply_inc" "ods_credit_inc" "ods_contract_inc"
    ;;
esac
```

1.`hadoop fs -test -e`来判断路径是否为空：

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1708327746303-d45a2fbc-1e76-4406-a999-a318c9a625d4.png)

在该路径下有数据文件：

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1708327781476-84622ff4-ba8d-4d86-9418-0c25373e0f45.png)

因此路径不为空（返回值为0）；

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1708327790869-d8808456-0a75-489c-9a43-cef13a604181.png)

该路径下没有数据文件：

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1708327834800-8c6e2f2b-4331-4ac6-9d4b-35eb3543aaaa.png)

因此路径为空（返回值为1）

2.`hive -e`来后台运行hive语句，这样就不用开启hive客户端了，方标使用脚本

## DIM层
DIM层设计要点：

1. DIM层的设计依据是**维度建模理论**，该层存储维度模型的维度表
2. DIM层的数据**存储格式为orc列式存储**+snappy压缩
3. DIM层表名的命名规范为dim_表名_全量表或者拉链表标识（full/zip）

### 建表
一共需要三张表：部门维度表、员工维度表、行业维度表

```plsql
--部门维度表
DROP TABLE IF EXISTS dim_department_full;
CREATE EXTERNAL TABLE IF NOT EXISTS dim_department_full
(
    `department3_id`   STRING COMMENT '三级部门ID',
    `department3_name` STRING COMMENT '三级部门名称',
    `department2_id`   STRING COMMENT '二级部门ID',
    `department2_name` STRING COMMENT '二级部门名称',
    `department1_id`   STRING COMMENT '一级部门ID',
    `department1_name` STRING COMMENT '一级部门名称'
) COMMENT '部门维度表'
    PARTITIONED BY (`dt` STRING)
    STORED AS ORC
    LOCATION '/warehouse/financial_lease/dim/dim_department_full/'
    TBLPROPERTIES ('orc.compress' = 'snappy');

--员工维度表
DROP TABLE IF EXISTS dim_employee_full;
CREATE EXTERNAL TABLE IF NOT EXISTS dim_employee_full
(
    `id`             STRING COMMENT '员工ID',
    `name`           STRING COMMENT '员工姓名',
    `type`           STRING comment '员工类型：1.业务经办 2.风控员 3.风控经理 4.信审经办 5.一级评审员/一级评审加签人 6.二级评审员 7.总经理/分管总',
    `department3_id` STRING comment '三级部门ID'
) COMMENT '员工维度表'
    PARTITIONED BY (`dt` STRING)
    STORED AS ORC
    LOCATION '/warehouse/financial_lease/dim/dim_employee_full/'
    TBLPROPERTIES ('orc.compress' = 'snappy');

--行业维度表
DROP TABLE IF EXISTS dim_industry_full;
CREATE EXTERNAL TABLE IF NOT EXISTS dim_industry_full
(
    `industry3_id`   STRING COMMENT '三级行业ID',
    `industry3_name` STRING COMMENT '三级行业名称',
    `industry2_id`   STRING COMMENT '二级行业ID',
    `industry2_name` STRING COMMENT '二级行业名称',
    `industry1_id`   STRING COMMENT '一级行业ID',
    `industry1_name` STRING COMMENT '一级行业名称'
) COMMENT '行业维度表'
    PARTITIONED BY (`dt` STRING)
    STORED AS ORC
    LOCATION '/warehouse/financial_lease/dim/dim_industry_full/'
    TBLPROPERTIES ('orc.compress' = 'snappy');
```

### 数据装载
1.部门维度表：

首先查看ods层部门表，一共有三个level：

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1708329294013-3b008bac-5ee0-4029-ac8b-c595a4b94ddf.png)

因此需要通过join来获取到不同等级部门之间的对应关系

```plsql
insert overwrite table dim_department_full
    partition (dt = '2023-05-09')
select department3_id,
       department3_name,
       department2_id,
       department2_name,
       department1_id,
       department1_name
from (select id              department3_id,
             department_name department3_name,
             superior_department_id
      from ods_department_full
      where dt = '2023-05-09'
        and department_level = '3') dp3
         left join (
    select id              department2_id,
           department_name department2_name,
           superior_department_id
    from ods_department_full
    where dt = '2023-05-09'
      and department_level = '2'
) dp2 on dp3.superior_department_id = department2_id
         left join (
    select id              department1_id,
           department_name department1_name
    from ods_department_full
    where dt = '2023-05-09'
      and department_level = '1'
) dp1 on dp2.superior_department_id = department1_id;
```

结果如下：

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1708329529234-93ec4f9d-7f1f-4735-a6dc-a1b64f3aa369.png)

---

2.员工维度表：

比较简单，将ods层中的相关数据拿出了即可

```plsql
insert overwrite table dim_employee_full
    partition (dt = '2023-05-09')
select id,
       name,
       type,
       department_id department3_id
from ods_employee_full
where dt = '2023-05-09';
```

结果如下：

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1708329628389-496c71ff-6c17-4154-a40b-9db50f5829a4.png)

---

3.行业维度表：

```plsql
insert overwrite table dim_industry_full
    partition (dt = '2023-05-09')
select industry3_id,
       industry3_name,
       industry2_id,
       industry2_name,
       industry1_id,
       industry1_name
from (select id            industry3_id,
             industry_name industry3_name,
             superior_industry_id
      from ods_industry_full
      where dt = '2023-05-09'
        and industry_level = '3') ind3
         left join
     (select id            industry2_id,
             industry_name industry2_name,
             superior_industry_id
      from ods_industry_full
      where dt = '2023-05-09'
        and industry_level = '2') ind2
     on ind3.superior_industry_id = industry2_id
         left join
     (select id            industry1_id,
             industry_name industry1_name,
             superior_industry_id
      from ods_industry_full
      where dt = '2023-05-09'
        and industry_level = '1') ind1
     on ind2.superior_industry_id = industry1_id;
```

逻辑与部门维度表相同

---

数据装载脚本：

```bash
#!/bin/bash

APP=financial_lease

if [ -n "$2" ] ;then
   do_date=$2
else 
   echo "请传入日期参数"
   exit
fi 

dim_department_full="
insert overwrite table ${APP}.dim_department_full
    partition (dt = '$do_date')
select department3_id,
       department3_name,
       department2_id,
       department2_name,
       department1_id,
       department1_name
from (select id              department3_id,
             department_name department3_name,
             superior_department_id
      from ${APP}.ods_department_full
      where dt = '$do_date'
        and department_level = '3') dp3
         left join (
    select id              department2_id,
           department_name department2_name,
           superior_department_id
    from ${APP}.ods_department_full
    where dt = '$do_date'
      and department_level = '2'
) dp2 on dp3.superior_department_id = department2_id
         left join (
    select id              department1_id,
           department_name department1_name
    from ${APP}.ods_department_full
    where dt = '$do_date'
      and department_level = '1'
) dp1 on dp2.superior_department_id = department1_id;
"

dim_employee_full="
insert overwrite table ${APP}.dim_employee_full
    partition (dt = '$do_date')
select id,
       name,
       type,
       department_id department3_id
from ${APP}.ods_employee_full
where dt = '$do_date';
"

dim_industry_full="
insert overwrite table ${APP}.dim_industry_full
    partition (dt = '$do_date')
select industry3_id,
       industry3_name,
       industry2_id,
       industry2_name,
       industry1_id,
       industry1_name
from (select id            industry3_id,
             industry_name industry3_name,
             superior_industry_id
      from ${APP}.ods_industry_full
      where dt = '$do_date'
        and industry_level = '3') ind3
         left join
     (select id            industry2_id,
             industry_name industry2_name,
             superior_industry_id
      from ${APP}.ods_industry_full
      where dt = '$do_date'
        and industry_level = '2') ind2
     on ind3.superior_industry_id = industry2_id
         left join
     (select id            industry1_id,
             industry_name industry1_name,
             superior_industry_id
      from ${APP}.ods_industry_full
      where dt = '$do_date'
        and industry_level = '1') ind1
     on ind2.superior_industry_id = industry1_id;
"



case $1 in
dim_department_full | dim_employee_full | dim_industry_full)
    hive -e "$i"
    ;;
"all")
    hive -e " $dim_employee_full$dim_business_partner_full$dim_industry_full"
    ;;
esac
```

就是将数据装置sql写到变量里，根据传参调用即可

## DWD层
DWD层设计要点：

（1）DWD层的设计依据是维度建模理论，该层存储维度模型的事实表。

（2）DWD层的数据存储格式为orc列式存储+snappy压缩。

（3）DWD层表名的命名规范为dwd_数据域_表名_单分区增量全量标识（inc/full）

### 建表
DWD层只有一张表：`dwd_financial_lease_flow_acc`

该表为累积型快照事实表，记录业务状态

```plsql
DROP TABLE IF EXISTS dwd_financial_lease_flow_acc;
CREATE EXTERNAL TABLE IF NOT EXISTS dwd_financial_lease_flow_acc
(
  `id` STRING COMMENT '授信表记录编号',
  `lease_organization` STRING COMMENT '业务方向',
  `business_partner_id` STRING COMMENT '客户ID（申请人）',
  `business_partner_name` STRING COMMENT '客户姓名',
  `industry3_id` STRING COMMENT '三级行业ID',
  `salesman_id` STRING COMMENT '业务经办ID',
  `credit_audit_id` STRING COMMENT '信审经办ID',
  `create_time` STRING COMMENT '申请发起时间',
  `undistributed_time` STRING COMMENT '风控审核通过时间',
  `risk_manage_refused_time` STRING COMMENT	'风控审核拒绝时间',
  `credit_audit_distributed_time` STRING  COMMENT '信审经办分配时间',
  `credit_audit_approving_time` STRING  COMMENT '信审经办审核通过时间',
  `feed_back_time` STRING COMMENT '业务反馈提交时间',
  `first_level_review_approving_time` STRING COMMENT '一级评审人/加签人审核通过时间',
  `second_level_review_approving_time` STRING COMMENT '二级评审人审核通过时间',
  `project_review_meeting_approving_time` STRING COMMENT '项目评审会审核通过时间',
  `general_manager_review_approving_time` STRING COMMENT '总经理/分管总审核通过时间',
  `reply_review_approving_time` STRING COMMENT '批复通过时间',
  `credit_create_time` STRING COMMENT '新增授信时间',
  `credit_occupy_time` STRING COMMENT '完成授信占用时间',
  `contract_produce_time` STRING COMMENT '完成合同制作时间',
  `signed_time` STRING COMMENT '完成签约时间',
  `execution_time` STRING COMMENT '起租时间',
  `rejected_time` STRING COMMENT '拒绝时间',
  `cancel_time` STRING COMMENT '客户取消申请时间',
  `credit_amount` decimal(16,2) COMMENT '申请授信金额',
  `credit_reply_amount` decimal(16,2) COMMENT '批复授信金额',
  `credit_real_amount` decimal(16,2) COMMENT '实际授信金额'
) COMMENT '审批域授信审批流程累积型快照事实表'
	PARTITIONED BY (`dt` STRING)
	STORED AS ORC
	LOCATION '/warehouse/financial_lease/dwd/dwd_financial_lease_flow_acc/'
	TBLPROPERTIES('orc.compress' = 'snappy');
```

该表以dt（时间）为分区，数据流向如下：

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1708330093211-8771f4b6-f147-4172-9454-b6842585ad74.png)

对于历史全量数据和当日新增及变化数据分别进行处理，存入不同的分区内，需要注意的是，对于未完成申请的分区，统一存入分区`dt=9999-12-31`中



### 数据装载
首日装载：

```plsql
set hive.exec.dynamic.partition.mode=nonstrict;

insert overwrite table dwd_financial_lease_flow_acc partition (dt)
select
    id,
    max(lease_organization),
    max(business_partner_id),
    max(business_partner_name),
    max(industry3_id),
    max(salesman_id),
    max(credit_audit_id),
    max(create_time),
    max(undistributed_time),
    max(risk_manage_refused_time),
    max(credit_audit_distributed_time),
    max(credit_audit_approving_time),
    max(feed_back_time),
    max(first_level_review_approving_time),
    max(second_level_review_approving_time),
    max(project_review_meeting_approving_time),
    max(general_manager_review_approving_time),
    max(reply_review_approving_time),
    max(credit_create_time),
    max(credit_occupy_time),
    max(contract_produce_time),
    max(signed_time),
    max(execution_time),
    max(rejected_time),
    max(cancel_time),
    max(credit_amount),
    max(credit_reply_amount),
    max(credit_real_amount),
    date_format(if(max(execution_time) is not null , max(execution_time),
        if(max(rejected_time) is not null, max(rejected_time) ,
            if(max(cancel_time) is not null, max(cancel_time),'9999-12-31'))),'yyyy-MM-dd') dt
from (
     select
        cf.id,
        lease_organization,
        cf.business_partner_id business_partner_id,
        bp.business_partner_name business_partner_name,
        cf.industry_id industry3_id,
        salesman_id,
        if(cfs.status='5' and cfs.action_taken='1',cfs.employee_id,null) credit_audit_id,
        cf.create_time create_time,
        if(cfs.status='3' and cfs.action_taken='1',cfs.create_time,null) undistributed_time,
        if(cfs.status='2' and cfs.action_taken='2',cfs.create_time,null) risk_manage_refused_time,
        if(cfs.status='4',cfs.create_time,null) credit_audit_distributed_time,
        if(cfs.status='5' and cfs.action_taken='1',cfs.create_time,null) credit_audit_approving_time,
        if(cfs.status='7' ,cfs.create_time,null) feed_back_time,
        if(cfs.status='8' and cfs.action_taken='1',cfs.create_time,null) first_level_review_approving_time,
        if(cfs.status='10' and cfs.action_taken='1',cfs.create_time,null) second_level_review_approving_time,
        if(cfs.status='12' and cfs.action_taken='1',cfs.create_time,null) project_review_meeting_approving_time,
        if(cfs.status='14' and cfs.action_taken='1',cfs.create_time,null) general_manager_review_approving_time,
        if(cfs.status='16' and cfs.action_taken='1',cfs.create_time,null) reply_review_approving_time,
        cre.create_time credit_create_time,
        credit_occupy_time,
        contract_produce_time,
        signed_time,
        execution_time,
        if(cfs.status='20' ,cfs.create_time,null) rejected_time,
        if(cfs.status='21' ,cfs.create_time,if(cre.cancel_time is not null,cre.cancel_time,con.cancel_time)) cancel_time,
        cf.credit_amount,
        rep.credit_amount credit_reply_amount,
        cre.credit_amount credit_real_amount
from (
     -- 金融审批表
    select
        data.id,
        data.create_time,
        data.update_time,
        data.credit_amount,
        data.lease_organization,
        data.status,
        data.business_partner_id,
        data.credit_id,
        data.industry_id,
        data.reply_id,
        data.salesman_id
    from ods_credit_facility_inc
    where dt='2023-05-09'
    and type='bootstrap-insert'
    )cf
    left join (
        -- 金融合伙人
        select
            id business_partner_id,
            name business_partner_name
        from ods_business_partner_full
        where dt='2023-05-09'
    )bp
    on cf.business_partner_id=bp.business_partner_id
    left join (
        -- 审批状态表
        select
            data.create_time,
            data.action_taken,
            data.status,
            data.credit_facility_id,
            data.employee_id,
            data.signatory_id
        from ods_credit_facility_status_inc
        where dt='2023-05-09'
        and type='bootstrap-insert'
    )cfs
    on cf.id=cfs.credit_facility_id
    left join (
        -- 客户回复表  -> 添加回复金额 不为null 说明客户同意
        select
            data.create_time,
            data.update_time,
            data.credit_amount,
            data.irr,
            data.period,
            data.credit_facility_id
        from ods_reply_inc
        where dt='2023-05-09'
        and type='bootstrap-insert'
    )rep
    on cf.id=rep.credit_facility_id
    left join (
        -- 开启授信
        select
            data.id,
            data.create_time,
            data.update_time,
            data.cancel_time,
            data.contract_produce_time,
            data.credit_amount,
            data.credit_occupy_time,
            data.status,
            data.contract_id,
            data.credit_facility_id
        from ods_credit_inc
        where dt='2023-05-09'
        and type='bootstrap-insert'
    )cre
    on cf.credit_id=cre.id
    left join (
        -- 合同表
        select
            data.id,
            data.execution_time,
            data.signed_time,
            if(data.status='4',data.update_time,null) cancel_time,
            data.credit_id
        from ods_contract_inc
        where dt='2023-05-09'
        and type='bootstrap-insert'
    )con
    on cre.contract_id=con.id
)t1
group by id;
```

简单的逻辑就是，根据`dwd_financial_lease_flow_acc`表中所需要的内容，分别从ods层的各表中通过join获取想要获得的数据；例如审批状态表，其中记录了不同审批状态的创建时间，也就是说，`dwd_financial_lease_flow_acc`表中一行数据的多个字段，需要根据审批状态从ods层的审批状态表中查询出多条数据组合而成，从而形成完整的审批流程

在该表中分区字段为审批流程结束的时间：

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1708332843028-c4acfc66-da1f-4ebb-85d4-24aa29dc8254.png)

在hive中通过date_format函数来从起租时间、拒绝时间、客户取消申请时间（三者均代表这审批流程的结束）中选择一个不为null的时间来作为事件结束时间：

```plsql
date_format(if(max(execution_time) is not null , max(execution_time),
               if(max(rejected_time) is not null, max(rejected_time) ,
           if(max(cancel_time) is not null, max(cancel_time),'9999-12-31'))),'yyyy-MM-dd')
```

如果都为null，则说明仍在审批流程中，因此放入`9999-12-31`分区中

---

每日装载：

```plsql
set hive.exec.dynamic.partition.mode=nonstrict;
-- 关闭hive优化解决兼容性问题
set hive.cbo.enable=false;
set hive.vectorized.execution.enabled=false;

insert overwrite table dwd_financial_lease_flow_acc partition (dt)
select
     id,
    max(lease_organization),
    max(business_partner_id),
    max(business_partner_name),
    max(industry3_id),
    max(salesman_id),
    max(credit_audit_id),
    max(create_time),
    max(undistributed_time),
    max(risk_manage_refused_time),
    max(credit_audit_distributed_time),
    max(credit_audit_approving_time),
    max(feed_back_time),
    max(first_level_review_approving_time),
    max(second_level_review_approving_time),
    max(project_review_meeting_approving_time),
    max(general_manager_review_approving_time),
    max(reply_review_approving_time),
    max(credit_create_time),
    max(credit_occupy_time),
    max(contract_produce_time),
    max(signed_time),
    max(execution_time),
    max(rejected_time),
    max(cancel_time),
    max(credit_amount),
    max(credit_reply_amount),
    max(credit_real_amount),
    date_format(if(max(execution_time) is not null , max(execution_time),
        if(max(rejected_time) is not null, max(rejected_time) ,
            if(max(cancel_time) is not null, max(cancel_time),'9999-12-31'))),'yyyy-MM-dd') dt
from (
     select
        cf.id,
        lease_organization,
        cf.business_partner_id business_partner_id,
        bp.business_partner_name business_partner_name,
        cf.industry3_id industry3_id,
        salesman_id,
        if(cfs.status='5' and cfs.action_taken='1',cfs.employee_id,credit_audit_id) credit_audit_id,
        cf.create_time create_time,
        if(cfs.status='3' and cfs.action_taken='1',cfs.create_time,undistributed_time) undistributed_time,
        if(cfs.status='2' and cfs.action_taken='2',cfs.create_time,risk_manage_refused_time) risk_manage_refused_time,
        if(cfs.status='4',cfs.create_time,credit_audit_distributed_time) credit_audit_distributed_time,
        if(cfs.status='5' and cfs.action_taken='1',cfs.create_time,credit_audit_approving_time) credit_audit_approving_time,
        if(cfs.status='7' ,cfs.create_time,feed_back_time) feed_back_time,
        if(cfs.status='8' and cfs.action_taken='1',cfs.create_time,first_level_review_approving_time) first_level_review_approving_time,
        if(cfs.status='10' and cfs.action_taken='1',cfs.create_time,second_level_review_approving_time) second_level_review_approving_time,
        if(cfs.status='12' and cfs.action_taken='1',cfs.create_time,project_review_meeting_approving_time) project_review_meeting_approving_time,
        if(cfs.status='14' and cfs.action_taken='1',cfs.create_time,general_manager_review_approving_time) general_manager_review_approving_time,
        if(cfs.status='16' and cfs.action_taken='1',cfs.create_time,reply_review_approving_time) reply_review_approving_time,
        nvl(credit_create_time,cre.create_time ) credit_create_time,
        nvl(cf.credit_occupy_time,cre.credit_occupy_time) credit_occupy_time,
        nvl(cf.contract_produce_time,cre.contract_produce_time) contract_produce_time,
        nvl(cf.signed_time,con.signed_time) signed_time,
        con.execution_time execution_time,
        if(cfs.status='20' ,cfs.create_time,null) rejected_time,
        if(cfs.status='21' ,cfs.create_time,if(cre.cancel_time is not null,cre.cancel_time,con.cancel_time)) cancel_time,
        cf.credit_amount,
        rep.credit_amount credit_reply_amount,
        cre.credit_amount credit_real_amount
    from (
         -- 合并截止到前一天的9999-12-31数据
        select
            id,
            lease_organization,
            business_partner_id,
            business_partner_name,
            industry3_id,
            salesman_id,
            credit_audit_id,
            create_time,
            undistributed_time,
            risk_manage_refused_time,
            credit_audit_distributed_time,
            credit_audit_approving_time,
            feed_back_time,
            first_level_review_approving_time,
            second_level_review_approving_time,
            project_review_meeting_approving_time,
            general_manager_review_approving_time,
            reply_review_approving_time,
            credit_create_time,
            credit_occupy_time,
            contract_produce_time,
            signed_time,
            execution_time,
            rejected_time,
            cancel_time,
            credit_amount,
            credit_reply_amount,
            credit_real_amount,
            null reply_id,
            null credit_id
        from dwd_financial_lease_flow_acc
        where dt='9999-12-31'
        union
        --当天的新增审批数据
        select
            data.id id,
            data.lease_organization,
            data.business_partner_id,
            null business_partner_name,
            data.industry_id industry3_id,
            data.salesman_id,
            null credit_audit_id,
            null create_time,
            null undistributed_time,
            null risk_manage_refused_time,
            null credit_audit_distributed_time,
            null credit_audit_approving_time,
            null feed_back_time,
            null first_level_review_approving_time,
            null second_level_review_approving_time,
            null project_review_meeting_approving_time,
            null general_manager_review_approving_time,
            null reply_review_approving_time,
            null credit_create_time,
            null credit_occupy_time,
            null contract_produce_time,
            null signed_time,
            null execution_time,
            null rejected_time,
            null cancel_time,
            data.credit_amount,
            null credit_reply_amount,
            null credit_real_amount,
            data.reply_id reply_id,
            data.credit_id credit_id
        from ods_credit_facility_inc
        where dt='2023-05-10'
        and type='insert'
    )cf
        -- 之后再join后续可能出现的审批状态  最后根据是否完成写入到最终的分区中
        left join (
            -- 金融合伙人
            select
                id business_partner_id,
                name business_partner_name
            from ods_business_partner_full
            where dt='2023-05-10'
        )bp
        on cf.business_partner_id=bp.business_partner_id
        left join (
            -- 审批状态表
            select
                data.create_time,
                data.action_taken,
                data.status,
                data.credit_facility_id,
                data.employee_id,
                data.signatory_id
            from ods_credit_facility_status_inc
            where dt='2023-05-10'
            and type='insert'
        )cfs
        on cf.id=cfs.credit_facility_id
        left join (
            -- 客户回复表  -> 添加回复金额 不为null 说明客户同意
            select
                data.create_time,
                data.update_time,
                data.credit_amount,
                data.irr,
                data.period,
                data.credit_facility_id
            from ods_reply_inc
            where dt='2023-05-10'
            and type='insert'
        )rep
        on cf.id=rep.credit_facility_id
        left join (
            -- 开启授信
            select
                data.id,
                data.create_time,
                data.update_time,
                data.cancel_time,
                data.contract_produce_time,
                data.credit_amount,
                data.credit_occupy_time,
                data.status,
                data.contract_id,
                data.credit_facility_id
            from ods_credit_inc
            where dt='2023-05-10'
        )cre
        on cf.credit_id=cre.id
        left join (
            -- 合同表
            select
                data.id,
                data.execution_time,
                data.signed_time,
                if(data.status='4',data.update_time,null) cancel_time,
                data.credit_id
            from ods_contract_inc
            where dt='2023-05-10'
        )con
        on cre.contract_id=con.id
)t1
group by id;
```

每日装载的数据由两部分组成：

1. 合并截止到前一天的9999-12-31数据
2. 当天的新增审批数据

由于当天新增的审批数据还没开始审批流程，因此大部分时间相关的字段都为null

其余的数据内容和首日装载基本一致

---

首日装载脚本：

```bash
#!/bin/bash

APP=financial_lease
if [[ -n "$2" ]]; then
	do_date=$2
else
	do_date=`date -d '-1 day' +%F`
fi

dwd_financial_lease_flow_acc="
set hive.exec.dynamic.partition.mode=nonstrict;
insert overwrite table ${APP}.dwd_financial_lease_flow_acc partition (dt)
select
    id,
    max(lease_organization),
    max(business_partner_id),
    max(business_partner_name),
    max(industry3_id),
    max(salesman_id),
    max(credit_audit_id),
    max(create_time),
    max(undistributed_time),
    max(risk_manage_refused_time),
    max(credit_audit_distributed_time),
    max(credit_audit_approving_time),
    max(feed_back_time),
    max(first_level_review_approving_time),
    max(second_level_review_approving_time),
    max(project_review_meeting_approving_time),
    max(general_manager_review_approving_time),
    max(reply_review_approving_time),
    max(credit_create_time),
    max(credit_occupy_time),
    max(contract_produce_time),
    max(signed_time),
    max(execution_time),
    max(rejected_time),
    max(cancel_time),
    max(credit_amount),
    max(credit_reply_amount),
    max(credit_real_amount),
    date_format(if(max(execution_time) is not null , max(execution_time),
        if(max(rejected_time) is not null, max(rejected_time) ,
            if(max(cancel_time) is not null, max(cancel_time),'9999-12-31'))),'yyyy-MM-dd') dt
from (
     select
        cf.id,
        lease_organization,
        cf.business_partner_id business_partner_id,
        bp.business_partner_name business_partner_name,
        cf.industry_id industry3_id,
        salesman_id,
        if(cfs.status='5' and cfs.action_taken='1',cfs.employee_id,null) credit_audit_id,
        cf.create_time create_time,
        if(cfs.status='3' and cfs.action_taken='1',cfs.create_time,null) undistributed_time,
        if(cfs.status='2' and cfs.action_taken='2',cfs.create_time,null) risk_manage_refused_time,
        if(cfs.status='4',cfs.create_time,null) credit_audit_distributed_time,
        if(cfs.status='5' and cfs.action_taken='1',cfs.create_time,null) credit_audit_approving_time,
        if(cfs.status='7' ,cfs.create_time,null) feed_back_time,
        if(cfs.status='8' and cfs.action_taken='1',cfs.create_time,null) first_level_review_approving_time,
        if(cfs.status='10' and cfs.action_taken='1',cfs.create_time,null) second_level_review_approving_time,
        if(cfs.status='12' and cfs.action_taken='1',cfs.create_time,null) project_review_meeting_approving_time,
        if(cfs.status='14' and cfs.action_taken='1',cfs.create_time,null) general_manager_review_approving_time,
        if(cfs.status='16' and cfs.action_taken='1',cfs.create_time,null) reply_review_approving_time,
        cre.create_time credit_create_time,
        credit_occupy_time,
        contract_produce_time,
        signed_time,
        execution_time,
        if(cfs.status='20' ,cfs.create_time,null) rejected_time,
        if(cfs.status='21' ,cfs.create_time,if(cre.cancel_time is not null,cre.cancel_time,con.cancel_time)) cancel_time,
        cf.credit_amount,
        rep.credit_amount credit_reply_amount,
        cre.credit_amount credit_real_amount
from (
    select
        data.id,
        data.create_time,
        data.update_time,
        data.credit_amount,
        data.lease_organization,
        data.status,
        data.business_partner_id,
        data.credit_id,
        data.industry_id,
        data.reply_id,
        data.salesman_id
    from ${APP}.ods_credit_facility_inc
    where dt='${do_date}'
    and type='bootstrap-insert'
    )cf
    left join (
        select
            id business_partner_id,
            name business_partner_name
        from ${APP}.ods_business_partner_full
        where dt='${do_date}'
    )bp
    on cf.business_partner_id=bp.business_partner_id
    left join (
        select
            data.create_time,
            data.action_taken,
            data.status,
            data.credit_facility_id,
            data.employee_id,
            data.signatory_id
        from ${APP}.ods_credit_facility_status_inc
        where dt='${do_date}'
        and type='bootstrap-insert'
    )cfs
    on cf.id=cfs.credit_facility_id
    left join (
        select
            data.create_time,
            data.update_time,
            data.credit_amount,
            data.irr,
            data.period,
            data.credit_facility_id
        from ${APP}.ods_reply_inc
        where dt='${do_date}'
        and type='bootstrap-insert'
    )rep
    on cf.id=rep.credit_facility_id
    left join (
        select
            data.id,
            data.create_time,
            data.update_time,
            data.cancel_time,
            data.contract_produce_time,
            data.credit_amount,
            data.credit_occupy_time,
            data.status,
            data.contract_id,
            data.credit_facility_id
        from ${APP}.ods_credit_inc
        where dt='${do_date}'
        and type='bootstrap-insert'
    )cre
    on cf.credit_id=cre.id
    left join (
        select
            data.id,
            data.execution_time,
            data.signed_time,
            if(data.status='4',data.update_time,null) cancel_time,
            data.credit_id
        from ${APP}.ods_contract_inc
        where dt='${do_date}'
        and type='bootstrap-insert'
    )con
    on cre.contract_id=con.id
)t1
group by id;
"

case $1 in
	"dwd_financial_lease_flow_acc" )
	hive -e "$dwd_financial_lease_flow_acc"
		;;
	"all" )
	hive -e "$dwd_financial_lease_flow_acc"
		;;
esac
```

每日装载脚本：

```bash
#!/bin/bash

APP=financial_lease
if [[ -n "$2" ]]; then
	do_date=$2
else
	do_date=`date -d '-1 day' +%F`
fi

dwd_financial_lease_flow_acc="
set hive.exec.dynamic.partition.mode=nonstrict;
set hive.cbo.enable=false;
set hive.vectorized.execution.enabled=false;

insert overwrite table ${APP}.dwd_financial_lease_flow_acc partition(dt)
select
     id,
    max(lease_organization),
    max(business_partner_id),
    max(business_partner_name),
    max(industry3_id),
    max(salesman_id),
    max(credit_audit_id),
    max(create_time),
    max(undistributed_time),
    max(risk_manage_refused_time),
    max(credit_audit_distributed_time),
    max(credit_audit_approving_time),
    max(feed_back_time),
    max(first_level_review_approving_time),
    max(second_level_review_approving_time),
    max(project_review_meeting_approving_time),
    max(general_manager_review_approving_time),
    max(reply_review_approving_time),
    max(credit_create_time),
    max(credit_occupy_time),
    max(contract_produce_time),
    max(signed_time),
    max(execution_time),
    max(rejected_time),
    max(cancel_time),
    max(credit_amount),
    max(credit_reply_amount),
    max(credit_real_amount),
    date_format(if(max(execution_time) is not null , max(execution_time),
        if(max(rejected_time) is not null, max(rejected_time) ,
            if(max(cancel_time) is not null, max(cancel_time),'9999-12-31'))),'yyyy-MM-dd') dt
from (
     select
        cf.id,
        lease_organization,
        cf.business_partner_id business_partner_id,
        bp.business_partner_name business_partner_name,
        cf.industry3_id industry3_id,
        salesman_id,
        if(cfs.status='5' and cfs.action_taken='1',cfs.employee_id,credit_audit_id) credit_audit_id,
        cf.create_time create_time,
        if(cfs.status='3' and cfs.action_taken='1',cfs.create_time,undistributed_time) undistributed_time,
        if(cfs.status='2' and cfs.action_taken='2',cfs.create_time,risk_manage_refused_time) risk_manage_refused_time,
        if(cfs.status='4',cfs.create_time,credit_audit_distributed_time) credit_audit_distributed_time,
        if(cfs.status='5' and cfs.action_taken='1',cfs.create_time,credit_audit_approving_time) credit_audit_approving_time,
        if(cfs.status='7' ,cfs.create_time,feed_back_time) feed_back_time,
        if(cfs.status='8' and cfs.action_taken='1',cfs.create_time,first_level_review_approving_time) first_level_review_approving_time,
        if(cfs.status='10' and cfs.action_taken='1',cfs.create_time,second_level_review_approving_time) second_level_review_approving_time,
        if(cfs.status='12' and cfs.action_taken='1',cfs.create_time,project_review_meeting_approving_time) project_review_meeting_approving_time,
        if(cfs.status='14' and cfs.action_taken='1',cfs.create_time,general_manager_review_approving_time) general_manager_review_approving_time,
        if(cfs.status='16' and cfs.action_taken='1',cfs.create_time,reply_review_approving_time) reply_review_approving_time,
        nvl(credit_create_time,cre.create_time ) credit_create_time,
        nvl(cf.credit_occupy_time,cre.credit_occupy_time) credit_occupy_time,
        nvl(cf.contract_produce_time,cre.contract_produce_time) contract_produce_time,
        nvl(cf.signed_time,con.signed_time) signed_time,
        con.execution_time execution_time,
        if(cfs.status='20' ,cfs.create_time,null) rejected_time,
        if(cfs.status='21' ,cfs.create_time,if(cre.cancel_time is not null,cre.cancel_time,con.cancel_time)) cancel_time,
        cf.credit_amount,
        rep.credit_amount credit_reply_amount,
        cre.credit_amount credit_real_amount
    from (
        select
            id,
            lease_organization,
            business_partner_id,
            business_partner_name,
            industry3_id,
            salesman_id,
            credit_audit_id,
            create_time,
            undistributed_time,
            risk_manage_refused_time,
            credit_audit_distributed_time,
            credit_audit_approving_time,
            feed_back_time,
            first_level_review_approving_time,
            second_level_review_approving_time,
            project_review_meeting_approving_time,
            general_manager_review_approving_time,
            reply_review_approving_time,
            credit_create_time,
            credit_occupy_time,
            contract_produce_time,
            signed_time,
            execution_time,
            rejected_time,
            cancel_time,
            credit_amount,
            credit_reply_amount,
            credit_real_amount,
            null reply_id,
            null credit_id
        from ${APP}.dwd_financial_lease_flow_acc
        where dt='9999-12-31'
        union
        select
            data.id id,
            data.lease_organization,
            data.business_partner_id,
            null business_partner_name,
            data.industry_id industry3_id,
            data.salesman_id,
            null credit_audit_id,
            null create_time,
            null undistributed_time,
            null risk_manage_refused_time,
            null credit_audit_distributed_time,
            null credit_audit_approving_time,
            null feed_back_time,
            null first_level_review_approving_time,
            null second_level_review_approving_time,
            null project_review_meeting_approving_time,
            null general_manager_review_approving_time,
            null reply_review_approving_time,
            null credit_create_time,
            null credit_occupy_time,
            null contract_produce_time,
            null signed_time,
            null execution_time,
            null rejected_time,
            null cancel_time,
            data.credit_amount,
            null credit_reply_amount,
            null credit_real_amount,
            data.reply_id reply_id,
            data.credit_id credit_id
        from ${APP}.ods_credit_facility_inc
        where dt='${do_date}'
        and type='insert'
    )cf
        left join (
            select
                id business_partner_id,
                name business_partner_name
            from ${APP}.ods_business_partner_full
            where dt='${do_date}'
        )bp
        on cf.business_partner_id=bp.business_partner_id
        left join (
            select
                data.create_time,
                data.action_taken,
                data.status,
                data.credit_facility_id,
                data.employee_id,
                data.signatory_id
            from ${APP}.ods_credit_facility_status_inc
            where dt='${do_date}'
            and type='insert'
        )cfs
        on cf.id=cfs.credit_facility_id
        left join (
            select
                data.create_time,
                data.update_time,
                data.credit_amount,
                data.irr,
                data.period,
                data.credit_facility_id
            from ${APP}.ods_reply_inc
            where dt='${do_date}'
            and type='insert'
        )rep
        on cf.id=rep.credit_facility_id
        left join (
            select
                data.id,
                data.create_time,
                data.update_time,
                data.cancel_time,
                data.contract_produce_time,
                data.credit_amount,
                data.credit_occupy_time,
                data.status,
                data.contract_id,
                data.credit_facility_id
            from ${APP}.ods_credit_inc
            where dt='${do_date}'
        )cre
        on cf.credit_id=cre.id
        left join (
            select
                data.id,
                data.execution_time,
                data.signed_time,
                if(data.status='4',data.update_time,null) cancel_time,
                data.credit_id
            from ${APP}.ods_contract_inc
            where dt='${do_date}'
        )con
        on cre.contract_id=con.id
)t1
group by id;
"

case $1 in
	"dwd_financial_lease_flow_acc" )
	hive -e "$dwd_financial_lease_flow_acc"
		;;
	"all" )
	hive -e "$dwd_financial_lease_flow_acc"
		;;
esac
```

## ADS层
### 待审/在审项目综合统计
#### 需求说明
| **统计粒度** | 指标 | 说明 |
| --- | --- | --- |
| **-****-** | 截至当日处于新建状态项目数 | 申请已发起，正交由风控员审核，未得出风控审核结果的项目数 |
| **-****-** | 截至当日处于新建状态项目申请金额 | 略 |
| **-****-** | 截至当日处于未达风控状态项目数 | 未通过风控员审核，正交由风控经理审核，未得出最终风控结论的项目数 |
| **-****-** | 截至当日处于未达风控状态项目申请金额 | 略 |
| **-****-** | 截至当日处于信审经办审核通过状态项目数 | 信审经办审核通过，业务经办尚未提交业务反馈的项目数 |
| **-****-** | 截至当日处于信审经办审核通过状态项目申请金额 | 略 |
| **-****-** | 截至当日处于已提交业务反馈状态项目数 | 业务经办已提交业务反馈，正交由一级评审员及一级评审加签人审核，尚未得出一级评审结论的项目数 |
| **-****-** | 截至当日处于已提交业务反馈状态项目申请金额 | 略 |
| **-****-** | 截至当日处于一级评审通过状态项目数 | 一级评审已通过，正交由二级评审员审核，尚未得出二级评审结论的项目数 |
| **-****-** | 截至当日处于一级评审通过状态项目申请金额 | 略。 |
| **-****-** | 截至当日处于二级评审通过状态项目数 | 二级评审已通过，正由项目评审会审核，尚未得出相应评审结论的项目数 |
| **-****-** | 截至当日处于二级评审通过状态项目申请金额 | 略 |
| **-****-** | 截至当日处于项目评审会审核通过状态项目数 | 项目评审会审核通过，正交由总经理/分管总审核，尚未得出相应评审结论的项目数 |
| **-****-** | 截至当日处于项目评审会审核通过状态项目申请金额 | 略 |
| **-****-** | 截至当日处于总经理/分管总审核通过状态项目数 | 总经理/分管总审核通过，批复文件尚未生成的项目数 |
| **-****-** | 截至当日处于总经理/分管总审核通过状态项目申请金额 | 略 |
| **-****-** | 截至当日处于已出具批复状态项目数 | 批复阶段审核通过，生成批复文件，包含了具体的批复金额、条款等，尚未新增授信的项目数 |
| **-****-** | 截至当日处于已出具批复状态项目申请金额 | 略 |
| **-****-** | 截至当日处于已出具批复状态项目批复金额 | 略 |


#### 建表
```plsql
DROP TABLE IF EXISTS ads_unfinished_audit_stats;
CREATE EXTERNAL TABLE IF NOT EXISTS ads_unfinished_audit_stats(
    `dt` STRING COMMENT '统计日期',
    `created_project_count` BIGINT COMMENT '新建状态项目数',
    `created_project_amount` DECIMAL(16,2) COMMENT '新建状态项目申请金额',
    `risk_control_not_approved_count` BIGINT COMMENT '未达风控状态项目数',
    `risk_control_not_approved_amount` DECIMAL(16,2) COMMENT '未达风控状态项目申请金额',
    `credit_audit_approved_count` BIGINT COMMENT '信审经办审核通过状态项目数',
    `credit_audit_approved_amount` DECIMAL(16,2) COMMENT '信审经办审核通过状态项目申请金额',
    `feedback_submitted_count` BIGINT COMMENT '已提交业务反馈状态项目数',
    `feedback_submitted_amount` DECIMAL(16,2) COMMENT '已提交业务反馈状态项目申请金额',
    `level1_review_approved_count` BIGINT COMMENT '一级评审通过状态项目数',
    `level1_review_approved_amount` DECIMAL(16,2) COMMENT '一级评审通过状态项目申请金额',
    `level2_review_approved_count` BIGINT COMMENT '二级评审通过状态项目数',
    `level2_review_approved_amount` DECIMAL(16,2) COMMENT '二级评审通过状态项目申请金额',
    `review_meeting_approved_count` BIGINT COMMENT '项目评审会审核通过状态项目数',
    `review_meeting_approved_amount` DECIMAL(16,2) COMMENT '项目评审会审核通过状态项目申请金额',
    `general_manager_approved_count` BIGINT COMMENT '总经理/分管总审核通过状态项目数',
    `general_manager_approved_amount` DECIMAL(16,2) COMMENT '总经理/分管总审核通过状态项目申请金额',
    `reply_issued_count` BIGINT COMMENT '出具批复状态项目数',
    `reply_issued_apply_amount` DECIMAL(16,2) COMMENT '出具批复状态项目申请金额',
    `reply_issued_reply_amount` DECIMAL(16,2) COMMENT '出具批复状态项目批复金额'
) COMMENT '待审/在审项目综合统计'
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
    LOCATION '/warehouse/financial_lease/ads/ads_unfinished_audit_stats'
    TBLPROPERTIES ('compression.codec' = 'org.apache.hadoop.io.compress.GzipCodec');
```

#### 数据装载
```plsql
insert overwrite table ads_unfinished_audit_stats
select dt,
       created_project_count,
       created_project_amount,
       risk_control_not_approved_count,
       risk_control_not_approved_amount,
       credit_audit_approved_count,
       credit_audit_approved_amount,
       feedback_submitted_count,
       feedback_submitted_amount,
       level1_review_approved_count,
       level1_review_approved_amount,
       level2_review_approved_count,
       level2_review_approved_amount,
       review_meeting_approved_count,
       review_meeting_approved_amount,
       general_manager_approved_count,
       general_manager_approved_amount,
       reply_issued_count,
       reply_issued_apply_amount,
       reply_issued_reply_amount
from ads_unfinished_audit_stats
union
select '2023-05-09'                                                                            dt,
       sum(if(undistributed_time is null and risk_manage_refused_time is null, 1, 0))          created_project_count,
       sum(if(undistributed_time is null and risk_manage_refused_time is null, credit_amount,
              0))                                                                              created_project_amount,
       sum(if(risk_manage_refused_time is not null and undistributed_time is null, 1,
              0))                                                                              risk_control_not_approved_count,
       sum(if(risk_manage_refused_time is not null and undistributed_time is null, credit_amount,
              0))                                                                              risk_control_not_approved_amount,
       sum(if(credit_audit_approving_time is not null and feed_back_time is null, 1,
              0))                                                                              credit_audit_approved_count,
       sum(if(credit_audit_approving_time is not null and feed_back_time is null, credit_amount,
              0))                                                                              credit_audit_approved_amount,
       sum(if(feed_back_time is not null and first_level_review_approving_time is null, 1, 0)) feedback_submitted_count,
       sum(if(feed_back_time is not null and first_level_review_approving_time is null, credit_amount,
              0))                                                                              feedback_submitted_amount,
       sum(if(first_level_review_approving_time is not null and second_level_review_approving_time is null, 1,
              0))                                                                              level1_review_approved_count,
       sum(if(first_level_review_approving_time is not null and second_level_review_approving_time is null,
              credit_amount,
              0))                                                                              level1_review_approved_amount,
       sum(if(second_level_review_approving_time is not null and project_review_meeting_approving_time is null, 1,
              0))                                                                              level2_review_approved_count,
       sum(if(second_level_review_approving_time is not null and project_review_meeting_approving_time is null,
              credit_amount,
              0))                                                                              level2_review_approved_amount,
       sum(if(project_review_meeting_approving_time is not null and general_manager_review_approving_time is null, 1,
              0))                                                                              review_meeting_approved_count,
       sum(if(project_review_meeting_approving_time is not null and general_manager_review_approving_time is null,
              credit_amount,
              0))                                                                              review_meeting_approved_amount,
       sum(if(general_manager_review_approving_time is not null and reply_review_approving_time is null, 1,
              0))                                                                              general_manager_approved_count,
       sum(if(general_manager_review_approving_time is not null and reply_review_approving_time is null, credit_amount,
              0))                                                                              general_manager_approved_amount,
       sum(if(reply_review_approving_time is not null and credit_create_time is null, 1, 0))   reply_issued_count,
       sum(if(reply_review_approving_time is not null and credit_create_time is null, credit_amount,
              0))                                                                              reply_issued_apply_amount,
       sum(if(reply_review_approving_time is not null and credit_create_time is null, credit_reply_amount,
              0))                                                                              reply_issued_reply_amount
from dwd_financial_lease_flow_acc
where dt = '9999-12-31';
```

通过时间来判断每条数据处于的状态，通过sum来进行聚合，获取项目数量以及金额总计

由于是待审/在审，因此一定未完成审批，所以数据都在`dt=9999-12-31`分区内

> 之所以使用union是为了避免overwrite时将之前的数据覆盖掉
>

### 待审/在审项目各业务方向统计
#### 需求说明
| **统计粒度** | 指标 | 说明 |
| --- | --- | --- |
| **业务方向** | 截至当日处于新建状态项目数 | 申请已发起，正交由风控员审核，未得出风控审核结果的项目数 |
| **业务方向** | 截至当日处于新建状态项目申请金额 | 略 |
| **业务方向** | 截至当日处于未达风控状态项目数 | 未通过风控员审核，正交由风控经理审核，未得出最终风控结论的项目数 |
| **业务方向** | 截至当日处于未达风控状态项目申请金额 | 略 |
| **业务方向** | 截至当日处于信审经办审核通过状态项目数 | 信审经办审核通过，业务经办尚未提交业务反馈的项目数 |
| **业务方向** | 截至当日处于信审经办审核通过状态项目申请金额 | 略 |
| **业务方向** | 截至当日处于已提交业务反馈状态项目数 | 业务经办已提交业务反馈，正交由一级评审员及一级评审加签人审核，尚未得出一级评审结论的项目数 |
| **业务方向** | 截至当日处于已提交业务反馈状态项目申请金额 | 略 |
| **业务方向** | 截至当日处于一级评审通过状态项目数 | 一级评审已通过，正交由二级评审员审核，尚未得出二级评审结论的项目数 |
| **业务方向** | 截至当日处于一级评审通过状态项目申请金额 | 略。 |
| **业务方向** | 截至当日处于二级评审通过状态项目数 | 二级评审已通过，正由项目评审会审核，尚未得出相应评审结论的项目数 |
| **业务方向** | 截至当日处于二级评审通过状态项目申请金额 | 略 |
| **业务方向** | 截至当日处于项目评审会审核通过状态项目数 | 项目评审会审核通过，正交由总经理/分管总审核，尚未得出相应评审结论的项目数 |
| **业务方向** | 截至当日处于项目评审会审核通过状态项目申请金额 | 略 |
| **业务方向** | 截至当日处于总经理/分管总审核通过状态项目数 | 总经理/分管总审核通过，批复文件尚未生成的项目数 |
| **业务方向** | 截至当日处于总经理/分管总审核通过状态项目申请金额 | 略 |
| **业务方向** | 截至当日处于已出具批复状态项目数 | 批复阶段审核通过，生成批复文件，包含了具体的批复金额、条款等，尚未新增授信的项目数 |
| **业务方向** | 截至当日处于已出具批复状态项目申请金额 | 略 |
| **业务方向** | 截至当日处于已出具批复状态项目批复金额 | 略 |


#### 建表语句
```plsql
DROP TABLE IF EXISTS ads_lease_org_unfinished_audit_stats;
CREATE EXTERNAL TABLE IF NOT EXISTS ads_lease_org_unfinished_audit_stats(
    `dt` STRING COMMENT '统计日期',
    `lease_organization` STRING COMMENT '业务方向',
    `created_project_count` BIGINT COMMENT '新建状态项目数',
    `created_project_amount` DECIMAL(16,2) COMMENT '新建状态项目申请金额',
    `risk_control_not_approved_count` BIGINT COMMENT '未达风控状态项目数',
    `risk_control_not_approved_amount` DECIMAL(16,2) COMMENT '未达风控状态项目申请金额',
    `credit_audit_approved_count` BIGINT COMMENT '信审经办审核通过状态项目数',
    `credit_audit_approved_amount` DECIMAL(16,2) COMMENT '信审经办审核通过状态项目申请金额',
    `feedback_submitted_count` BIGINT COMMENT '已提交业务反馈状态项目数',
    `feedback_submitted_amount` DECIMAL(16,2) COMMENT '已提交业务反馈状态项目申请金额',
    `level1_review_approved_count` BIGINT COMMENT '一级评审通过状态项目数',
    `level1_review_approved_amount` DECIMAL(16,2) COMMENT '一级评审通过状态项目申请金额',
    `level2_review_approved_count` BIGINT COMMENT '二级评审通过状态项目数',
    `level2_review_approved_amount` DECIMAL(16,2) COMMENT '二级评审通过状态项目申请金额',
    `review_meeting_approved_count` BIGINT COMMENT '项目评审会审核通过状态项目数',
    `review_meeting_approved_amount` DECIMAL(16,2) COMMENT '项目评审会审核通过状态项目申请金额',
    `general_manager_approved_count` BIGINT COMMENT '总经理/分管总审核通过状态项目数',
    `general_manager_approved_amount` DECIMAL(16,2) COMMENT '总经理/分管总审核通过状态项目申请金额',
    `reply_issued_count` BIGINT COMMENT '出具批复状态项目数',
    `reply_issued_apply_amount` DECIMAL(16,2) COMMENT '出具批复状态项目申请金额',
    `reply_issued_reply_amount` DECIMAL(16,2) COMMENT '出具批复状态项目批复金额'
) COMMENT '各业务方向待审/在审项目统计'
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
    LOCATION '/warehouse/financial_lease/ads/ads_lease_org_unfinished_audit_stats'
    TBLPROPERTIES ('compression.codec' = 'org.apache.hadoop.io.compress.GzipCodec');
```

#### 数据装载
```plsql
insert overwrite table ads_lease_org_unfinished_audit_stats
select dt,
       lease_organization,
       created_project_count,
       created_project_amount,
       risk_control_not_approved_count,
       risk_control_not_approved_amount,
       credit_audit_approved_count,
       credit_audit_approved_amount,
       feedback_submitted_count,
       feedback_submitted_amount,
       level1_review_approved_count,
       level1_review_approved_amount,
       level2_review_approved_count,
       level2_review_approved_amount,
       review_meeting_approved_count,
       review_meeting_approved_amount,
       general_manager_approved_count,
       general_manager_approved_amount,
       reply_issued_count,
       reply_issued_apply_amount,
       reply_issued_reply_amount
from ads_lease_org_unfinished_audit_stats
union
select '2023-05-09'                                                                            dt,
       lease_organization,
       sum(if(undistributed_time is null and risk_manage_refused_time is null, 1, 0))          created_project_count,
       sum(if(undistributed_time is null and risk_manage_refused_time is null, credit_amount,
              0))                                                                              created_project_amount,
       sum(if(risk_manage_refused_time is not null and undistributed_time is null, 1,
              0))                                                                              risk_control_not_approved_count,
       sum(if(risk_manage_refused_time is not null and undistributed_time is null, credit_amount,
              0))                                                                              risk_control_not_approved_amount,
       sum(if(credit_audit_approving_time is not null and feed_back_time is null, 1,
              0))                                                                              credit_audit_approved_count,
       sum(if(credit_audit_approving_time is not null and feed_back_time is null, credit_amount,
              0))                                                                              credit_audit_approved_amount,
       sum(if(feed_back_time is not null and first_level_review_approving_time is null, 1, 0)) feedback_submitted_count,
       sum(if(feed_back_time is not null and first_level_review_approving_time is null, credit_amount,
              0))                                                                              feedback_submitted_amount,
       sum(if(first_level_review_approving_time is not null and second_level_review_approving_time is null, 1,
              0))                                                                              level1_review_approved_count,
       sum(if(first_level_review_approving_time is not null and second_level_review_approving_time is null,
              credit_amount,
              0))                                                                              level1_review_approved_amount,
       sum(if(second_level_review_approving_time is not null and project_review_meeting_approving_time is null, 1,
              0))                                                                              level2_review_approved_count,
       sum(if(second_level_review_approving_time is not null and project_review_meeting_approving_time is null,
              credit_amount,
              0))                                                                              level2_review_approved_amount,
       sum(if(project_review_meeting_approving_time is not null and general_manager_review_approving_time is null, 1,
              0))                                                                              review_meeting_approved_count,
       sum(if(project_review_meeting_approving_time is not null and general_manager_review_approving_time is null,
              credit_amount,
              0))                                                                              review_meeting_approved_amount,
       sum(if(general_manager_review_approving_time is not null and reply_review_approving_time is null, 1,
              0))                                                                              general_manager_approved_count,
       sum(if(general_manager_review_approving_time is not null and reply_review_approving_time is null, credit_amount,
              0))                                                                              general_manager_approved_amount,
       sum(if(reply_review_approving_time is not null and credit_create_time is null, 1, 0))   reply_issued_count,
       sum(if(reply_review_approving_time is not null and credit_create_time is null, credit_amount,
              0))                                                                              reply_issued_apply_amount,
       sum(if(reply_review_approving_time is not null and credit_create_time is null, credit_reply_amount,
              0))                                                                              reply_issued_reply_amount
from dwd_financial_lease_flow_acc
where dt = '9999-12-31'
group by lease_organization;
```

从dwd层表中查询即可，通过`lease_organization`字段进行分组聚合

结果如下：

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1708334567059-7be27ba9-78fb-4dc4-afef-5597e32edfad.png)



### 待审/在审项目各部门统计
#### 需求说明
| **统计粒度** | 指标 | 说明 |
| --- | --- | --- |
| **部门** | 截至当日处于新建状态项目数 | 申请已发起，正交由风控员审核，未得出风控审核结果的项目数 |
| **部门** | 截至当日处于新建状态项目申请金额 | 略 |
| **部门** | 截至当日处于未达风控状态项目数 | 未通过风控员审核，正交由风控经理审核，未得出最终风控结论的项目数 |
| **部门** | 截至当日处于未达风控状态项目申请金额 | 略 |
| **部门** | 截至当日处于信审经办审核通过状态项目数 | 信审经办审核通过，业务经办尚未提交业务反馈的项目数 |
| **部门** | 截至当日处于信审经办审核通过状态项目申请金额 | 略 |
| **部门** | 截至当日处于已提交业务反馈状态项目数 | 业务经办已提交业务反馈，正交由一级评审员及一级评审加签人审核，尚未得出一级评审结论的项目数 |
| **部门** | 截至当日处于已提交业务反馈状态项目申请金额 | 略 |
| **部门** | 截至当日处于一级评审通过状态项目数 | 一级评审已通过，正交由二级评审员审核，尚未得出二级评审结论的项目数 |
| **部门** | 截至当日处于一级评审通过状态项目申请金额 | 略。 |
| **部门** | 截至当日处于二级评审通过状态项目数 | 二级评审已通过，正由项目评审会审核，尚未得出相应评审结论的项目数 |
| **部门** | 截至当日处于二级评审通过状态项目申请金额 | 略 |
| **部门** | 截至当日处于项目评审会审核通过状态项目数 | 项目评审会审核通过，正交由总经理/分管总审核，尚未得出相应评审结论的项目数 |
| **部门** | 截至当日处于项目评审会审核通过状态项目申请金额 | 略 |
| **部门** | 截至当日处于总经理/分管总审核通过状态项目数 | 总经理/分管总审核通过，批复文件尚未生成的项目数 |
| **部门** | 截至当日处于总经理/分管总审核通过状态项目申请金额 | 略 |
| **部门** | 截至当日处于已出具批复状态项目数 | 批复阶段审核通过，生成批复文件，包含了具体的批复金额、条款等，尚未新增授信的项目数 |
| **部门** | 截至当日处于已出具批复状态项目申请金额 | 略 |
| **部门** | 截至当日处于已出具批复状态项目批复金额 | 略 |


#### 建表
```plsql
DROP TABLE IF EXISTS ads_department_unfinished_audit_stats;
CREATE EXTERNAL TABLE IF NOT EXISTS ads_department_unfinished_audit_stats(
    `dt` STRING COMMENT '统计日期',
    `department3_id` STRING COMMENT '三级部门ID',
    `department3_name` STRING COMMENT '三级部门名称',
    `department2_id` STRING COMMENT '二级部门ID',
    `department2_name` STRING COMMENT '二级部门名称',
    `department1_id` STRING COMMENT '一级部门ID',
    `department1_name` STRING COMMENT '一级部门名称',
    `created_project_count` BIGINT COMMENT '新建状态项目数',
    `created_project_amount` DECIMAL(16,2) COMMENT '新建状态项目申请金额',
    `risk_control_not_approved_count` BIGINT COMMENT '未达风控状态项目数',
    `risk_control_not_approved_amount` DECIMAL(16,2) COMMENT '未达风控状态项目申请金额',
    `credit_audit_approved_count` BIGINT COMMENT '信审经办审核通过状态项目数',
    `credit_audit_approved_amount` DECIMAL(16,2) COMMENT '信审经办审核通过状态项目申请金额',
    `feedback_submitted_count` BIGINT COMMENT '已提交业务反馈状态项目数',
    `feedback_submitted_amount` DECIMAL(16,2) COMMENT '已提交业务反馈状态项目申请金额',
    `level1_review_approved_count` BIGINT COMMENT '一级评审通过状态项目数',
    `level1_review_approved_amount` DECIMAL(16,2) COMMENT '一级评审通过状态项目申请金额',
    `level2_review_approved_count` BIGINT COMMENT '二级评审通过状态项目数',
    `level2_review_approved_amount` DECIMAL(16,2) COMMENT '二级评审通过状态项目申请金额',
    `review_meeting_approved_count` BIGINT COMMENT '项目评审会审核通过状态项目数',
    `review_meeting_approved_amount` DECIMAL(16,2) COMMENT '项目评审会审核通过状态项目申请金额',
    `general_manager_approved_count` BIGINT COMMENT '总经理/分管总审核通过状态项目数',
    `general_manager_approved_amount` DECIMAL(16,2) COMMENT '总经理/分管总审核通过状态项目申请金额',
    `reply_issued_count` BIGINT COMMENT '出具批复状态项目数',
    `reply_issued_apply_amount` DECIMAL(16,2) COMMENT '出具批复状态项目申请金额',
    `reply_issued_reply_amount` DECIMAL(16,2) COMMENT '出具批复状态项目批复金额'
) COMMENT '各部门待审/在审项目统计'
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
    LOCATION '/warehouse/financial_lease/ads/ads_department_unfinished_audit_stats'
    TBLPROPERTIES ('compression.codec' = 'org.apache.hadoop.io.compress.GzipCodec');
```

#### 数据装载
```plsql
insert overwrite table ads_department_unfinished_audit_stats
select dt,
       department3_id,
       department3_name,
       department2_id,
       department2_name,
       department1_id,
       department1_name,
       created_project_count,
       created_project_amount,
       risk_control_not_approved_count,
       risk_control_not_approved_amount,
       credit_audit_approved_count,
       credit_audit_approved_amount,
       feedback_submitted_count,
       feedback_submitted_amount,
       level1_review_approved_count,
       level1_review_approved_amount,
       level2_review_approved_count,
       level2_review_approved_amount,
       review_meeting_approved_count,
       review_meeting_approved_amount,
       general_manager_approved_count,
       general_manager_approved_amount,
       reply_issued_count,
       reply_issued_apply_amount,
       reply_issued_reply_amount
from ads_department_unfinished_audit_stats
union
select dt,
       agg.department3_id,
       department3_name,
       department2_id,
       department2_name,
       department1_id,
       department1_name,
       created_project_count,
       created_project_amount,
       risk_control_not_approved_count,
       risk_control_not_approved_amount,
       credit_audit_approved_count,
       credit_audit_approved_amount,
       feedback_submitted_count,
       feedback_submitted_amount,
       level1_review_approved_count,
       level1_review_approved_amount,
       level2_review_approved_count,
       level2_review_approved_amount,
       review_meeting_approved_count,
       review_meeting_approved_amount,
       general_manager_approved_count,
       general_manager_approved_amount,
       reply_issued_count,
       reply_issued_apply_amount,
       reply_issued_reply_amount
from (select '2023-05-09'                                                                          dt,
             department3_id,
             sum(if(undistributed_time is null and risk_manage_refused_time is null, 1,
                    0))                                                                            created_project_count,
             sum(if(undistributed_time is null and risk_manage_refused_time is null, credit_amount,
                    0))                                                                            created_project_amount,
             sum(if(risk_manage_refused_time is not null and undistributed_time is null, 1,
                    0))                                                                            risk_control_not_approved_count,
             sum(if(risk_manage_refused_time is not null and undistributed_time is null, credit_amount,
                    0))                                                                            risk_control_not_approved_amount,
             sum(if(credit_audit_approving_time is not null and feed_back_time is null, 1,
                    0))                                                                            credit_audit_approved_count,
             sum(if(credit_audit_approving_time is not null and feed_back_time is null, credit_amount,
                    0))                                                                            credit_audit_approved_amount,
             sum(if(feed_back_time is not null and first_level_review_approving_time is null, 1,
                    0))                                                                            feedback_submitted_count,
             sum(if(feed_back_time is not null and first_level_review_approving_time is null, credit_amount,
                    0))                                                                            feedback_submitted_amount,
             sum(if(first_level_review_approving_time is not null and second_level_review_approving_time is null, 1,
                    0))                                                                            level1_review_approved_count,
             sum(if(first_level_review_approving_time is not null and second_level_review_approving_time is null,
                    credit_amount,
                    0))                                                                            level1_review_approved_amount,
             sum(if(second_level_review_approving_time is not null and project_review_meeting_approving_time is null, 1,
                    0))                                                                            level2_review_approved_count,
             sum(if(second_level_review_approving_time is not null and project_review_meeting_approving_time is null,
                    credit_amount,
                    0))                                                                            level2_review_approved_amount,
             sum(if(project_review_meeting_approving_time is not null and general_manager_review_approving_time is null,
                    1,
                    0))                                                                            review_meeting_approved_count,
             sum(if(project_review_meeting_approving_time is not null and general_manager_review_approving_time is null,
                    credit_amount,
                    0))                                                                            review_meeting_approved_amount,
             sum(if(general_manager_review_approving_time is not null and reply_review_approving_time is null, 1,
                    0))                                                                            general_manager_approved_count,
             sum(if(general_manager_review_approving_time is not null and reply_review_approving_time is null,
                    credit_amount,
                    0))                                                                            general_manager_approved_amount,
             sum(if(reply_review_approving_time is not null and credit_create_time is null, 1, 0)) reply_issued_count,
             sum(if(reply_review_approving_time is not null and credit_create_time is null, credit_amount,
                    0))                                                                            reply_issued_apply_amount,
             sum(if(reply_review_approving_time is not null and credit_create_time is null, credit_reply_amount,
                    0))                                                                            reply_issued_reply_amount
      from (select *
            from dwd_financial_lease_flow_acc
            where dt = '9999-12-31') acc
               left join (select id,
                                 department3_id
                          from dim_employee_full
                          where dt = '2023-05-09') emp
                         on acc.salesman_id = emp.id
      group by department3_id) agg
         left join
     (select department3_id,
             department3_name,
             department2_id,
             department2_name,
             department1_id,
             department1_name
      from dim_department_full
      where dt = '2023-05-09') department
     on agg.department3_id = department.department3_id;
msck repair table dim_department_full;
```

需要从dim层的部门表中获取到相关二级以及一级部门的内容；

### 待审/在审项目各业务经办统计
#### 需求说明
| **统计粒度** | 指标 | 说明 |
| --- | --- | --- |
| **业务经办** | 截至当日处于新建状态项目数 | 申请已发起，正交由风控员审核，未得出风控审核结果的项目数 |
| **业务经办** | 截至当日处于新建状态项目申请金额 | 略 |
| **业务经办** | 截至当日处于未达风控状态项目数 | 未通过风控员审核，正交由风控经理审核，未得出最终风控结论的项目数 |
| **业务经办** | 截至当日处于未达风控状态项目申请金额 | 略 |
| **业务经办** | 截至当日处于信审经办审核通过状态项目数 | 信审经办审核通过，业务经办尚未提交业务反馈的项目数 |
| **业务经办** | 截至当日处于信审经办审核通过状态项目申请金额 | 略 |
| **业务经办** | 截至当日处于已提交业务反馈状态项目数 | 业务经办已提交业务反馈，正交由一级评审员及一级评审加签人审核，尚未得出一级评审结论的项目数 |
| **业务经办** | 截至当日处于已提交业务反馈状态项目申请金额 | 略 |
| **业务经办** | 截至当日处于一级评审通过状态项目数 | 一级评审已通过，正交由二级评审员审核，尚未得出二级评审结论的项目数 |
| **业务经办** | 截至当日处于一级评审通过状态项目申请金额 | 略。 |
| **业务经办** | 截至当日处于二级评审通过状态项目数 | 二级评审已通过，正由项目评审会审核，尚未得出相应评审结论的项目数 |
| **业务经办** | 截至当日处于二级评审通过状态项目申请金额 | 略 |
| **业务经办** | 截至当日处于项目评审会审核通过状态项目数 | 项目评审会审核通过，正交由总经理/分管总审核，尚未得出相应评审结论的项目数 |
| **业务经办** | 截至当日处于项目评审会审核通过状态项目申请金额 | 略 |
| **业务经办** | 截至当日处于总经理/分管总审核通过状态项目数 | 总经理/分管总审核通过，批复文件尚未生成的项目数 |
| **业务经办** | 截至当日处于总经理/分管总审核通过状态项目申请金额 | 略 |
| **业务经办** | 截至当日处于已出具批复状态项目数 | 批复阶段审核通过，生成批复文件，包含了具体的批复金额、条款等，尚未新增授信的项目数 |
| **业务经办** | 截至当日处于已出具批复状态项目申请金额 | 略 |
| **业务经办** | 截至当日处于已出具批复状态项目批复金额 | 略 |


（与综合统计相比统计粒度为“业务经办”）

#### 建表
```plsql
DROP TABLE IF EXISTS ads_salesman_unfinished_audit_stats;
CREATE EXTERNAL TABLE IF NOT EXISTS ads_salesman_unfinished_audit_stats(
    `dt` STRING COMMENT '统计日期',
    `salesman_id` STRING COMMENT '业务经办员工ID',
    `salesman_name` STRING COMMENT '业务经办员工姓名',
    `created_project_count` BIGINT COMMENT '新建状态项目数',
    `created_project_amount` DECIMAL(16,2) COMMENT '新建状态项目申请金额',
    `risk_control_not_approved_count` BIGINT COMMENT '未达风控状态项目数',
    `risk_control_not_approved_amount` DECIMAL(16,2) COMMENT '未达风控状态项目申请金额',
    `credit_audit_approved_count` BIGINT COMMENT '信审经办审核通过状态项目数',
    `credit_audit_approved_amount` DECIMAL(16,2) COMMENT '信审经办审核通过状态项目申请金额',
    `feedback_submitted_count` BIGINT COMMENT '已提交业务反馈状态项目数',
    `feedback_submitted_amount` DECIMAL(16,2) COMMENT '已提交业务反馈状态项目申请金额',
    `level1_review_approved_count` BIGINT COMMENT '一级评审通过状态项目数',
    `level1_review_approved_amount` DECIMAL(16,2) COMMENT '一级评审通过状态项目申请金额',
    `level2_review_approved_count` BIGINT COMMENT '二级评审通过状态项目数',
    `level2_review_approved_amount` DECIMAL(16,2) COMMENT '二级评审通过状态项目申请金额',
    `review_meeting_approved_count` BIGINT COMMENT '项目评审会审核通过状态项目数',
    `review_meeting_approved_amount` DECIMAL(16,2) COMMENT '项目评审会审核通过状态项目申请金额',
    `general_manager_approved_count` BIGINT COMMENT '总经理/分管总审核通过状态项目数',
    `general_manager_approved_amount` DECIMAL(16,2) COMMENT '总经理/分管总审核通过状态项目申请金额',
    `reply_issued_count` BIGINT COMMENT '出具批复状态项目数',
    `reply_issued_apply_amount` DECIMAL(16,2) COMMENT '出具批复状态项目申请金额',
    `reply_issued_reply_amount` DECIMAL(16,2) COMMENT '出具批复状态项目批复金额'
) COMMENT '各业务经办待审/在审项目统计'
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
    LOCATION '/warehouse/financial_lease/ads/ads_salesman_unfinished_audit_stats'
    TBLPROPERTIES ('compression.codec' = 'org.apache.hadoop.io.compress.GzipCodec');
```

#### 数据装载
```plsql
insert overwrite table ads_salesman_unfinished_audit_stats
select dt,
       salesman_id,
       salesman_name,
       created_project_count,
       created_project_amount,
       risk_control_not_approved_count,
       risk_control_not_approved_amount,
       credit_audit_approved_count,
       credit_audit_approved_amount,
       feedback_submitted_count,
       feedback_submitted_amount,
       level1_review_approved_count,
       level1_review_approved_amount,
       level2_review_approved_count,
       level2_review_approved_amount,
       review_meeting_approved_count,
       review_meeting_approved_amount,
       general_manager_approved_count,
       general_manager_approved_amount,
       reply_issued_count,
       reply_issued_apply_amount,
       reply_issued_reply_amount
from ads_salesman_unfinished_audit_stats
union
select dt,
       salesman_id,
       emp.name salesman_name,
       created_project_count,
       created_project_amount,
       risk_control_not_approved_count,
       risk_control_not_approved_amount,
       credit_audit_approved_count,
       credit_audit_approved_amount,
       feedback_submitted_count,
       feedback_submitted_amount,
       level1_review_approved_count,
       level1_review_approved_amount,
       level2_review_approved_count,
       level2_review_approved_amount,
       review_meeting_approved_count,
       review_meeting_approved_amount,
       general_manager_approved_count,
       general_manager_approved_amount,
       reply_issued_count,
       reply_issued_apply_amount,
       reply_issued_reply_amount
from (select '2023-05-09'                                                                          dt,
             salesman_id,
             sum(if(undistributed_time is null and risk_manage_refused_time is null, 1,
                    0))                                                                            created_project_count,
             sum(if(undistributed_time is null and risk_manage_refused_time is null, credit_amount,
                    0))                                                                            created_project_amount,
             sum(if(risk_manage_refused_time is not null and undistributed_time is null, 1,
                    0))                                                                            risk_control_not_approved_count,
             sum(if(risk_manage_refused_time is not null and undistributed_time is null, credit_amount,
                    0))                                                                            risk_control_not_approved_amount,
             sum(if(credit_audit_approving_time is not null and feed_back_time is null, 1,
                    0))                                                                            credit_audit_approved_count,
             sum(if(credit_audit_approving_time is not null and feed_back_time is null, credit_amount,
                    0))                                                                            credit_audit_approved_amount,
             sum(if(feed_back_time is not null and first_level_review_approving_time is null, 1,
                    0))                                                                            feedback_submitted_count,
             sum(if(feed_back_time is not null and first_level_review_approving_time is null, credit_amount,
                    0))                                                                            feedback_submitted_amount,
             sum(if(first_level_review_approving_time is not null and second_level_review_approving_time is null, 1,
                    0))                                                                            level1_review_approved_count,
             sum(if(first_level_review_approving_time is not null and second_level_review_approving_time is null,
                    credit_amount,
                    0))                                                                            level1_review_approved_amount,
             sum(if(second_level_review_approving_time is not null and project_review_meeting_approving_time is null, 1,
                    0))                                                                            level2_review_approved_count,
             sum(if(second_level_review_approving_time is not null and project_review_meeting_approving_time is null,
                    credit_amount,
                    0))                                                                            level2_review_approved_amount,
             sum(if(project_review_meeting_approving_time is not null and general_manager_review_approving_time is null,
                    1,
                    0))                                                                            review_meeting_approved_count,
             sum(if(project_review_meeting_approving_time is not null and general_manager_review_approving_time is null,
                    credit_amount,
                    0))                                                                            review_meeting_approved_amount,
             sum(if(general_manager_review_approving_time is not null and reply_review_approving_time is null, 1,
                    0))                                                                            general_manager_approved_count,
             sum(if(general_manager_review_approving_time is not null and reply_review_approving_time is null,
                    credit_amount,
                    0))                                                                            general_manager_approved_amount,
             sum(if(reply_review_approving_time is not null and credit_create_time is null, 1, 0)) reply_issued_count,
             sum(if(reply_review_approving_time is not null and credit_create_time is null, credit_amount,
                    0))                                                                            reply_issued_apply_amount,
             sum(if(reply_review_approving_time is not null and credit_create_time is null, credit_reply_amount,
                    0))                                                                            reply_issued_reply_amount
      from dwd_financial_lease_flow_acc
      where dt = '9999-12-31'
      group by salesman_id) agg
         left join (
    select id,
           name
    from dim_employee_full
    where dt = '2023-05-09'
) emp on agg.salesman_id = emp.id;
```

### 待审/在审项目各信审经办统计
#### 需求说明
| **统计粒度** | 指标 | 说明 |
| --- | --- | --- |
| **信审经办** | 截至当日处于信审经办审核通过状态项目数 | 信审经办审核通过，业务经办尚未提交业务反馈的项目数 |
| **信审经办** | 截至当日处于信审经办审核通过状态项目申请金额 | 略 |
| **信审经办** | 截至当日处于已提交业务反馈状态项目数 | 业务经办已提交业务反馈，正交由一级评审员及一级评审加签人审核，尚未得出一级评审结论的项目数 |
| **信审经办** | 截至当日处于已提交业务反馈状态项目申请金额 | 略 |
| **信审经办** | 截至当日处于一级评审通过状态项目数 | 一级评审已通过，正交由二级评审员审核，尚未得出二级评审结论的项目数 |
| **信审经办** | 截至当日处于一级评审通过状态项目申请金额 | 略。 |
| **信审经办** | 截至当日处于二级评审通过状态项目数 | 二级评审已通过，正由项目评审会审核，尚未得出相应评审结论的项目数 |
| **信审经办** | 截至当日处于二级评审通过状态项目申请金额 | 略 |
| **信审经办** | 截至当日处于项目评审会审核通过状态项目数 | 项目评审会审核通过，正交由总经理/分管总审核，尚未得出相应评审结论的项目数 |
| **信审经办** | 截至当日处于项目评审会审核通过状态项目申请金额 | 略 |
| **信审经办** | 截至当日处于总经理/分管总审核通过状态项目数 | 总经理/分管总审核通过，批复文件尚未生成的项目数 |
| **信审经办** | 截至当日处于总经理/分管总审核通过状态项目申请金额 | 略 |
| **信审经办** | 截至当日处于已出具批复状态项目数 | 批复阶段审核通过，生成批复文件，包含了具体的批复金额、条款等，尚未新增授信的项目数 |
| **信审经办** | 截至当日处于已出具批复状态项目申请金额 | 略 |
| **信审经办** | 截至当日处于已出具批复状态项目批复金额 | 略 |


（统计粒度为“信审经办”）

#### 建表
```plsql
DROP TABLE IF EXISTS ads_credit_audit_unfinished_audit_stats;
CREATE EXTERNAL TABLE IF NOT EXISTS ads_credit_audit_unfinished_audit_stats(
    `dt` STRING COMMENT '统计日期',
    `credit_audit_id` STRING COMMENT '信审经办ID',
    `credit_audit_name` STRING COMMENT '信审经办姓名',
    `credit_audit_approved_count` BIGINT COMMENT '信审经办审核通过状态项目数',
    `credit_audit_approved_amount` DECIMAL(16,2) COMMENT '信审经办审核通过状态项目申请金额',
    `feedback_submitted_count` BIGINT COMMENT '已提交业务反馈状态项目数',
    `feedback_submitted_amount` DECIMAL(16,2) COMMENT '已提交业务反馈状态项目申请金额',
    `level1_review_approved_count` BIGINT COMMENT '一级评审通过状态项目数',
    `level1_review_approved_amount` DECIMAL(16,2) COMMENT '一级评审通过状态项目申请金额',
    `level2_review_approved_count` BIGINT COMMENT '二级评审通过状态项目数',
    `level2_review_approved_amount` DECIMAL(16,2) COMMENT '二级评审通过状态项目申请金额',
    `review_meeting_approved_count` BIGINT COMMENT '项目评审会审核通过状态项目数',
    `review_meeting_approved_amount` DECIMAL(16,2) COMMENT '项目评审会审核通过状态项目申请金额',
    `general_manager_approved_count` BIGINT COMMENT '总经理/分管总审核通过状态项目数',
    `general_manager_approved_amount` DECIMAL(16,2) COMMENT '总经理/分管总审核通过状态项目申请金额',
    `reply_issued_count` BIGINT COMMENT '出具批复状态项目数',
    `reply_issued_apply_amount` DECIMAL(16,2) COMMENT '出具批复状态项目申请金额',
    `reply_issued_reply_amount` DECIMAL(16,2) COMMENT '出具批复状态项目批复金额'
) COMMENT '各信审经办待审/在审项目统计'
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
    LOCATION '/warehouse/financial_lease/ads/ads_credit_audit_unfinished_audit_stats'
    TBLPROPERTIES ('compression.codec' = 'org.apache.hadoop.io.compress.GzipCodec');
```

#### 数据装载
```plsql
insert overwrite table ads_credit_audit_unfinished_audit_stats
select dt,
       credit_audit_id,
       credit_audit_name,
       credit_audit_approved_count,
       credit_audit_approved_amount,
       feedback_submitted_count,
       feedback_submitted_amount,
       level1_review_approved_count,
       level1_review_approved_amount,
       level2_review_approved_count,
       level2_review_approved_amount,
       review_meeting_approved_count,
       review_meeting_approved_amount,
       general_manager_approved_count,
       general_manager_approved_amount,
       reply_issued_count,
       reply_issued_apply_amount,
       reply_issued_reply_amount
from ads_credit_audit_unfinished_audit_stats
union
select '2023-05-09' dt,
       credit_audit_id,
       name         credit_audit_name,
       credit_audit_approved_count,
       credit_audit_approved_amount,
       feedback_submitted_count,
       feedback_submitted_amount,
       level1_review_approved_count,
       level1_review_approved_amount,
       level2_review_approved_count,
       level2_review_approved_amount,
       review_meeting_approved_count,
       review_meeting_approved_amount,
       general_manager_approved_count,
       general_manager_approved_amount,
       reply_issued_count,
       reply_issued_apply_amount,
       reply_issued_reply_amount
from (select '2023-05-09'                                                                          dt,
             credit_audit_id,
             sum(if(credit_audit_approving_time is not null and feed_back_time is null, 1,
                    0))                                                                            credit_audit_approved_count,
             sum(if(credit_audit_approving_time is not null and feed_back_time is null, credit_amount,
                    0))                                                                            credit_audit_approved_amount,
             sum(if(feed_back_time is not null and first_level_review_approving_time is null, 1,
                    0))                                                                            feedback_submitted_count,
             sum(if(feed_back_time is not null and first_level_review_approving_time is null, credit_amount,
                    0))                                                                            feedback_submitted_amount,
             sum(if(first_level_review_approving_time is not null and second_level_review_approving_time is null, 1,
                    0))                                                                            level1_review_approved_count,
             sum(if(first_level_review_approving_time is not null and second_level_review_approving_time is null,
                    credit_amount,
                    0))                                                                            level1_review_approved_amount,
             sum(if(second_level_review_approving_time is not null and project_review_meeting_approving_time is null, 1,
                    0))                                                                            level2_review_approved_count,
             sum(if(second_level_review_approving_time is not null and project_review_meeting_approving_time is null,
                    credit_amount,
                    0))                                                                            level2_review_approved_amount,
             sum(if(project_review_meeting_approving_time is not null and general_manager_review_approving_time is null,
                    1,
                    0))                                                                            review_meeting_approved_count,
             sum(if(project_review_meeting_approving_time is not null and general_manager_review_approving_time is null,
                    credit_amount,
                    0))                                                                            review_meeting_approved_amount,
             sum(if(general_manager_review_approving_time is not null and reply_review_approving_time is null, 1,
                    0))                                                                            general_manager_approved_count,
             sum(if(general_manager_review_approving_time is not null and reply_review_approving_time is null,
                    credit_amount,
                    0))                                                                            general_manager_approved_amount,
             sum(if(reply_review_approving_time is not null and credit_create_time is null, 1, 0)) reply_issued_count,
             sum(if(reply_review_approving_time is not null and credit_create_time is null, credit_amount,
                    0))                                                                            reply_issued_apply_amount,
             sum(if(reply_review_approving_time is not null and credit_create_time is null, credit_reply_amount,
                    0))                                                                            reply_issued_reply_amount
      from dwd_financial_lease_flow_acc
      where dt = '9999-12-31'
        and credit_audit_id is not null
      group by credit_audit_id) acc
         left join
     (select id,
             name
      from dim_employee_full
      where dt = '2023-05-09') emp
     on acc.credit_audit_id = emp.id;
```

逻辑与业务经办一致

### 待审/在审项目各行业统计
#### 需求说明
| **统计粒度** | 指标 | 说明 |
| --- | --- | --- |
| **行业** | 截至当日处于新建状态项目数 | 申请已发起，正交由风控员审核，未得出风控审核结果的项目数 |
| **行业** | 截至当日处于新建状态项目申请金额 | 略 |
| **行业** | 截至当日处于未达风控状态项目数 | 未通过风控员审核，正交由风控经理审核，未得出最终风控结论的项目数 |
| **行业** | 截至当日处于未达风控状态项目申请金额 | 略 |
| **行业** | 截至当日处于信审经办审核通过状态项目数 | 信审经办审核通过，业务经办尚未提交业务反馈的项目数 |
| **行业** | 截至当日处于信审经办审核通过状态项目申请金额 | 略 |
| **行业** | 截至当日处于已提交业务反馈状态项目数 | 业务经办已提交业务反馈，正交由一级评审员及一级评审加签人审核，尚未得出一级评审结论的项目数 |
| **行业** | 截至当日处于已提交业务反馈状态项目申请金额 | 略 |
| **行业** | 截至当日处于一级评审通过状态项目数 | 一级评审已通过，正交由二级评审员审核，尚未得出二级评审结论的项目数 |
| **行业** | 截至当日处于一级评审通过状态项目申请金额 | 略。 |
| **行业** | 截至当日处于二级评审通过状态项目数 | 二级评审已通过，正由项目评审会审核，尚未得出相应评审结论的项目数 |
| **行业** | 截至当日处于二级评审通过状态项目申请金额 | 略 |
| **行业** | 截至当日处于项目评审会审核通过状态项目数 | 项目评审会审核通过，正交由总经理/分管总审核，尚未得出相应评审结论的项目数 |
| **行业** | 截至当日处于项目评审会审核通过状态项目申请金额 | 略 |
| **行业** | 截至当日处于总经理/分管总审核通过状态项目数 | 总经理/分管总审核通过，批复文件尚未生成的项目数 |
| **行业** | 截至当日处于总经理/分管总审核通过状态项目申请金额 | 略 |
| **行业** | 截至当日处于已出具批复状态项目数 | 批复阶段审核通过，生成批复文件，包含了具体的批复金额、条款等，尚未新增授信的项目数 |
| **行业** | 截至当日处于已出具批复状态项目申请金额 | 略 |
| **行业** | 截至当日处于已出具批复状态项目批复金额 | 略 |


（统计粒度为“行业”）

#### 建表
```plsql
DROP TABLE IF EXISTS ads_industry_unfinished_audit_stats;
CREATE EXTERNAL TABLE IF NOT EXISTS ads_industry_unfinished_audit_stats(
    `dt` STRING COMMENT '统计日期',
    `industry3_id` STRING COMMENT '三级行业ID',
    `industry3_name` STRING COMMENT '三级行业名称',
    `industry2_id` STRING COMMENT '二级行业ID',
    `industry2_name` STRING COMMENT '二级行业名称',
    `industry1_id` STRING COMMENT '一级行业ID',
    `industry1_name` STRING COMMENT '一级行业名称',
    `created_project_count` BIGINT COMMENT '新建状态项目数',
    `created_project_amount` DECIMAL(16,2) COMMENT '新建状态项目申请金额',
    `risk_control_not_approved_count` BIGINT COMMENT '未达风控状态项目数',
    `risk_control_not_approved_amount` DECIMAL(16,2) COMMENT '未达风控状态项目申请金额',
    `credit_audit_approved_count` BIGINT COMMENT '信审经办审核通过状态项目数',
    `credit_audit_approved_amount` DECIMAL(16,2) COMMENT '信审经办审核通过状态项目申请金额',
    `feedback_submitted_count` BIGINT COMMENT '已提交业务反馈状态项目数',
    `feedback_submitted_amount` DECIMAL(16,2) COMMENT '已提交业务反馈状态项目申请金额',
    `level1_review_approved_count` BIGINT COMMENT '一级评审通过状态项目数',
    `level1_review_approved_amount` DECIMAL(16,2) COMMENT '一级评审通过状态项目申请金额',
    `level2_review_approved_count` BIGINT COMMENT '二级评审通过状态项目数',
    `level2_review_approved_amount` DECIMAL(16,2) COMMENT '二级评审通过状态项目申请金额',
    `review_meeting_approved_count` BIGINT COMMENT '项目评审会审核通过状态项目数',
    `review_meeting_approved_amount` DECIMAL(16,2) COMMENT '项目评审会审核通过状态项目申请金额',
    `general_manager_approved_count` BIGINT COMMENT '总经理/分管总审核通过状态项目数',
    `general_manager_approved_amount` DECIMAL(16,2) COMMENT '总经理/分管总审核通过状态项目申请金额',
    `reply_issued_count` BIGINT COMMENT '出具批复状态项目数',
    `reply_issued_apply_amount` DECIMAL(16,2) COMMENT '出具批复状态项目申请金额',
    `reply_issued_reply_amount` DECIMAL(16,2) COMMENT '出具批复状态项目批复金额'
) COMMENT '各行业待审/在审项目统计'
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
    LOCATION '/warehouse/financial_lease/ads/ads_industry_unfinished_audit_stats'
    TBLPROPERTIES ('compression.codec' = 'org.apache.hadoop.io.compress.GzipCodec');
```

#### 数据装载
```plsql
insert overwrite table ads_industry_unfinished_audit_stats
select dt,
       industry3_id,
       industry3_name,
       industry2_id,
       industry2_name,
       industry1_id,
       industry1_name,
       created_project_count,
       created_project_amount,
       risk_control_not_approved_count,
       risk_control_not_approved_amount,
       credit_audit_approved_count,
       credit_audit_approved_amount,
       feedback_submitted_count,
       feedback_submitted_amount,
       level1_review_approved_count,
       level1_review_approved_amount,
       level2_review_approved_count,
       level2_review_approved_amount,
       review_meeting_approved_count,
       review_meeting_approved_amount,
       general_manager_approved_count,
       general_manager_approved_amount,
       reply_issued_count,
       reply_issued_apply_amount,
       reply_issued_reply_amount
from ads_industry_unfinished_audit_stats
union
select dt,
       agg.industry3_id,
       industry3_name,
       industry2_id,
       industry2_name,
       industry1_id,
       industry1_name,
       created_project_count,
       created_project_amount,
       risk_control_not_approved_count,
       risk_control_not_approved_amount,
       credit_audit_approved_count,
       credit_audit_approved_amount,
       feedback_submitted_count,
       feedback_submitted_amount,
       level1_review_approved_count,
       level1_review_approved_amount,
       level2_review_approved_count,
       level2_review_approved_amount,
       review_meeting_approved_count,
       review_meeting_approved_amount,
       general_manager_approved_count,
       general_manager_approved_amount,
       reply_issued_count,
       reply_issued_apply_amount,
       reply_issued_reply_amount
from (select '2023-05-09'                                                                          dt,
             industry3_id,
             sum(if(undistributed_time is null and risk_manage_refused_time is null, 1,
                    0))                                                                            created_project_count,
             sum(if(undistributed_time is null and risk_manage_refused_time is null, credit_amount,
                    0))                                                                            created_project_amount,
             sum(if(risk_manage_refused_time is not null and undistributed_time is null, 1,
                    0))                                                                            risk_control_not_approved_count,
             sum(if(risk_manage_refused_time is not null and undistributed_time is null, credit_amount,
                    0))                                                                            risk_control_not_approved_amount,
             sum(if(credit_audit_approving_time is not null and feed_back_time is null, 1,
                    0))                                                                            credit_audit_approved_count,
             sum(if(credit_audit_approving_time is not null and feed_back_time is null, credit_amount,
                    0))                                                                            credit_audit_approved_amount,
             sum(if(feed_back_time is not null and first_level_review_approving_time is null, 1,
                    0))                                                                            feedback_submitted_count,
             sum(if(feed_back_time is not null and first_level_review_approving_time is null, credit_amount,
                    0))                                                                            feedback_submitted_amount,
             sum(if(first_level_review_approving_time is not null and second_level_review_approving_time is null, 1,
                    0))                                                                            level1_review_approved_count,
             sum(if(first_level_review_approving_time is not null and second_level_review_approving_time is null,
                    credit_amount,
                    0))                                                                            level1_review_approved_amount,
             sum(if(second_level_review_approving_time is not null and project_review_meeting_approving_time is null, 1,
                    0))                                                                            level2_review_approved_count,
             sum(if(second_level_review_approving_time is not null and project_review_meeting_approving_time is null,
                    credit_amount,
                    0))                                                                            level2_review_approved_amount,
             sum(if(project_review_meeting_approving_time is not null and general_manager_review_approving_time is null,
                    1,
                    0))                                                                            review_meeting_approved_count,
             sum(if(project_review_meeting_approving_time is not null and general_manager_review_approving_time is null,
                    credit_amount,
                    0))                                                                            review_meeting_approved_amount,
             sum(if(general_manager_review_approving_time is not null and reply_review_approving_time is null, 1,
                    0))                                                                            general_manager_approved_count,
             sum(if(general_manager_review_approving_time is not null and reply_review_approving_time is null,
                    credit_amount,
                    0))                                                                            general_manager_approved_amount,
             sum(if(reply_review_approving_time is not null and credit_create_time is null, 1, 0)) reply_issued_count,
             sum(if(reply_review_approving_time is not null and credit_create_time is null, credit_amount,
                    0))                                                                            reply_issued_apply_amount,
             sum(if(reply_review_approving_time is not null and credit_create_time is null, credit_reply_amount,
                    0))                                                                            reply_issued_reply_amount
      from dwd_financial_lease_flow_acc
      where dt = '9999-12-31'
      group by industry3_id) agg
         left join
     (select industry3_id,
             industry3_name,
             industry2_id,
             industry2_name,
             industry1_id,
             industry1_name
      from dim_industry_full
      where dt = '2023-05-09') ind
     on agg.industry3_id = ind.industry3_id;
```

逻辑与各部门统计一致

### 已审项目主题
与待审/在审项目基本一致

唯一区别在于dt的值，where过滤时，待审项目`dt=9999-12-31`，而已审项目`dt=当天时间`

### 已审项目转化主题
#### 需求说明
| **统计周期** | **统计粒度** | 指标 | 说明 |
| --- | --- | --- | --- |
| **历史至今** | -- | 审批结束项目数 | 起租、取消和拒绝的所有项目数 |
| **历史至今** | -- | 审批结束项目申请金额 | 略 |
| **历史至今** | -- | 审批通过项目数 | 已出具批复，批复文件包括批复金额、条件等信息的项目数 |
| **历史至今** | -- | 审批通过项目申请金额 | 略 |
| **历史至今** | -- | 审批通过项目批复金额 | 略 |
| **历史至今** |  | 新增授信项目数 | 略 |
| **历史至今** |  | 新增授信项目申请金额 | 略 |
| **历史至今** |  | 新增授信项目批复金额 | 略 |
| **历史至今** |  | 新增授信项目授信金额 | 略 |
| **历史至今** |  | 完成授信占用项目数 | 略 |
| **历史至今** | -- | 完成授信占用项目申请金额 | 略 |
| **历史至今** | -- | 完成授信占用项目批复金额 | 略 |
| **历史至今** | -- | 完成授信占用项目授信金额 | 略 |
| **历史至今** | -- | 完成合同制作项目数 | 略 |
| **历史至今** | -- | 完成合同制作项目申请金额 | 略 |
| **历史至今** | -- | 完成合同制作项目批复金额 | 略 |
| **历史至今** | -- | 完成合同制作项目授信金额 | 略 |
| **历史至今** | -- | 签约项目数 | 略 |
| **历史至今** | -- | 签约项目申请金额 | 略 |
| **历史至今** | -- | 签约项目批复金额 | 略 |
| **历史至今** | -- | 签约项目授信金额 | 略 |
| **历史至今** | -- | 起租项目数 | 略 |
| **历史至今** | -- | 起租项目申请金额 | 略 |
| **历史至今** | -- | 起租项目批复金额 | 略 |
| **历史至今** | -- | 起租项目授信金额 | 略 |


#### 建表语句
```plsql
DROP TABLE IF EXISTS ads_credit_audit_finished_transform_stats;
CREATE EXTERNAL TABLE IF NOT EXISTS ads_credit_audit_finished_transform_stats(
    `dt` STRING COMMENT '统计日期',
    `credit_audit_finished_count` BIGINT COMMENT '审批结束项目数',
    `credit_audit_finished_apply_amount` DECIMAL(16,2) COMMENT '审批结束项目申请金额',
    `credit_audit_approved_count` BIGINT COMMENT '审批通过项目数',
    `credit_audit_approved_apply_amount` DECIMAL(16,2) COMMENT '审批通过项目申请金额',
    `credit_audit_approved_reply_amount` DECIMAL(16,2) COMMENT '审批通过项目批复金额',
    `credit_created_count` BIGINT COMMENT '新增授信项目数',
    `credit_created_apply_amount` DECIMAL(16,2) COMMENT '新增授信项目申请金额',
    `credit_created_reply_amount` DECIMAL(16,2) COMMENT '新增授信项目批复金额',
    `credit_created_credit_amount` DECIMAL(16,2) COMMENT '新增授信项目授信金额',
    `credit_occupied_count` BIGINT COMMENT '完成授信占用项目数',
    `credit_occupied_apply_amount` DECIMAL(16,2) COMMENT '完成授信占用项目申请金额',
    `credit_occupied_reply_amount` DECIMAL(16,2) COMMENT '完成授信占用项目批复金额',
    `credit_occupied_credit_amount` DECIMAL(16,2) COMMENT '完成授信占用项目授信金额',
    `contract_produced_count` BIGINT COMMENT '完成合同制作项目数',
    `contract_produced_apply_amount` DECIMAL(16,2) COMMENT '完成合同制作项目申请金额',
    `contract_produced_reply_amount` DECIMAL(16,2) COMMENT '完成合同制作项目批复金额',
    `contract_produced_credit_amount` DECIMAL(16,2) COMMENT '完成合同制作项目授信金额',
    `credit_signed_count` BIGINT COMMENT '签约项目数',
    `credit_signed_apply_amount` DECIMAL(16,2) COMMENT '签约项目申请金额',
    `credit_signed_reply_amount` DECIMAL(16,2) COMMENT '签约项目批复金额',
    `credit_signed_credit_amount` DECIMAL(16,2) COMMENT '签约项目授信金额',
    `leased_count` BIGINT COMMENT '起租项目数',
    `leased_apply_amount` DECIMAL(16,2) COMMENT '起租项目申请金额',
    `leased_reply_amount` DECIMAL(16,2) COMMENT '起租项目批复金额',
    `leased_credit_amount` DECIMAL(16,2) COMMENT '起租项目授信金额'
) COMMENT '已审项目转化情况统计'
    ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t'
    LOCATION '/warehouse/financial_lease/ads/ads_credit_audit_finished_transform_stats'
    TBLPROPERTIES ('compression.codec' = 'org.apache.hadoop.io.compress.GzipCodec');
```

#### 数据装载
```plsql
insert overwrite table ads_credit_audit_finished_transform_stats
select dt,
       credit_audit_finished_count,
       credit_audit_finished_apply_amount,
       credit_audit_approved_count,
       credit_audit_approved_apply_amount,
       credit_audit_approved_reply_amount,
       credit_created_count,
       credit_created_apply_amount,
       credit_created_reply_amount,
       credit_created_credit_amount,
       credit_occupied_count,
       credit_occupied_apply_amount,
       credit_occupied_reply_amount,
       credit_occupied_credit_amount,
       contract_produced_count,
       contract_produced_apply_amount,
       contract_produced_reply_amount,
       contract_produced_credit_amount,
       credit_signed_count,
       credit_signed_apply_amount,
       credit_signed_reply_amount,
       credit_signed_credit_amount,
       leased_count,
       leased_apply_amount,
       leased_reply_amount,
       leased_credit_amount
from ads_credit_audit_finished_transform_stats
union
select '2023-05-09' dt,
       sum(if(dt <> '9999-12-31', 1, 0)) credit_audit_finished_count,
       sum(if(dt <> '9999-12-31', credit_amount, 0)) credit_audit_finished_apply_amount,
       sum(if(reply_review_approving_time is not null, 1, 0)) credit_audit_approved_count,
       sum(if(reply_review_approving_time is not null, credit_amount, 0)) credit_audit_approved_apply_amount,
       sum(if(reply_review_approving_time is not null, credit_reply_amount, 0)) credit_audit_approved_reply_amount,
       sum(if(credit_create_time is not null, 1, 0)) credit_created_count,
       sum(if(credit_create_time is not null, credit_amount, 0)) credit_created_apply_amount,
       sum(if(credit_create_time is not null, credit_reply_amount, 0)) credit_created_reply_amount,
       sum(if(credit_create_time is not null, credit_real_amount, 0)) credit_created_credit_amount,
       sum(if(credit_occupy_time is not null, 1, 0)) credit_occupied_count,
       sum(if(credit_occupy_time is not null, credit_amount, 0)) credit_occupied_apply_amount,
       sum(if(credit_occupy_time is not null, credit_reply_amount, 0)) credit_occupied_reply_amount,
       sum(if(credit_occupy_time is not null, credit_real_amount, 0)) credit_occupied_credit_amount,
       sum(if(contract_produce_time is not null, 1, 0)) contract_produced_count,
       sum(if(contract_produce_time is not null, credit_amount, 0)) contract_produced_apply_amount,
       sum(if(contract_produce_time is not null, credit_reply_amount, 0)) contract_produced_reply_amount,
       sum(if(contract_produce_time is not null, credit_real_amount, 0)) contract_produced_credit_amount,
       sum(if(signed_time is not null, 1, 0)) credit_signed_count,
       sum(if(signed_time is not null, credit_amount, 0)) credit_signed_apply_amount,
       sum(if(signed_time is not null, credit_reply_amount, 0)) credit_signed_reply_amount,
       sum(if(signed_time is not null, credit_real_amount, 0)) credit_signed_credit_amount,
       sum(if(execution_time is not null, 1, 0)) leased_count,
       sum(if(execution_time is not null, credit_amount, 0)) leased_apply_amount,
       sum(if(execution_time is not null, credit_reply_amount, 0)) leased_reply_amount,
       sum(if(execution_time is not null, credit_real_amount, 0)) leased_credit_amount
from dwd_financial_lease_flow_acc;
```

直接从dwd层中查询聚合即可

### 整体数据装载脚本
```bash
#!/bin/bash

APP=financial_lease
# 如果是输入的日期按照取输入日期；如果没输入日期取当前时间的前一天
if [ -n "$2" ] ;then
    do_date=$2
else 
    do_date=`date -d "-1 day" +%F`
fi

ads_unfinished_audit_stats="
insert overwrite table ${APP}.ads_unfinished_audit_stats
select dt,
       created_project_count,
       created_project_amount,
       risk_control_not_approved_count,
       risk_control_not_approved_amount,
       credit_audit_approved_count,
       credit_audit_approved_amount,
       feedback_submitted_count,
       feedback_submitted_amount,
       level1_review_approved_count,
       level1_review_approved_amount,
       level2_review_approved_count,
       level2_review_approved_amount,
       review_meeting_approved_count,
       review_meeting_approved_amount,
       general_manager_approved_count,
       general_manager_approved_amount,
       reply_issued_count,
       reply_issued_apply_amount,
       reply_issued_reply_amount
from ${APP}.ads_unfinished_audit_stats
union
select '$do_date'                                                                            dt,
       sum(if(undistributed_time is null and risk_manage_refused_time is null, 1, 0))          created_project_count,
       sum(if(undistributed_time is null and risk_manage_refused_time is null, credit_amount,
              0))                                                                              created_project_amount,
       sum(if(risk_manage_refused_time is not null and undistributed_time is null, 1,
              0))                                                                              risk_control_not_approved_count,
       sum(if(risk_manage_refused_time is not null and undistributed_time is null, credit_amount,
              0))                                                                              risk_control_not_approved_amount,
       sum(if(credit_audit_approving_time is not null and feed_back_time is null, 1,
              0))                                                                              credit_audit_approved_count,
       sum(if(credit_audit_approving_time is not null and feed_back_time is null, credit_amount,
              0))                                                                              credit_audit_approved_amount,
       sum(if(feed_back_time is not null and first_level_review_approving_time is null, 1, 0)) feedback_submitted_count,
       sum(if(feed_back_time is not null and first_level_review_approving_time is null, credit_amount,
              0))                                                                              feedback_submitted_amount,
       sum(if(first_level_review_approving_time is not null and second_level_review_approving_time is null, 1,
              0))                                                                              level1_review_approved_count,
       sum(if(first_level_review_approving_time is not null and second_level_review_approving_time is null,
              credit_amount,
              0))                                                                              level1_review_approved_amount,
       sum(if(second_level_review_approving_time is not null and project_review_meeting_approving_time is null, 1,
              0))                                                                              level2_review_approved_count,
       sum(if(second_level_review_approving_time is not null and project_review_meeting_approving_time is null,
              credit_amount,
              0))                                                                              level2_review_approved_amount,
       sum(if(project_review_meeting_approving_time is not null and general_manager_review_approving_time is null, 1,
              0))                                                                              review_meeting_approved_count,
       sum(if(project_review_meeting_approving_time is not null and general_manager_review_approving_time is null,
              credit_amount,
              0))                                                                              review_meeting_approved_amount,
       sum(if(general_manager_review_approving_time is not null and reply_review_approving_time is null, 1,
              0))                                                                              general_manager_approved_count,
       sum(if(general_manager_review_approving_time is not null and reply_review_approving_time is null, credit_amount,
              0))                                                                              general_manager_approved_amount,
       sum(if(reply_review_approving_time is not null and credit_create_time is null, 1, 0))   reply_issued_count,
       sum(if(reply_review_approving_time is not null and credit_create_time is null, credit_amount,
              0))                                                                              reply_issued_apply_amount,
       sum(if(reply_review_approving_time is not null and credit_create_time is null, credit_reply_amount,
              0))                                                                              reply_issued_reply_amount
from ${APP}.dwd_financial_lease_flow_acc
where dt = '9999-12-31';"

ads_lease_org_unfinished_audit_stats="
insert overwrite table ${APP}.ads_lease_org_unfinished_audit_stats
select dt,
       lease_organization,
       created_project_count,
       created_project_amount,
       risk_control_not_approved_count,
       risk_control_not_approved_amount,
       credit_audit_approved_count,
       credit_audit_approved_amount,
       feedback_submitted_count,
       feedback_submitted_amount,
       level1_review_approved_count,
       level1_review_approved_amount,
       level2_review_approved_count,
       level2_review_approved_amount,
       review_meeting_approved_count,
       review_meeting_approved_amount,
       general_manager_approved_count,
       general_manager_approved_amount,
       reply_issued_count,
       reply_issued_apply_amount,
       reply_issued_reply_amount
from ${APP}.ads_lease_org_unfinished_audit_stats
union
select '$do_date'                                                                            dt,
       lease_organization,
       sum(if(undistributed_time is null and risk_manage_refused_time is null, 1, 0))          created_project_count,
       sum(if(undistributed_time is null and risk_manage_refused_time is null, credit_amount,
              0))                                                                              created_project_amount,
       sum(if(risk_manage_refused_time is not null and undistributed_time is null, 1,
              0))                                                                              risk_control_not_approved_count,
       sum(if(risk_manage_refused_time is not null and undistributed_time is null, credit_amount,
              0))                                                                              risk_control_not_approved_amount,
       sum(if(credit_audit_approving_time is not null and feed_back_time is null, 1,
              0))                                                                              credit_audit_approved_count,
       sum(if(credit_audit_approving_time is not null and feed_back_time is null, credit_amount,
              0))                                                                              credit_audit_approved_amount,
       sum(if(feed_back_time is not null and first_level_review_approving_time is null, 1, 0)) feedback_submitted_count,
       sum(if(feed_back_time is not null and first_level_review_approving_time is null, credit_amount,
              0))                                                                              feedback_submitted_amount,
       sum(if(first_level_review_approving_time is not null and second_level_review_approving_time is null, 1,
              0))                                                                              level1_review_approved_count,
       sum(if(first_level_review_approving_time is not null and second_level_review_approving_time is null,
              credit_amount,
              0))                                                                              level1_review_approved_amount,
       sum(if(second_level_review_approving_time is not null and project_review_meeting_approving_time is null, 1,
              0))                                                                              level2_review_approved_count,
       sum(if(second_level_review_approving_time is not null and project_review_meeting_approving_time is null,
              credit_amount,
              0))                                                                              level2_review_approved_amount,
       sum(if(project_review_meeting_approving_time is not null and general_manager_review_approving_time is null, 1,
              0))                                                                              review_meeting_approved_count,
       sum(if(project_review_meeting_approving_time is not null and general_manager_review_approving_time is null,
              credit_amount,
              0))                                                                              review_meeting_approved_amount,
       sum(if(general_manager_review_approving_time is not null and reply_review_approving_time is null, 1,
              0))                                                                              general_manager_approved_count,
       sum(if(general_manager_review_approving_time is not null and reply_review_approving_time is null, credit_amount,
              0))                                                                              general_manager_approved_amount,
       sum(if(reply_review_approving_time is not null and credit_create_time is null, 1, 0))   reply_issued_count,
       sum(if(reply_review_approving_time is not null and credit_create_time is null, credit_amount,
              0))                                                                              reply_issued_apply_amount,
       sum(if(reply_review_approving_time is not null and credit_create_time is null, credit_reply_amount,
              0))                                                                              reply_issued_reply_amount
from ${APP}.dwd_financial_lease_flow_acc
where dt = '9999-12-31'
group by lease_organization;"

ads_department_unfinished_audit_stats="
insert overwrite table ${APP}.ads_department_unfinished_audit_stats
select dt,
       department3_id,
       department3_name,
       department2_id,
       department2_name,
       department1_id,
       department1_name,
       created_project_count,
       created_project_amount,
       risk_control_not_approved_count,
       risk_control_not_approved_amount,
       credit_audit_approved_count,
       credit_audit_approved_amount,
       feedback_submitted_count,
       feedback_submitted_amount,
       level1_review_approved_count,
       level1_review_approved_amount,
       level2_review_approved_count,
       level2_review_approved_amount,
       review_meeting_approved_count,
       review_meeting_approved_amount,
       general_manager_approved_count,
       general_manager_approved_amount,
       reply_issued_count,
       reply_issued_apply_amount,
       reply_issued_reply_amount
from ${APP}.ads_department_unfinished_audit_stats
union
select dt,
       agg.department3_id,
       department3_name,
       department2_id,
       department2_name,
       department1_id,
       department1_name,
       created_project_count,
       created_project_amount,
       risk_control_not_approved_count,
       risk_control_not_approved_amount,
       credit_audit_approved_count,
       credit_audit_approved_amount,
       feedback_submitted_count,
       feedback_submitted_amount,
       level1_review_approved_count,
       level1_review_approved_amount,
       level2_review_approved_count,
       level2_review_approved_amount,
       review_meeting_approved_count,
       review_meeting_approved_amount,
       general_manager_approved_count,
       general_manager_approved_amount,
       reply_issued_count,
       reply_issued_apply_amount,
       reply_issued_reply_amount
from (select '$do_date'                                                                          dt,
             department3_id,
             sum(if(undistributed_time is null and risk_manage_refused_time is null, 1,
                    0))                                                                            created_project_count,
             sum(if(undistributed_time is null and risk_manage_refused_time is null, credit_amount,
                    0))                                                                            created_project_amount,
             sum(if(risk_manage_refused_time is not null and undistributed_time is null, 1,
                    0))                                                                            risk_control_not_approved_count,
             sum(if(risk_manage_refused_time is not null and undistributed_time is null, credit_amount,
                    0))                                                                            risk_control_not_approved_amount,
             sum(if(credit_audit_approving_time is not null and feed_back_time is null, 1,
                    0))                                                                            credit_audit_approved_count,
             sum(if(credit_audit_approving_time is not null and feed_back_time is null, credit_amount,
                    0))                                                                            credit_audit_approved_amount,
             sum(if(feed_back_time is not null and first_level_review_approving_time is null, 1,
                    0))                                                                            feedback_submitted_count,
             sum(if(feed_back_time is not null and first_level_review_approving_time is null, credit_amount,
                    0))                                                                            feedback_submitted_amount,
             sum(if(first_level_review_approving_time is not null and second_level_review_approving_time is null, 1,
                    0))                                                                            level1_review_approved_count,
             sum(if(first_level_review_approving_time is not null and second_level_review_approving_time is null,
                    credit_amount,
                    0))                                                                            level1_review_approved_amount,
             sum(if(second_level_review_approving_time is not null and project_review_meeting_approving_time is null, 1,
                    0))                                                                            level2_review_approved_count,
             sum(if(second_level_review_approving_time is not null and project_review_meeting_approving_time is null,
                    credit_amount,
                    0))                                                                            level2_review_approved_amount,
             sum(if(project_review_meeting_approving_time is not null and general_manager_review_approving_time is null,
                    1,
                    0))                                                                            review_meeting_approved_count,
             sum(if(project_review_meeting_approving_time is not null and general_manager_review_approving_time is null,
                    credit_amount,
                    0))                                                                            review_meeting_approved_amount,
             sum(if(general_manager_review_approving_time is not null and reply_review_approving_time is null, 1,
                    0))                                                                            general_manager_approved_count,
             sum(if(general_manager_review_approving_time is not null and reply_review_approving_time is null,
                    credit_amount,
                    0))                                                                            general_manager_approved_amount,
             sum(if(reply_review_approving_time is not null and credit_create_time is null, 1, 0)) reply_issued_count,
             sum(if(reply_review_approving_time is not null and credit_create_time is null, credit_amount,
                    0))                                                                            reply_issued_apply_amount,
             sum(if(reply_review_approving_time is not null and credit_create_time is null, credit_reply_amount,
                    0))                                                                            reply_issued_reply_amount
      from (select *
            from ${APP}.dwd_financial_lease_flow_acc
            where dt = '9999-12-31') acc
               left join (select id,
                                 department3_id
                          from ${APP}.dim_employee_full
                          where dt = '$do_date') emp
                         on acc.salesman_id = emp.id
      group by department3_id) agg
         left join
     (select department3_id,
             department3_name,
             department2_id,
             department2_name,
             department1_id,
             department1_name
      from ${APP}.dim_department_full
      where dt = '$do_date') department
     on agg.department3_id = department.department3_id;
msck repair table ${APP}.dim_department_full;"

ads_salesman_unfinished_audit_stats="
insert overwrite table ${APP}.ads_salesman_unfinished_audit_stats
select dt,
       salesman_id,
       salesman_name,
       created_project_count,
       created_project_amount,
       risk_control_not_approved_count,
       risk_control_not_approved_amount,
       credit_audit_approved_count,
       credit_audit_approved_amount,
       feedback_submitted_count,
       feedback_submitted_amount,
       level1_review_approved_count,
       level1_review_approved_amount,
       level2_review_approved_count,
       level2_review_approved_amount,
       review_meeting_approved_count,
       review_meeting_approved_amount,
       general_manager_approved_count,
       general_manager_approved_amount,
       reply_issued_count,
       reply_issued_apply_amount,
       reply_issued_reply_amount
from ${APP}.ads_salesman_unfinished_audit_stats
union
select dt,
       salesman_id,
       emp.name salesman_name,
       created_project_count,
       created_project_amount,
       risk_control_not_approved_count,
       risk_control_not_approved_amount,
       credit_audit_approved_count,
       credit_audit_approved_amount,
       feedback_submitted_count,
       feedback_submitted_amount,
       level1_review_approved_count,
       level1_review_approved_amount,
       level2_review_approved_count,
       level2_review_approved_amount,
       review_meeting_approved_count,
       review_meeting_approved_amount,
       general_manager_approved_count,
       general_manager_approved_amount,
       reply_issued_count,
       reply_issued_apply_amount,
       reply_issued_reply_amount
from (select '$do_date'                                                                          dt,
             salesman_id,
             sum(if(undistributed_time is null and risk_manage_refused_time is null, 1,
                    0))                                                                            created_project_count,
             sum(if(undistributed_time is null and risk_manage_refused_time is null, credit_amount,
                    0))                                                                            created_project_amount,
             sum(if(risk_manage_refused_time is not null and undistributed_time is null, 1,
                    0))                                                                            risk_control_not_approved_count,
             sum(if(risk_manage_refused_time is not null and undistributed_time is null, credit_amount,
                    0))                                                                            risk_control_not_approved_amount,
             sum(if(credit_audit_approving_time is not null and feed_back_time is null, 1,
                    0))                                                                            credit_audit_approved_count,
             sum(if(credit_audit_approving_time is not null and feed_back_time is null, credit_amount,
                    0))                                                                            credit_audit_approved_amount,
             sum(if(feed_back_time is not null and first_level_review_approving_time is null, 1,
                    0))                                                                            feedback_submitted_count,
             sum(if(feed_back_time is not null and first_level_review_approving_time is null, credit_amount,
                    0))                                                                            feedback_submitted_amount,
             sum(if(first_level_review_approving_time is not null and second_level_review_approving_time is null, 1,
                    0))                                                                            level1_review_approved_count,
             sum(if(first_level_review_approving_time is not null and second_level_review_approving_time is null,
                    credit_amount,
                    0))                                                                            level1_review_approved_amount,
             sum(if(second_level_review_approving_time is not null and project_review_meeting_approving_time is null, 1,
                    0))                                                                            level2_review_approved_count,
             sum(if(second_level_review_approving_time is not null and project_review_meeting_approving_time is null,
                    credit_amount,
                    0))                                                                            level2_review_approved_amount,
             sum(if(project_review_meeting_approving_time is not null and general_manager_review_approving_time is null,
                    1,
                    0))                                                                            review_meeting_approved_count,
             sum(if(project_review_meeting_approving_time is not null and general_manager_review_approving_time is null,
                    credit_amount,
                    0))                                                                            review_meeting_approved_amount,
             sum(if(general_manager_review_approving_time is not null and reply_review_approving_time is null, 1,
                    0))                                                                            general_manager_approved_count,
             sum(if(general_manager_review_approving_time is not null and reply_review_approving_time is null,
                    credit_amount,
                    0))                                                                            general_manager_approved_amount,
             sum(if(reply_review_approving_time is not null and credit_create_time is null, 1, 0)) reply_issued_count,
             sum(if(reply_review_approving_time is not null and credit_create_time is null, credit_amount,
                    0))                                                                            reply_issued_apply_amount,
             sum(if(reply_review_approving_time is not null and credit_create_time is null, credit_reply_amount,
                    0))                                                                            reply_issued_reply_amount
      from ${APP}.dwd_financial_lease_flow_acc
      where dt = '9999-12-31'
      group by salesman_id) agg
         left join (
    select id,
           name
    from ${APP}.dim_employee_full
    where dt = '$do_date'
) emp on agg.salesman_id = emp.id;"

ads_credit_audit_unfinished_audit_stats="
insert overwrite table ${APP}.ads_credit_audit_unfinished_audit_stats
select dt,
       credit_audit_id,
       credit_audit_name,
       credit_audit_approved_count,
       credit_audit_approved_amount,
       feedback_submitted_count,
       feedback_submitted_amount,
       level1_review_approved_count,
       level1_review_approved_amount,
       level2_review_approved_count,
       level2_review_approved_amount,
       review_meeting_approved_count,
       review_meeting_approved_amount,
       general_manager_approved_count,
       general_manager_approved_amount,
       reply_issued_count,
       reply_issued_apply_amount,
       reply_issued_reply_amount
from ${APP}.ads_credit_audit_unfinished_audit_stats
union
select '$do_date' dt,
       credit_audit_id,
       name         credit_audit_name,
       credit_audit_approved_count,
       credit_audit_approved_amount,
       feedback_submitted_count,
       feedback_submitted_amount,
       level1_review_approved_count,
       level1_review_approved_amount,
       level2_review_approved_count,
       level2_review_approved_amount,
       review_meeting_approved_count,
       review_meeting_approved_amount,
       general_manager_approved_count,
       general_manager_approved_amount,
       reply_issued_count,
       reply_issued_apply_amount,
       reply_issued_reply_amount
from (select '$do_date'                                                                          dt,
             credit_audit_id,
             sum(if(credit_audit_approving_time is not null and feed_back_time is null, 1,
                    0))                                                                            credit_audit_approved_count,
             sum(if(credit_audit_approving_time is not null and feed_back_time is null, credit_amount,
                    0))                                                                            credit_audit_approved_amount,
             sum(if(feed_back_time is not null and first_level_review_approving_time is null, 1,
                    0))                                                                            feedback_submitted_count,
             sum(if(feed_back_time is not null and first_level_review_approving_time is null, credit_amount,
                    0))                                                                            feedback_submitted_amount,
             sum(if(first_level_review_approving_time is not null and second_level_review_approving_time is null, 1,
                    0))                                                                            level1_review_approved_count,
             sum(if(first_level_review_approving_time is not null and second_level_review_approving_time is null,
                    credit_amount,
                    0))                                                                            level1_review_approved_amount,
             sum(if(second_level_review_approving_time is not null and project_review_meeting_approving_time is null, 1,
                    0))                                                                            level2_review_approved_count,
             sum(if(second_level_review_approving_time is not null and project_review_meeting_approving_time is null,
                    credit_amount,
                    0))                                                                            level2_review_approved_amount,
             sum(if(project_review_meeting_approving_time is not null and general_manager_review_approving_time is null,
                    1,
                    0))                                                                            review_meeting_approved_count,
             sum(if(project_review_meeting_approving_time is not null and general_manager_review_approving_time is null,
                    credit_amount,
                    0))                                                                            review_meeting_approved_amount,
             sum(if(general_manager_review_approving_time is not null and reply_review_approving_time is null, 1,
                    0))                                                                            general_manager_approved_count,
             sum(if(general_manager_review_approving_time is not null and reply_review_approving_time is null,
                    credit_amount,
                    0))                                                                            general_manager_approved_amount,
             sum(if(reply_review_approving_time is not null and credit_create_time is null, 1, 0)) reply_issued_count,
             sum(if(reply_review_approving_time is not null and credit_create_time is null, credit_amount,
                    0))                                                                            reply_issued_apply_amount,
             sum(if(reply_review_approving_time is not null and credit_create_time is null, credit_reply_amount,
                    0))                                                                            reply_issued_reply_amount
      from ${APP}.dwd_financial_lease_flow_acc
      where dt = '9999-12-31'
        and credit_audit_id is not null
      group by credit_audit_id) acc
         left join
     (select id,
             name
      from ${APP}.dim_employee_full
      where dt = '$do_date') emp
     on acc.credit_audit_id = emp.id;"

ads_industry_unfinished_audit_stats="
insert overwrite table ${APP}.ads_industry_unfinished_audit_stats
select dt,
       industry3_id,
       industry3_name,
       industry2_id,
       industry2_name,
       industry1_id,
       industry1_name,
       created_project_count,
       created_project_amount,
       risk_control_not_approved_count,
       risk_control_not_approved_amount,
       credit_audit_approved_count,
       credit_audit_approved_amount,
       feedback_submitted_count,
       feedback_submitted_amount,
       level1_review_approved_count,
       level1_review_approved_amount,
       level2_review_approved_count,
       level2_review_approved_amount,
       review_meeting_approved_count,
       review_meeting_approved_amount,
       general_manager_approved_count,
       general_manager_approved_amount,
       reply_issued_count,
       reply_issued_apply_amount,
       reply_issued_reply_amount
from ${APP}.ads_industry_unfinished_audit_stats
union
select dt,
       agg.industry3_id,
       industry3_name,
       industry2_id,
       industry2_name,
       industry1_id,
       industry1_name,
       created_project_count,
       created_project_amount,
       risk_control_not_approved_count,
       risk_control_not_approved_amount,
       credit_audit_approved_count,
       credit_audit_approved_amount,
       feedback_submitted_count,
       feedback_submitted_amount,
       level1_review_approved_count,
       level1_review_approved_amount,
       level2_review_approved_count,
       level2_review_approved_amount,
       review_meeting_approved_count,
       review_meeting_approved_amount,
       general_manager_approved_count,
       general_manager_approved_amount,
       reply_issued_count,
       reply_issued_apply_amount,
       reply_issued_reply_amount
from (select '$do_date'                                                                          dt,
             industry3_id,
             sum(if(undistributed_time is null and risk_manage_refused_time is null, 1,
                    0))                                                                            created_project_count,
             sum(if(undistributed_time is null and risk_manage_refused_time is null, credit_amount,
                    0))                                                                            created_project_amount,
             sum(if(risk_manage_refused_time is not null and undistributed_time is null, 1,
                    0))                                                                            risk_control_not_approved_count,
             sum(if(risk_manage_refused_time is not null and undistributed_time is null, credit_amount,
                    0))                                                                            risk_control_not_approved_amount,
             sum(if(credit_audit_approving_time is not null and feed_back_time is null, 1,
                    0))                                                                            credit_audit_approved_count,
             sum(if(credit_audit_approving_time is not null and feed_back_time is null, credit_amount,
                    0))                                                                            credit_audit_approved_amount,
             sum(if(feed_back_time is not null and first_level_review_approving_time is null, 1,
                    0))                                                                            feedback_submitted_count,
             sum(if(feed_back_time is not null and first_level_review_approving_time is null, credit_amount,
                    0))                                                                            feedback_submitted_amount,
             sum(if(first_level_review_approving_time is not null and second_level_review_approving_time is null, 1,
                    0))                                                                            level1_review_approved_count,
             sum(if(first_level_review_approving_time is not null and second_level_review_approving_time is null,
                    credit_amount,
                    0))                                                                            level1_review_approved_amount,
             sum(if(second_level_review_approving_time is not null and project_review_meeting_approving_time is null, 1,
                    0))                                                                            level2_review_approved_count,
             sum(if(second_level_review_approving_time is not null and project_review_meeting_approving_time is null,
                    credit_amount,
                    0))                                                                            level2_review_approved_amount,
             sum(if(project_review_meeting_approving_time is not null and general_manager_review_approving_time is null,
                    1,
                    0))                                                                            review_meeting_approved_count,
             sum(if(project_review_meeting_approving_time is not null and general_manager_review_approving_time is null,
                    credit_amount,
                    0))                                                                            review_meeting_approved_amount,
             sum(if(general_manager_review_approving_time is not null and reply_review_approving_time is null, 1,
                    0))                                                                            general_manager_approved_count,
             sum(if(general_manager_review_approving_time is not null and reply_review_approving_time is null,
                    credit_amount,
                    0))                                                                            general_manager_approved_amount,
             sum(if(reply_review_approving_time is not null and credit_create_time is null, 1, 0)) reply_issued_count,
             sum(if(reply_review_approving_time is not null and credit_create_time is null, credit_amount,
                    0))                                                                            reply_issued_apply_amount,
             sum(if(reply_review_approving_time is not null and credit_create_time is null, credit_reply_amount,
                    0))                                                                            reply_issued_reply_amount
      from ${APP}.dwd_financial_lease_flow_acc
      where dt = '9999-12-31'
      group by industry3_id) agg
         left join
     (select industry3_id,
             industry3_name,
             industry2_id,
             industry2_name,
             industry1_id,
             industry1_name
      from ${APP}.dim_industry_full
      where dt = '$do_date') ind
     on agg.industry3_id = ind.industry3_id;"

ads_finished_audit_stats="
insert overwrite table ${APP}.ads_finished_audit_stats
select dt,
       audit_approved_count,
       audit_approved_apply_amount,
       audit_approved_reply_amount,
       apply_cancel_count,
       apply_cancel_apply_amount,
       audit_refused_count,
       audit_refused_apply_amount
from ${APP}.ads_finished_audit_stats
union
select '$do_date'                                                             dt,
       sum(if(reply_review_approving_time is not null, 1, 0))                   audit_approved_count,
       sum(if(reply_review_approving_time is not null, credit_amount, 0))       audit_approved_apply_amount,
       sum(if(reply_review_approving_time is not null, credit_reply_amount, 0)) audit_approved_reply_amount,
       sum(if(cancel_time is not null, 1, 0))                                   apply_cancel_count,
       sum(if(cancel_time is not null, credit_amount, 0))                       apply_cancel_apply_amount,
       sum(if(rejected_time is not null, 1, 0))                                 audit_refused_count,
       sum(if(rejected_time is not null, credit_amount, 0))                     audit_refused_apply_amount
from ${APP}.dwd_financial_lease_flow_acc;"

ads_lease_org_finished_audit_stats="
insert overwrite table ${APP}.ads_lease_org_finished_audit_stats
select dt,
       lease_organization,
       audit_approved_count,
       audit_approved_apply_amount,
       audit_approved_reply_amount,
       apply_cancel_count,
       apply_cancel_apply_amount,
       audit_refused_count,
       audit_refused_apply_amount
from ${APP}.ads_lease_org_finished_audit_stats
union
select '$do_date'                                                             dt,
       lease_organization,
       sum(if(reply_review_approving_time is not null, 1, 0))                   audit_approved_count,
       sum(if(reply_review_approving_time is not null, credit_amount, 0))       audit_approved_apply_amount,
       sum(if(reply_review_approving_time is not null, credit_reply_amount, 0)) audit_approved_reply_amount,
       sum(if(cancel_time is not null, 1, 0))                                   apply_cancel_count,
       sum(if(cancel_time is not null, credit_amount, 0))                       apply_cancel_apply_amount,
       sum(if(rejected_time is not null, 1, 0))                                 audit_refused_count,
       sum(if(rejected_time is not null, credit_amount, 0))                     audit_refused_apply_amount
from ${APP}.dwd_financial_lease_flow_acc
group by lease_organization;"

ads_department_finished_audit_stats="
insert overwrite table ${APP}.ads_department_finished_audit_stats
select dt,
       department3_id,
       department3_name,
       department2_id,
       department2_name,
       department1_id,
       department1_name,
       audit_approved_count,
       audit_approved_apply_amount,
       audit_approved_reply_amount,
       apply_cancel_count,
       apply_cancel_apply_amount,
       audit_refused_count,
       audit_refused_apply_amount
from ${APP}.ads_department_finished_audit_stats
union
select dt,
       agg.department3_id,
       department3_name,
       department2_id,
       department2_name,
       department1_id,
       department1_name,
       audit_approved_count,
       audit_approved_apply_amount,
       audit_approved_reply_amount,
       apply_cancel_count,
       apply_cancel_apply_amount,
       audit_refused_count,
       audit_refused_apply_amount
from (select '$do_date'                                                             dt,
             department3_id,
             sum(if(reply_review_approving_time is not null, 1, 0))                   audit_approved_count,
             sum(if(reply_review_approving_time is not null, credit_amount, 0))       audit_approved_apply_amount,
             sum(if(reply_review_approving_time is not null, credit_reply_amount, 0)) audit_approved_reply_amount,
             sum(if(cancel_time is not null, 1, 0))                                   apply_cancel_count,
             sum(if(cancel_time is not null, credit_amount, 0))                       apply_cancel_apply_amount,
             sum(if(rejected_time is not null, 1, 0))                                 audit_refused_count,
             sum(if(rejected_time is not null, credit_amount, 0))                     audit_refused_apply_amount
      from ${APP}.dwd_financial_lease_flow_acc
               left join (select id,
                                 department3_id
                          from ${APP}.dim_employee_full
                          where dt = '$do_date') emp
                         on salesman_id = emp.id
      group by department3_id) agg
         left join (
    select department3_id,
           department3_name,
           department2_id,
           department2_name,
           department1_id,
           department1_name
    from ${APP}.dim_department_full
    where dt = '$do_date') department
                   on agg.department3_id = department.department3_id;"

ads_salesman_finished_audit_stats="
insert overwrite table ${APP}.ads_salesman_finished_audit_stats
select dt,
       salesman_id,
       salesman_name,
       audit_approved_count,
       audit_approved_apply_amount,
       audit_approved_reply_amount,
       apply_cancel_count,
       apply_cancel_apply_amount,
       audit_refused_count,
       audit_refused_apply_amount
from ${APP}.ads_salesman_finished_audit_stats
union
select dt,
       salesman_id,
       name salesman_name,
       audit_approved_count,
       audit_approved_apply_amount,
       audit_approved_reply_amount,
       apply_cancel_count,
       apply_cancel_apply_amount,
       audit_refused_count,
       audit_refused_apply_amount
from (select '$do_date'                                                             dt,
             salesman_id,
             sum(if(reply_review_approving_time is not null, 1, 0))                   audit_approved_count,
             sum(if(reply_review_approving_time is not null, credit_amount, 0))       audit_approved_apply_amount,
             sum(if(reply_review_approving_time is not null, credit_reply_amount, 0)) audit_approved_reply_amount,
             sum(if(cancel_time is not null, 1, 0))                                   apply_cancel_count,
             sum(if(cancel_time is not null, credit_amount, 0))                       apply_cancel_apply_amount,
             sum(if(rejected_time is not null, 1, 0))                                 audit_refused_count,
             sum(if(rejected_time is not null, credit_amount, 0))                     audit_refused_apply_amount
      from ${APP}.dwd_financial_lease_flow_acc
      group by salesman_id) agg
         left join (
    select id,
           name
    from ${APP}.dim_employee_full
    where dt = '$do_date'
) emp on agg.salesman_id = emp.id;"

ads_credit_audit_finished_audit_stats="
insert overwrite table ${APP}.ads_credit_audit_finished_audit_stats
select dt,
       credit_audit_id,
       credit_audit_name,
       audit_approved_count,
       audit_approved_apply_amount,
       audit_approved_reply_amount,
       apply_cancel_count,
       apply_cancel_apply_amount,
       audit_refused_count,
       audit_refused_apply_amount
from ${APP}.ads_credit_audit_finished_audit_stats
union
select dt,
       credit_audit_id,
       name credit_audit_name,
       audit_approved_count,
       audit_approved_apply_amount,
       audit_approved_reply_amount,
       apply_cancel_count,
       apply_cancel_apply_amount,
       audit_refused_count,
       audit_refused_apply_amount
from (select '$do_date'                                                             dt,
             credit_audit_id,
             sum(if(reply_review_approving_time is not null, 1, 0))                   audit_approved_count,
             sum(if(reply_review_approving_time is not null, credit_amount, 0))       audit_approved_apply_amount,
             sum(if(reply_review_approving_time is not null, credit_reply_amount, 0)) audit_approved_reply_amount,
             sum(if(cancel_time is not null, 1, 0))                                   apply_cancel_count,
             sum(if(cancel_time is not null, credit_amount, 0))                       apply_cancel_apply_amount,
             sum(if(rejected_time is not null, 1, 0))                                 audit_refused_count,
             sum(if(rejected_time is not null, credit_amount, 0))                     audit_refused_apply_amount
      from ${APP}.dwd_financial_lease_flow_acc
      where credit_audit_id is not null
      group by credit_audit_id) agg
         left join
     (select id,
             name
      from ${APP}.dim_employee_full
      where dt = '$do_date') emp on credit_audit_id = emp.id;"

ads_industry_finished_audit_stats="
insert overwrite table ${APP}.ads_industry_finished_audit_stats
select dt,
       industry3_id,
       industry3_name,
       industry2_id,
       industry2_name,
       industry1_id,
       industry1_name,
       audit_approved_count,
       audit_approved_apply_amount,
       audit_approved_reply_amount,
       apply_cancel_count,
       apply_cancel_apply_amount,
       audit_refused_count,
       audit_refused_apply_amount
from ${APP}.ads_industry_finished_audit_stats
union
select dt,
       agg.industry3_id,
       industry3_name,
       industry2_id,
       industry2_name,
       industry1_id,
       industry1_name,
       audit_approved_count,
       audit_approved_apply_amount,
       audit_approved_reply_amount,
       apply_cancel_count,
       apply_cancel_apply_amount,
       audit_refused_count,
       audit_refused_apply_amount
from (select '$do_date'                                                             dt,
             industry3_id,
             sum(if(reply_review_approving_time is not null, 1, 0))                   audit_approved_count,
             sum(if(reply_review_approving_time is not null, credit_amount, 0))       audit_approved_apply_amount,
             sum(if(reply_review_approving_time is not null, credit_reply_amount, 0)) audit_approved_reply_amount,
             sum(if(cancel_time is not null, 1, 0))                                   apply_cancel_count,
             sum(if(cancel_time is not null, credit_amount, 0))                       apply_cancel_apply_amount,
             sum(if(rejected_time is not null, 1, 0))                                 audit_refused_count,
             sum(if(rejected_time is not null, credit_amount, 0))                     audit_refused_apply_amount
      from ${APP}.dwd_financial_lease_flow_acc
      group by industry3_id) agg
         left join (
    select industry3_id,
           industry3_name,
           industry2_id,
           industry2_name,
           industry1_id,
           industry1_name
    from ${APP}.dim_industry_full
    where dt = '$do_date') industry on agg.industry3_id = industry.industry3_id;"

ads_credit_audit_finished_transform_stats="
insert overwrite table ${APP}.ads_credit_audit_finished_transform_stats
select dt,
       credit_audit_finished_count,
       credit_audit_finished_apply_amount,
       credit_audit_approved_count,
       credit_audit_approved_apply_amount,
       credit_audit_approved_reply_amount,
       credit_created_count,
       credit_created_apply_amount,
       credit_created_reply_amount,
       credit_created_credit_amount,
       credit_occupied_count,
       credit_occupied_apply_amount,
       credit_occupied_reply_amount,
       credit_occupied_credit_amount,
       contract_produced_count,
       contract_produced_apply_amount,
       contract_produced_reply_amount,
       contract_produced_credit_amount,
       credit_signed_count,
       credit_signed_apply_amount,
       credit_signed_reply_amount,
       credit_signed_credit_amount,
       leased_count,
       leased_apply_amount,
       leased_reply_amount,
       leased_credit_amount
from ${APP}.ads_credit_audit_finished_transform_stats
union
select '$do_date' dt,
       sum(if(dt <> '9999-12-31', 1, 0)) credit_audit_finished_count,
       sum(if(dt <> '9999-12-31', credit_amount, 0)) credit_audit_finished_apply_amount,
       sum(if(reply_review_approving_time is not null, 1, 0)) credit_audit_approved_count,
       sum(if(reply_review_approving_time is not null, credit_amount, 0)) credit_audit_approved_apply_amount,
       sum(if(reply_review_approving_time is not null, credit_reply_amount, 0)) credit_audit_approved_reply_amount,
       sum(if(credit_create_time is not null, 1, 0)) credit_created_count,
       sum(if(credit_create_time is not null, credit_amount, 0)) credit_created_apply_amount,
       sum(if(credit_create_time is not null, credit_reply_amount, 0)) credit_created_reply_amount,
       sum(if(credit_create_time is not null, credit_real_amount, 0)) credit_created_credit_amount,
       sum(if(credit_occupy_time is not null, 1, 0)) credit_occupied_count,
       sum(if(credit_occupy_time is not null, credit_amount, 0)) credit_occupied_apply_amount,
       sum(if(credit_occupy_time is not null, credit_reply_amount, 0)) credit_occupied_reply_amount,
       sum(if(credit_occupy_time is not null, credit_real_amount, 0)) credit_occupied_credit_amount,
       sum(if(contract_produce_time is not null, 1, 0)) contract_produced_count,
       sum(if(contract_produce_time is not null, credit_amount, 0)) contract_produced_apply_amount,
       sum(if(contract_produce_time is not null, credit_reply_amount, 0)) contract_produced_reply_amount,
       sum(if(contract_produce_time is not null, credit_real_amount, 0)) contract_produced_credit_amount,
       sum(if(signed_time is not null, 1, 0)) credit_signed_count,
       sum(if(signed_time is not null, credit_amount, 0)) credit_signed_apply_amount,
       sum(if(signed_time is not null, credit_reply_amount, 0)) credit_signed_reply_amount,
       sum(if(signed_time is not null, credit_real_amount, 0)) credit_signed_credit_amount,
       sum(if(execution_time is not null, 1, 0)) leased_count,
       sum(if(execution_time is not null, credit_amount, 0)) leased_apply_amount,
       sum(if(execution_time is not null, credit_reply_amount, 0)) leased_reply_amount,
       sum(if(execution_time is not null, credit_real_amount, 0)) leased_credit_amount
from ${APP}.dwd_financial_lease_flow_acc;"

case $1 in
    "ads_unfinished_audit_stats" )
        hive -e "$ads_unfinished_audit_stats"
    ;;
    "ads_lease_org_unfinished_audit_stats" )
        hive -e "$ads_lease_org_unfinished_audit_stats"
    ;;
    "ads_department_unfinished_audit_stats" )
        hive -e "$ads_department_unfinished_audit_stats"
    ;;
    "ads_salesman_unfinished_audit_stats" )
        hive -e "$ads_salesman_unfinished_audit_stats"
    ;;
    "ads_credit_audit_unfinished_audit_stats" )
        hive -e "$ads_credit_audit_unfinished_audit_stats"
    ;;
    "ads_industry_unfinished_audit_stats" )
        hive -e "$ads_industry_unfinished_audit_stats"
    ;;
    "ads_finished_audit_stats" )
        hive -e "$ads_finished_audit_stats"
    ;;
    "ads_lease_org_finished_audit_stats" )
        hive -e "$ads_lease_org_finished_audit_stats"
    ;;
    "ads_department_finished_audit_stats" )
        hive -e "$ads_department_finished_audit_stats"
    ;;
    "ads_salesman_finished_audit_stats" )
        hive -e "$ads_salesman_finished_audit_stats"
    ;;
    "ads_credit_audit_finished_audit_stats" )
        hive -e "$ads_credit_audit_finished_audit_stats"
    ;;
    "ads_industry_finished_audit_stats" )
        hive -e "$ads_industry_finished_audit_stats"
    ;;
    "ads_credit_audit_finished_transform_stats" )
        hive -e "$ads_credit_audit_finished_transform_stats"
    ;;

    "all" )
        hive -e "$ads_unfinished_audit_stats$ads_lease_org_unfinished_audit_stats$ads_department_unfinished_audit_stats$ads_salesman_unfinished_audit_stats$ads_credit_audit_unfinished_audit_stats$ads_industry_unfinished_audit_stats$ads_finished_audit_stats$ads_lease_org_finished_audit_stats$ads_department_finished_audit_stats$ads_salesman_finished_audit_stats$ads_credit_audit_finished_audit_stats$ads_industry_finished_audit_stats$ads_credit_audit_finished_transform_stats"
    ;;
esac

```

## 报表数据导出
### 建表
首先创建数据库`financial_report`：

```plsql
CREATE DATABASE IF NOT EXISTS financial_report DEFAULT CHARSET utf8mb4 COLLATE utf8mb4_general_ci;
```

然后建表，根据ads层的13张表在MySQL中建表：

```plsql
DROP TABLE IF EXISTS ads_unfinished_audit_stats;
CREATE TABLE `ads_unfinished_audit_stats`
(
    `dt`                               date           DEFAULT NULL COMMENT ' 统计日期 ',
    `created_project_count`            bigint         DEFAULT NULL COMMENT ' 新建状态项目数 ',
    `created_project_amount`           decimal(16, 2) DEFAULT NULL COMMENT ' 新建状态项目申请金额 ',
    `risk_control_not_approved_count`  bigint         DEFAULT NULL COMMENT ' 未达风控状态项目数 ',
    `risk_control_not_approved_amount` decimal(16, 2) DEFAULT NULL COMMENT ' 未达风控状态项目申请金额 ',
    `credit_audit_approved_count`      bigint         DEFAULT NULL COMMENT ' 信审经办审核通过状态项目数 ',
    `credit_audit_approved_amount`     decimal(16, 2) DEFAULT NULL COMMENT ' 信审经办审核通过状态项目申请金额 ',
    `feedback_submitted_count`         bigint         DEFAULT NULL COMMENT ' 已提交业务反馈状态项目数 ',
    `feedback_submitted_amount`        decimal(16, 2) DEFAULT NULL COMMENT ' 已提交业务反馈状态项目申请金额 ',
    `level1_review_approved_count`     bigint         DEFAULT NULL COMMENT ' 一级评审通过状态项目数 ',
    `level1_review_approved_amount`    decimal(16, 2) DEFAULT NULL COMMENT ' 一级评审通过状态项目申请金额 ',
    `level2_review_approved_count`     bigint         DEFAULT NULL COMMENT ' 二级评审通过状态项目数 ',
    `level2_review_approved_amount`    decimal(16, 2) DEFAULT NULL COMMENT ' 二级评审通过状态项目申请金额 ',
    `review_meeting_approved_count`    bigint         DEFAULT NULL COMMENT ' 项目评审会审核通过状态项目数 ',
    `review_meeting_approved_amount`   decimal(16, 2) DEFAULT NULL COMMENT ' 项目评审会审核通过状态项目申请金额 ',
    `general_manager_approved_count`   bigint         DEFAULT NULL COMMENT ' 总经理/分管总审核通过状态项目数 ',
    `general_manager_approved_amount`  decimal(16, 2) DEFAULT NULL COMMENT ' 总经理/分管总审核通过状态项目申请金额 ',
    `reply_issued_count`               bigint         DEFAULT NULL COMMENT ' 出具批复状态项目数 ',
    `reply_issued_apply_amount`        decimal(16, 2) DEFAULT NULL COMMENT ' 出具批复状态项目申请金额 ',
    `reply_issued_reply_amount`        decimal(16, 2) DEFAULT NULL COMMENT ' 出具批复状态项目批复金额 '
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_general_ci COMMENT ='待审/在审项目综合统计';


DROP TABLE IF EXISTS ads_lease_org_unfinished_audit_stats;
CREATE TABLE `ads_lease_org_unfinished_audit_stats`
(
    `dt`                               date                                    DEFAULT NULL COMMENT ' 统计日期 ',
    `lease_organization`               varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT ' 业务方向 ',
    `created_project_count`            bigint                                  DEFAULT NULL COMMENT ' 新建状态项目数 ',
    `created_project_amount`           decimal(16, 2)                          DEFAULT NULL COMMENT ' 新建状态项目申请金额 ',
    `risk_control_not_approved_count`  bigint                                  DEFAULT NULL COMMENT ' 未达风控状态项目数 ',
    `risk_control_not_approved_amount` decimal(16, 2)                          DEFAULT NULL COMMENT ' 未达风控状态项目申请金额 ',
    `credit_audit_approved_count`      bigint                                  DEFAULT NULL COMMENT ' 信审经办审核通过状态项目数 ',
    `credit_audit_approved_amount`     decimal(16, 2)                          DEFAULT NULL COMMENT ' 信审经办审核通过状态项目申请金额 ',
    `feedback_submitted_count`         bigint                                  DEFAULT NULL COMMENT ' 已提交业务反馈状态项目数 ',
    `feedback_submitted_amount`        decimal(16, 2)                          DEFAULT NULL COMMENT ' 已提交业务反馈状态项目申请金额 ',
    `level1_review_approved_count`     bigint                                  DEFAULT NULL COMMENT ' 一级评审通过状态项目数 ',
    `level1_review_approved_amount`    decimal(16, 2)                          DEFAULT NULL COMMENT ' 一级评审通过状态项目申请金额 ',
    `level2_review_approved_count`     bigint                                  DEFAULT NULL COMMENT ' 二级评审通过状态项目数 ',
    `level2_review_approved_amount`    decimal(16, 2)                          DEFAULT NULL COMMENT ' 二级评审通过状态项目申请金额 ',
    `review_meeting_approved_count`    bigint                                  DEFAULT NULL COMMENT ' 项目评审会审核通过状态项目数 ',
    `review_meeting_approved_amount`   decimal(16, 2)                          DEFAULT NULL COMMENT ' 项目评审会审核通过状态项目申请金额 ',
    `general_manager_approved_count`   bigint                                  DEFAULT NULL COMMENT ' 总经理/分管总审核通过状态项目数 ',
    `general_manager_approved_amount`  decimal(16, 2)                          DEFAULT NULL COMMENT ' 总经理/分管总审核通过状态项目申请金额 ',
    `reply_issued_count`               bigint                                  DEFAULT NULL COMMENT ' 出具批复状态项目数 ',
    `reply_issued_apply_amount`        decimal(16, 2)                          DEFAULT NULL COMMENT ' 出具批复状态项目申请金额 ',
    `reply_issued_reply_amount`        decimal(16, 2)                          DEFAULT NULL COMMENT ' 出具批复状态项目批复金额 '
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_general_ci COMMENT ='各业务方向待审/在审项目统计';


DROP TABLE IF EXISTS ads_department_unfinished_audit_stats;
CREATE TABLE `ads_department_unfinished_audit_stats`
(
    `dt`                               date                                    DEFAULT NULL COMMENT ' 统计日期 ',
    `department3_id`                   varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT ' 三级部门ID ',
    `department3_name`                 varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT ' 三级部门名称 ',
    `department2_id`                   varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT ' 二级部门ID ',
    `department2_name`                 varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT ' 二级部门名称 ',
    `department1_id`                   varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT ' 一级部门ID ',
    `department1_name`                 varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT ' 一级部门名称 ',
    `created_project_count`            bigint                                  DEFAULT NULL COMMENT ' 新建状态项目数 ',
    `created_project_amount`           decimal(16, 2)                          DEFAULT NULL COMMENT ' 新建状态项目申请金额 ',
    `risk_control_not_approved_count`  bigint                                  DEFAULT NULL COMMENT ' 未达风控状态项目数 ',
    `risk_control_not_approved_amount` decimal(16, 2)                          DEFAULT NULL COMMENT ' 未达风控状态项目申请金额 ',
    `credit_audit_approved_count`      bigint                                  DEFAULT NULL COMMENT ' 信审经办审核通过状态项目数 ',
    `credit_audit_approved_amount`     decimal(16, 2)                          DEFAULT NULL COMMENT ' 信审经办审核通过状态项目申请金额 ',
    `feedback_submitted_count`         bigint                                  DEFAULT NULL COMMENT ' 已提交业务反馈状态项目数 ',
    `feedback_submitted_amount`        decimal(16, 2)                          DEFAULT NULL COMMENT ' 已提交业务反馈状态项目申请金额 ',
    `level1_review_approved_count`     bigint                                  DEFAULT NULL COMMENT ' 一级评审通过状态项目数 ',
    `level1_review_approved_amount`    decimal(16, 2)                          DEFAULT NULL COMMENT ' 一级评审通过状态项目申请金额 ',
    `level2_review_approved_count`     bigint                                  DEFAULT NULL COMMENT ' 二级评审通过状态项目数 ',
    `level2_review_approved_amount`    decimal(16, 2)                          DEFAULT NULL COMMENT ' 二级评审通过状态项目申请金额 ',
    `review_meeting_approved_count`    bigint                                  DEFAULT NULL COMMENT ' 项目评审会审核通过状态项目数 ',
    `review_meeting_approved_amount`   decimal(16, 2)                          DEFAULT NULL COMMENT ' 项目评审会审核通过状态项目申请金额 ',
    `general_manager_approved_count`   bigint                                  DEFAULT NULL COMMENT ' 总经理/分管总审核通过状态项目数 ',
    `general_manager_approved_amount`  decimal(16, 2)                          DEFAULT NULL COMMENT ' 总经理/分管总审核通过状态项目申请金额 ',
    `reply_issued_count`               bigint                                  DEFAULT NULL COMMENT ' 出具批复状态项目数 ',
    `reply_issued_apply_amount`        decimal(16, 2)                          DEFAULT NULL COMMENT ' 出具批复状态项目申请金额 ',
    `reply_issued_reply_amount`        decimal(16, 2)                          DEFAULT NULL COMMENT ' 出具批复状态项目批复金额 '
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_general_ci COMMENT ='各部门待审/在审项目统计';


DROP TABLE IF EXISTS ads_salesman_unfinished_audit_stats;
CREATE TABLE `ads_salesman_unfinished_audit_stats`
(
    `dt`                               date                                    DEFAULT NULL COMMENT ' 统计日期 ',
    `salesman_id`                      varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT ' 业务经办员工ID ',
    `salesman_name`                    varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT ' 业务经办员工姓名 ',
    `created_project_count`            bigint                                  DEFAULT NULL COMMENT ' 新建状态项目数 ',
    `created_project_amount`           decimal(16, 2)                          DEFAULT NULL COMMENT ' 新建状态项目申请金额 ',
    `risk_control_not_approved_count`  bigint                                  DEFAULT NULL COMMENT ' 未达风控状态项目数 ',
    `risk_control_not_approved_amount` decimal(16, 2)                          DEFAULT NULL COMMENT ' 未达风控状态项目申请金额 ',
    `credit_audit_approved_count`      bigint                                  DEFAULT NULL COMMENT ' 信审经办审核通过状态项目数 ',
    `credit_audit_approved_amount`     decimal(16, 2)                          DEFAULT NULL COMMENT ' 信审经办审核通过状态项目申请金额 ',
    `feedback_submitted_count`         bigint                                  DEFAULT NULL COMMENT ' 已提交业务反馈状态项目数 ',
    `feedback_submitted_amount`        decimal(16, 2)                          DEFAULT NULL COMMENT ' 已提交业务反馈状态项目申请金额 ',
    `level1_review_approved_count`     bigint                                  DEFAULT NULL COMMENT ' 一级评审通过状态项目数 ',
    `level1_review_approved_amount`    decimal(16, 2)                          DEFAULT NULL COMMENT ' 一级评审通过状态项目申请金额 ',
    `level2_review_approved_count`     bigint                                  DEFAULT NULL COMMENT ' 二级评审通过状态项目数 ',
    `level2_review_approved_amount`    decimal(16, 2)                          DEFAULT NULL COMMENT ' 二级评审通过状态项目申请金额 ',
    `review_meeting_approved_count`    bigint                                  DEFAULT NULL COMMENT ' 项目评审会审核通过状态项目数 ',
    `review_meeting_approved_amount`   decimal(16, 2)                          DEFAULT NULL COMMENT ' 项目评审会审核通过状态项目申请金额 ',
    `general_manager_approved_count`   bigint                                  DEFAULT NULL COMMENT ' 总经理/分管总审核通过状态项目数 ',
    `general_manager_approved_amount`  decimal(16, 2)                          DEFAULT NULL COMMENT ' 总经理/分管总审核通过状态项目申请金额 ',
    `reply_issued_count`               bigint                                  DEFAULT NULL COMMENT ' 出具批复状态项目数 ',
    `reply_issued_apply_amount`        decimal(16, 2)                          DEFAULT NULL COMMENT ' 出具批复状态项目申请金额 ',
    `reply_issued_reply_amount`        decimal(16, 2)                          DEFAULT NULL COMMENT ' 出具批复状态项目批复金额 '
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_general_ci COMMENT ='各业务经办待审/在审项目统计';


DROP TABLE IF EXISTS ads_credit_audit_unfinished_audit_stats;
CREATE TABLE `ads_credit_audit_unfinished_audit_stats`
(
    `dt`                              date                                    DEFAULT NULL COMMENT ' 统计日期 ',
    `credit_audit_id`                 varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT ' 信审经办ID ',
    `credit_audit_name`               varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT ' 信审经办姓名 ',
    `credit_audit_approved_count`     bigint                                  DEFAULT NULL COMMENT ' 信审经办审核通过状态项目数 ',
    `credit_audit_approved_amount`    decimal(16, 2)                          DEFAULT NULL COMMENT ' 信审经办审核通过状态项目申请金额 ',
    `feedback_submitted_count`        bigint                                  DEFAULT NULL COMMENT ' 已提交业务反馈状态项目数 ',
    `feedback_submitted_amount`       decimal(16, 2)                          DEFAULT NULL COMMENT ' 已提交业务反馈状态项目申请金额 ',
    `level1_review_approved_count`    bigint                                  DEFAULT NULL COMMENT ' 一级评审通过状态项目数 ',
    `level1_review_approved_amount`   decimal(16, 2)                          DEFAULT NULL COMMENT ' 一级评审通过状态项目申请金额 ',
    `level2_review_approved_count`    bigint                                  DEFAULT NULL COMMENT ' 二级评审通过状态项目数 ',
    `level2_review_approved_amount`   decimal(16, 2)                          DEFAULT NULL COMMENT ' 二级评审通过状态项目申请金额 ',
    `review_meeting_approved_count`   bigint                                  DEFAULT NULL COMMENT ' 项目评审会审核通过状态项目数 ',
    `review_meeting_approved_amount`  decimal(16, 2)                          DEFAULT NULL COMMENT ' 项目评审会审核通过状态项目申请金额 ',
    `general_manager_approved_count`  bigint                                  DEFAULT NULL COMMENT ' 总经理/分管总审核通过状态项目数 ',
    `general_manager_approved_amount` decimal(16, 2)                          DEFAULT NULL COMMENT ' 总经理/分管总审核通过状态项目申请金额 ',
    `reply_issued_count`              bigint                                  DEFAULT NULL COMMENT ' 出具批复状态项目数 ',
    `reply_issued_apply_amount`       decimal(16, 2)                          DEFAULT NULL COMMENT ' 出具批复状态项目申请金额 ',
    `reply_issued_reply_amount`       decimal(16, 2)                          DEFAULT NULL COMMENT ' 出具批复状态项目批复金额 '
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_general_ci COMMENT ='各信审经办待审/在审项目统计';


DROP TABLE IF EXISTS ads_industry_unfinished_audit_stats;
CREATE TABLE `ads_industry_unfinished_audit_stats`
(
    `dt`                               date                                    DEFAULT NULL COMMENT ' 统计日期 ',
    `industry3_id`                     varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT ' 三级行业ID ',
    `industry3_name`                   varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT ' 三级行业名称 ',
    `industry2_id`                     varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT ' 二级行业ID ',
    `industry2_name`                   varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT ' 二级行业名称 ',
    `industry1_id`                     varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT ' 一级行业ID ',
    `industry1_name`                   varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT ' 一级行业名称 ',
    `created_project_count`            bigint                                  DEFAULT NULL COMMENT ' 新建状态项目数 ',
    `created_project_amount`           decimal(16, 2)                          DEFAULT NULL COMMENT ' 新建状态项目申请金额 ',
    `risk_control_not_approved_count`  bigint                                  DEFAULT NULL COMMENT ' 未达风控状态项目数 ',
    `risk_control_not_approved_amount` decimal(16, 2)                          DEFAULT NULL COMMENT ' 未达风控状态项目申请金额 ',
    `credit_audit_approved_count`      bigint                                  DEFAULT NULL COMMENT ' 信审经办审核通过状态项目数 ',
    `credit_audit_approved_amount`     decimal(16, 2)                          DEFAULT NULL COMMENT ' 信审经办审核通过状态项目申请金额 ',
    `feedback_submitted_count`         bigint                                  DEFAULT NULL COMMENT ' 已提交业务反馈状态项目数 ',
    `feedback_submitted_amount`        decimal(16, 2)                          DEFAULT NULL COMMENT ' 已提交业务反馈状态项目申请金额 ',
    `level1_review_approved_count`     bigint                                  DEFAULT NULL COMMENT ' 一级评审通过状态项目数 ',
    `level1_review_approved_amount`    decimal(16, 2)                          DEFAULT NULL COMMENT ' 一级评审通过状态项目申请金额 ',
    `level2_review_approved_count`     bigint                                  DEFAULT NULL COMMENT ' 二级评审通过状态项目数 ',
    `level2_review_approved_amount`    decimal(16, 2)                          DEFAULT NULL COMMENT ' 二级评审通过状态项目申请金额 ',
    `review_meeting_approved_count`    bigint                                  DEFAULT NULL COMMENT ' 项目评审会审核通过状态项目数 ',
    `review_meeting_approved_amount`   decimal(16, 2)                          DEFAULT NULL COMMENT ' 项目评审会审核通过状态项目申请金额 ',
    `general_manager_approved_count`   bigint                                  DEFAULT NULL COMMENT ' 总经理/分管总审核通过状态项目数 ',
    `general_manager_approved_amount`  decimal(16, 2)                          DEFAULT NULL COMMENT ' 总经理/分管总审核通过状态项目申请金额 ',
    `reply_issued_count`               bigint                                  DEFAULT NULL COMMENT ' 出具批复状态项目数 ',
    `reply_issued_apply_amount`        decimal(16, 2)                          DEFAULT NULL COMMENT ' 出具批复状态项目申请金额 ',
    `reply_issued_reply_amount`        decimal(16, 2)                          DEFAULT NULL COMMENT ' 出具批复状态项目批复金额 '
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_general_ci COMMENT ='各行业待审/在审项目统计';


DROP TABLE IF EXISTS ads_finished_audit_stats;
CREATE TABLE `ads_finished_audit_stats`
(
    `dt`                          date           DEFAULT NULL COMMENT ' 统计日期 ',
    `audit_approved_count`        bigint         DEFAULT NULL COMMENT ' 审批通过项目数 ',
    `audit_approved_apply_amount` decimal(16, 2) DEFAULT NULL COMMENT ' 审批通过项目申请金额 ',
    `audit_approved_reply_amount` decimal(16, 2) DEFAULT NULL COMMENT ' 审批通过项目批复金额 ',
    `apply_cancel_count`          bigint         DEFAULT NULL COMMENT ' 取消项目数 ',
    `apply_cancel_apply_amount`   decimal(16, 2) DEFAULT NULL COMMENT ' 取消项目申请金额 ',
    `audit_refused_count`         bigint         DEFAULT NULL COMMENT ' 审批拒绝项目数 ',
    `audit_refused_apply_amount`  decimal(16, 2) DEFAULT NULL COMMENT ' 审批拒绝项目申请金额 '
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_general_ci COMMENT ='已审项目综合统计';


DROP TABLE IF EXISTS ads_lease_org_finished_audit_stats;
CREATE TABLE `ads_lease_org_finished_audit_stats`
(
    `dt`                          date                                    DEFAULT NULL COMMENT ' 统计日期 ',
    `lease_organization`          varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT ' 业务反向 ',
    `audit_approved_count`        bigint                                  DEFAULT NULL COMMENT ' 审批通过项目数 ',
    `audit_approved_apply_amount` decimal(16, 2)                          DEFAULT NULL COMMENT ' 审批通过项目申请金额 ',
    `audit_approved_reply_amount` decimal(16, 2)                          DEFAULT NULL COMMENT ' 审批通过项目批复金额 ',
    `apply_cancel_count`          bigint                                  DEFAULT NULL COMMENT ' 取消项目数 ',
    `apply_cancel_apply_amount`   decimal(16, 2)                          DEFAULT NULL COMMENT ' 取消项目申请金额 ',
    `audit_refused_count`         bigint                                  DEFAULT NULL COMMENT ' 审批拒绝项目数 ',
    `audit_refused_apply_amount`  decimal(16, 2)                          DEFAULT NULL COMMENT ' 审批拒绝项目申请金额 '
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_general_ci COMMENT ='各业务方向已审项目统计';


DROP TABLE IF EXISTS ads_department_finished_audit_stats;
CREATE TABLE `ads_department_finished_audit_stats`
(
    `dt`                          date                                    DEFAULT NULL COMMENT ' 统计日期 ',
    `department3_id`              varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT ' 三级部门ID ',
    `department3_name`            varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT ' 三级部门名称 ',
    `department2_id`              varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT ' 二级部门ID ',
    `department2_name`            varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT ' 二级部门名称 ',
    `department1_id`              varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT ' 一级部门ID ',
    `department1_name`            varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT ' 一级部门名称 ',
    `audit_approved_count`        bigint                                  DEFAULT NULL COMMENT ' 审批通过项目数 ',
    `audit_approved_apply_amount` decimal(16, 2)                          DEFAULT NULL COMMENT ' 审批通过项目申请金额 ',
    `audit_approved_reply_amount` decimal(16, 2)                          DEFAULT NULL COMMENT ' 审批通过项目批复金额 ',
    `apply_cancel_count`          bigint                                  DEFAULT NULL COMMENT ' 取消项目数 ',
    `apply_cancel_apply_amount`   decimal(16, 2)                          DEFAULT NULL COMMENT ' 取消项目申请金额 ',
    `audit_refused_count`         bigint                                  DEFAULT NULL COMMENT ' 审批拒绝项目数 ',
    `audit_refused_apply_amount`  decimal(16, 2)                          DEFAULT NULL COMMENT ' 审批拒绝项目申请金额 '
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_general_ci COMMENT ='各部门已审项目统计';


DROP TABLE IF EXISTS ads_salesman_finished_audit_stats;
CREATE TABLE `ads_salesman_finished_audit_stats`
(
    `dt`                          date                                    DEFAULT NULL COMMENT ' 统计日期 ',
    `salesman_id`                 varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT ' 业务经办ID ',
    `salesman_name`               varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT ' 业务经办姓名 ',
    `audit_approved_count`        bigint                                  DEFAULT NULL COMMENT ' 审批通过项目数 ',
    `audit_approved_apply_amount` decimal(16, 2)                          DEFAULT NULL COMMENT ' 审批通过项目申请金额 ',
    `audit_approved_reply_amount` decimal(16, 2)                          DEFAULT NULL COMMENT ' 审批通过项目批复金额 ',
    `apply_cancel_count`          bigint                                  DEFAULT NULL COMMENT ' 取消项目数 ',
    `apply_cancel_apply_amount`   decimal(16, 2)                          DEFAULT NULL COMMENT ' 取消项目申请金额 ',
    `audit_refused_count`         bigint                                  DEFAULT NULL COMMENT ' 审批拒绝项目数 ',
    `audit_refused_apply_amount`  decimal(16, 2)                          DEFAULT NULL COMMENT ' 审批拒绝项目申请金额 '
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_general_ci COMMENT ='各业务经办已审项目统计';

DROP TABLE IF EXISTS ads_credit_audit_finished_audit_stats;
CREATE TABLE `ads_credit_audit_finished_audit_stats`
(
    `dt`                          date                                    DEFAULT NULL COMMENT ' 统计日期 ',
    `credit_audit_id`             varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT ' 信审经办ID ',
    `credit_audit_name`           varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT ' 信审经办姓名 ',
    `audit_approved_count`        bigint                                  DEFAULT NULL COMMENT ' 审批通过项目数 ',
    `audit_approved_apply_amount` decimal(16, 2)                          DEFAULT NULL COMMENT ' 审批通过项目申请金额 ',
    `audit_approved_reply_amount` decimal(16, 2)                          DEFAULT NULL COMMENT ' 审批通过项目批复金额 ',
    `apply_cancel_count`          bigint                                  DEFAULT NULL COMMENT ' 取消项目数 ',
    `apply_cancel_apply_amount`   decimal(16, 2)                          DEFAULT NULL COMMENT ' 取消项目申请金额 ',
    `audit_refused_count`         bigint                                  DEFAULT NULL COMMENT ' 审批拒绝项目数 ',
    `audit_refused_apply_amount`  decimal(16, 2)                          DEFAULT NULL COMMENT ' 审批拒绝项目申请金额 '
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_general_ci COMMENT ='各信审经办已审项目统计';

DROP TABLE IF EXISTS ads_industry_finished_audit_stats;
CREATE TABLE `ads_industry_finished_audit_stats`
(
    `dt`                          date                                    DEFAULT NULL COMMENT ' 统计日期 ',
    `industry3_id`                varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT ' 三级行业ID ',
    `industry3_name`              varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT ' 三级行业名称 ',
    `industry2_id`                varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT ' 二级行业ID ',
    `industry2_name`              varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT ' 二级行业名称 ',
    `industry1_id`                varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT ' 一级行业ID ',
    `industry1_name`              varchar(255) COLLATE utf8mb4_general_ci DEFAULT NULL COMMENT ' 一级行业名称 ',
    `audit_approved_count`        bigint                                  DEFAULT NULL COMMENT ' 审批通过项目数 ',
    `audit_approved_apply_amount` decimal(16, 2)                          DEFAULT NULL COMMENT ' 审批通过项目申请金额 ',
    `audit_approved_reply_amount` decimal(16, 2)                          DEFAULT NULL COMMENT ' 审批通过项目批复金额 ',
    `apply_cancel_count`          bigint                                  DEFAULT NULL COMMENT ' 取消项目数 ',
    `apply_cancel_apply_amount`   decimal(16, 2)                          DEFAULT NULL COMMENT ' 取消项目申请金额 ',
    `audit_refused_count`         bigint                                  DEFAULT NULL COMMENT ' 审批拒绝项目数 ',
    `audit_refused_apply_amount`  decimal(16, 2)                          DEFAULT NULL COMMENT ' 审批拒绝项目申请金额 '
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_general_ci COMMENT ='各行业已审项目统计';

DROP TABLE IF EXISTS ads_credit_audit_finished_transform_stats;
CREATE TABLE `ads_credit_audit_finished_transform_stats`
(
    `dt`                                 date           DEFAULT NULL COMMENT ' 统计日期 ',
    `credit_audit_finished_count`        bigint         DEFAULT NULL COMMENT ' 审批结束项目数 ',
    `credit_audit_finished_apply_amount` decimal(16, 2) DEFAULT NULL COMMENT ' 审批结束项目申请金额 ',
    `credit_audit_approved_count`        bigint         DEFAULT NULL COMMENT ' 审批通过项目数 ',
    `credit_audit_approved_apply_amount` decimal(16, 2) DEFAULT NULL COMMENT ' 审批通过项目申请金额 ',
    `credit_audit_approved_reply_amount` decimal(16, 2) DEFAULT NULL COMMENT ' 审批通过项目批复金额 ',
    `credit_created_count`               bigint         DEFAULT NULL COMMENT ' 新增授信项目数 ',
    `credit_created_apply_amount`        decimal(16, 2) DEFAULT NULL COMMENT ' 新增授信项目申请金额 ',
    `credit_created_reply_amount`        decimal(16, 2) DEFAULT NULL COMMENT ' 新增授信项目批复金额 ',
    `credit_created_credit_amount`       decimal(16, 2) DEFAULT NULL COMMENT ' 新增授信项目授信金额 ',
    `credit_occupied_count`              bigint         DEFAULT NULL COMMENT ' 完成授信占用项目数 ',
    `credit_occupied_apply_amount`       decimal(16, 2) DEFAULT NULL COMMENT ' 完成授信占用项目申请金额 ',
    `credit_occupied_reply_amount`       decimal(16, 2) DEFAULT NULL COMMENT ' 完成授信占用项目批复金额 ',
    `credit_occupied_credit_amount`      decimal(16, 2) DEFAULT NULL COMMENT ' 完成授信占用项目授信金额 ',
    `contract_produced_count`            bigint         DEFAULT NULL COMMENT ' 完成合同制作项目数 ',
    `contract_produced_apply_amount`     decimal(16, 2) DEFAULT NULL COMMENT ' 完成合同制作项目申请金额 ',
    `contract_produced_reply_amount`     decimal(16, 2) DEFAULT NULL COMMENT ' 完成合同制作项目批复金额 ',
    `contract_produced_credit_amount`    decimal(16, 2) DEFAULT NULL COMMENT ' 完成合同制作项目授信金额 ',
    `credit_signed_count`                bigint         DEFAULT NULL COMMENT ' 签约项目数 ',
    `credit_signed_apply_amount`         decimal(16, 2) DEFAULT NULL COMMENT ' 签约项目申请金额 ',
    `credit_signed_reply_amount`         decimal(16, 2) DEFAULT NULL COMMENT ' 签约项目批复金额 ',
    `credit_signed_credit_amount`        decimal(16, 2) DEFAULT NULL COMMENT ' 签约项目授信金额 ',
    `leased_count`                       bigint         DEFAULT NULL COMMENT ' 起租项目数 ',
    `leased_apply_amount`                decimal(16, 2) DEFAULT NULL COMMENT ' 起租项目申请金额 ',
    `leased_reply_amount`                decimal(16, 2) DEFAULT NULL COMMENT ' 起租项目批复金额 ',
    `leased_credit_amount`               decimal(16, 2) DEFAULT NULL COMMENT ' 起租项目授信金额 '
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_general_ci COMMENT ='已审项目转化情况统计'

```

### 数据导出
首先使用datax配置文件生成脚本来生成配置文件，脚本配置如下：

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1708347250393-3c7b08c2-2133-477a-8d24-90093f765cbc.png)

共生成13个配置文件

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1708347215102-f8c3bb73-17d0-434a-8aac-37aafe7f9c5b.png)

然后编写每日同步脚本：

```bash
#! /bin/bash

DATAX_HOME=/opt/module/datax/
DATAX_DATA=/opt/module/datax/job/financial_lease

#DataX导出路径不允许存在空文件，该函数作用为清理空文件
handle_export_path(){
  for i in `hadoop fs -ls -R $1 | awk '{print $8}'`; do
    hadoop fs -test -z $i
    if [[ $? -eq 0 ]]; then
      echo "$i文件大小为0，正在删除"
      hadoop fs -rm -r -f $i
    fi
  done
}

#数据导出
export_data() {
  export_dir=$1
  datax_config=$2
  echo "正在处理 $2 ......"
  handle_export_path $export_dir
  $DATAX_HOME/bin/datax.py -p"-Dexportdir=$export_dir" $datax_config >/tmp/datax_run.log 2>&1
  if [ $? -ne 0 ]
	then
	  echo "处理失败，日志如下："
	  cat /tmp/datax_run.log
  fi
}

case $1 in
  ads_unfinished_audit_stats | ads_lease_org_unfinished_audit_stats | ads_department_unfinished_audit_stats | ads_salesman_unfinished_audit_stats | ads_credit_audit_unfinished_audit_stats | ads_industry_unfinished_audit_stats | ads_finished_audit_stats | ads_lease_org_finished_audit_stats | ads_department_finished_audit_stats | ads_salesman_finished_audit_stats | ads_credit_audit_finished_audit_stats | ads_industry_finished_audit_stats | ads_credit_audit_finished_transform_stats)
    export_data /warehouse/financial_lease/ads/$1 ${DATAX_DATA}/export/financial_report.$1.json 
  ;;
  
  "all")
    for tab in ads_unfinished_audit_stats ads_lease_org_unfinished_audit_stats ads_department_unfinished_audit_stats ads_salesman_unfinished_audit_stats ads_credit_audit_unfinished_audit_stats ads_industry_unfinished_audit_stats ads_finished_audit_stats ads_lease_org_finished_audit_stats ads_department_finished_audit_stats ads_salesman_finished_audit_stats ads_credit_audit_finished_audit_stats ads_industry_finished_audit_stats ads_credit_audit_finished_transform_stats
    do 
      export_data  /warehouse/financial_lease/ads/${tab} ${DATAX_DATA}/export/financial_report.${tab}.json
    done
    ;;
esac
```

然后执行脚本即可

# 10.调度
1.启动相关组件：

1. 启动hadoop集群
2. 启动kafka
3. 启动zookeeper
4. 启动Flume采集数据通道
5. 启动Maxwell

然后执行日志生成脚本，查看数据生成是否正常（此时增量同步的操作已经完成）



2.准备脚本文件：

1. `financial_mysql_to_hdfs_full.sh`：DataX全量同步数据的脚本文件（增量同步通过Maxwell——Kafka——Flume来完成，无需执行脚本）
2. `financial_hdfs_to_ods.sh`：将hdfs中存储的数据load到hive表中
3. `financial_ods_to_dim.sh`：更新dim表中的内容
4. `financial_ods_to_dwd.sh`：更新dwd表中的内容
5. `financial_dwd_to_ads.sh`：更新ads表中的内容
6. `financial_hdfs_to_mysql.sh`：将ads表中的数据从hdfs中读出来，写到mysql中去

其余脚本文件无需再次执行，如`financial_mysql_to_kafka_inc_init.sh`是增量表的首日全量同步，执行一次即可；`financial_ods_to_dwd_init.sh`是dwd层表的初始化操作，dwd层通过累积型快照事实表进行审批流程状态的存储，在初始化时需要对以往的所有数据进行汇总，后续无需执行初始化操作

准备完成后将脚本文件上传到DolphinScheduler中：

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1724920259934-5a2596c3-3379-4624-9875-869283435bd6.png)



3.分发脚本依赖的组件：

由于工作流要执行的脚本需要调用Hive、DataX、Spark等组件，故在DolphinScheduler的集群模式下，需要确保每个WorkerServer节点都有脚本所依赖的组件



4.配置DolphinScheduler的环境（需要切换到admin用户）

环境变量如下：

```bash
export HADOOP_HOME=/opt/module/hadoop-3.3.4
export HADOOP_CONF_DIR=/opt/module/hadoop-3.3.4/etc/hadoop
export SPARK_HOME=/opt/module/spark-3.3.1
export JAVA_HOME=/opt/module/jdk1.8
export HIVE_HOME=/opt/module/hive-3.1.3
export DATAX_HOME=/opt/module/datax

export PATH=$PATH:$HADOOP_HOME/bin:$SPARK_HOME/bin:$JAVA_HOME/bin:$HIVE_HOME/bin:$DATAX_HOME/bin
```



5.创建工作流（切换回普通用户）：

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1724935957164-d8cabcdd-23c3-49c1-aa6c-eb98a8c35b8e.png)

分别给各个任务节点配置需要执行的脚本，然后按顺序执行即可；

执行结果如下：

![](https://cdn.nlark.com/yuque/0/2024/png/2675852/1724936265627-bd72292b-1b7f-45ce-968b-a0efc8c25f4a.png)

# 11.可视化(superset)
启动superset：`gunicorn --workers 5 --timeout 120 --bind hadoop108:8787  "superset.app:create_app()" --daemon `

停止superset：`ps -ef | awk '/superset/ && !/awk/{print $2}' | xargs kill -9`



# 12.整体开发流程详细说明
在对上面所述开发流程有了整体了解之后，下面说明如何从零开始完成数仓的搭建工作

假设数仓上线时间为`2023-05-09`，则之前的数据需要手动导入数仓，之后的数据通过定时任务同步及Kafka增量同步即可

## 12.1 模拟数据准备
### 12.1.1 清理历史测试数据
1. 将`/origin_data`路径下之前的数据删除，防止之前的测试产生数据带来的影响
2. 停止Maxwell采集通道并重建业务数据库（MySQL）（清空原先业务数据库中的内容）

`drop database financial_lease`

`create database financial_lease default charset utf8mb4 collate utf8mb4_general_ci`

3. 清除Maxwell的断点记录，清空Maxwell数据库中所有表即可
4. 重新创建hive中`financial_lease`数据库中ods/dim/dwd/ads各层的表
5. 删除`/warehouse/financial_lease`下ods/dim/dwd/ads这四个目录（说明：这四个目录是数仓各层历史数据物理存储的位置，在重新建表时会删除元数据中对于分区信息的记录，但不会删除物理存储的数据，如果不删除历史数据的话，对于未分区的表来说（如ads层的表），会自动将历史数据映射到表中，导致历史数据对当前测试结果造成影响）
6. 重新创建MySQL中`financial_report`数据库的表

### 12.1.2 模拟数据生成
依次向业务数据库中生成2023-5-1—2023-5-9的数据：

+ 首先修改`/opt/module/financial_mock_app/application.yml`，将起始日期修改为2023-05-01
+ 然后执行模拟数据生成脚本即可：`financial_mock.sh 9`

## 12.2 历史数据全量同步
1. 全量表同步（datax）：`financial_mysql_to_hdfs_full.sh all 2023-05-09`（同步所有表，2023-05-09当天的数据，包括05-01到05-09的所有数据）
2. 增量表首日全量同步（Maxwell的bootstrap功能），将05-01到05-09的数据全部同步过来：
+ 修改Maxwell配置文件中的mock_date参数为2023-05-09
+ 执行增量表首日全量同步脚本：`financial_mysql_to_kafka_inc_init.sh all`

## 12.3 数仓构建
1. 将hdfs中的业务数据导入到ods层中：`financial_hdfs_to_ods.sh all 2023-05-09`
2. 利用ods层的数据构建dim层：`financial_ods_to_dim.sh all 2023-05-09`
3. 利用ods层的数据构建dwd层：
+ 处理历史数据：`financial_ods_to_dwd_init.sh all 2023-05-09`，这里是对05-01到05-09的数据进行处理，分析各天的金融租赁业务状态
+ 处理当天数据：`financial_ods_to_dwd.sh all 2023-05-09`，对于当天新增的数据进行处理
+ 说明：init操作只需在数仓上线当天进行即可，之后都是执行每日数据同步
4. 利用dwd层数据构建ads层：`financial_dwd_to_ads.sh all 2023-05-09`

## 12.4 数据导出
将ods层的数据全量同步到MySQL数据库中：`financial_hdfs_to_mysql.sh all` 



## 12.5 测试任务调度
1. 生成模拟数据（2023-05-10）【说明：由于数据在业务逻辑中是由业务过程生成的，这里进行简单的模拟生成，因此这一步操作不适合放入任务调度中】
2. 修改maxwell中的`mock_date`
3. 在dolphinScheduler中工作流下线，修改全局任务所需参数dt为`2023-05-10`，然后重新上线
4. 运行工作流，执行任务

